import{a as W}from"./chunk-ZGEJ7KGT.mjs";import{TypedEmitter as Za}from"tiny-typed-emitter";function v(t,e){let o={};return o.points=t.u16(),o.id=t.u32(),o.level=t.u8(),o}function R(t,e){t.u16(e.points),t.u32(e.id),t.u8(e.level)}function Q(t,e){let o={};return o.abilityDataList=t.array(t.u16(),()=>v(t,e)),o}function J(t,e){t.array(e.abilityDataList,{lenType:"u16"},o=>{R(t,o)})}var X="AbilityChangeNotify";function Bi(t,e){let o={};return o.featureType=t.u16(),o.level=t.u32(),o}function Fi(t,e){t.u16(e.featureType),t.u32(e.level)}function tt(t,e){let o={};return o.activeAbilityList=t.array(t.u16(),()=>Bi(t,e)),o.objectId=t.u64(),o}function et(t,e){t.array(e.activeAbilityList,{lenType:"u16"},o=>{Fi(t,o)}),t.u64(e.objectId)}var ot="ActiveAbilityNotify";function it(t,e){let o={};return o.objectId=t.u64(),o.addonSkillFeatureList=t.array(t.u16(),()=>{let i={};return i.addonSkillFeatureIdList=t.array(t.u16(),()=>t.u32()),i.skillId=t.u32(),i}),o}function at(t,e){t.u64(e.objectId),t.array(e.addonSkillFeatureList,{lenType:"u16"},o=>{t.array(o.addonSkillFeatureIdList,{lenType:"u16"},i=>{t.u32(i)}),t.u32(o.skillId)})}var nt="AddonSkillFeatureChangeNotify";function rt(t,e){let o={};return o.paralyzationMaxPoint=t.u32(),o.type=t.u8(),o.objectId=t.u64(),o.paralyzationPoint=t.u32(),o}function st(t,e){t.u32(e.paralyzationMaxPoint),t.u8(e.type),t.u64(e.objectId),t.u32(e.paralyzationPoint)}var ut="BlockSkillStateNotify";function ft(t,e){let o={};return o.sourceId=t.u64(),o.targetId=t.u64(),o.type=t.u32(),o}function mt(t,e){t.u64(e.sourceId),t.u64(e.targetId),t.u32(e.type)}var pt="CounterAttackNotify";function ct(t,e){let o={};return o.sourceId=t.u64(),o.targetId=t.u64(),e>=4?(o.effectId=t.u32(),o.directionYaw=t.u16(),o.deathType=t.u8(),o.durabilityDecrement=t.u8(),o.abnormalStatusType=t.u8(),o.damageAttr=t.u8(),o.unk0_m=t.u64(),o.unk2_m=t.u32()):(o.effectId=0,o.directionYaw=0,o.deathType=0,o.durabilityDecrement=0,o.abnormalStatusType=0,o.damageAttr=0,o.unk0_m=0n,o.unk2_m=0),o}function lt(t,e){t.u64(e.sourceId),t.u64(e.targetId),t.u32(e.effectId),t.u16(e.directionYaw),t.u8(e.deathType??0),t.u8(e.durabilityDecrement),t.u8(e.abnormalStatusType??0),t.u8(e.damageAttr??0),t.u64(e.unk0_m),t.u32(e.unk2_m)}var yt="DeathNotify";function dt(t,e){let o={};return o.abilityDataList=t.array(t.u16(),()=>v(t,e)),o}function bt(t,e){t.array(e.abilityDataList,{lenType:"u16"},o=>{R(t,o)})}var St="InitAbility";function gt(t,e){let o={};return o.playerId=t.u64(),o}function xt(t,e){t.u64(e.playerId)}var Nt="InitEnv";var xa=[0,31,28,31,30,31,30,31,31,30,31,30,31];function Na(t){return!(t%4||!(t%100)&&t%400)}function Ia(t,e,o){if(t>99){if(t<1752||t==1752&&(e<9||e==9&&o<<14))return!1}else t+=1900;return o>0&&e<=12&&(o<=xa[e]||o==29&&e==2&&Na(t))}function It(t){let e=Number(t&0xffffffffn),o=Number(t>>32n&0xffffffffn),i=e&4095,a=(e&65535)>>12,r=e>>16&31;Ia(i,a,r)||(i=a=r=0);let n=e>>21&31,f=e>>26&63,s=o&63,c=o>>6&16383;return n<24&&f<60&&s<60&&c<1e3||(n=24,f=s=c=0),new Date(Date.UTC(i<=99?i+1900:i,a-1,r,n,f,s,c))}function Mi(t){let e=0n;return e|=BigInt(t.getUTCMilliseconds())<<38n,e|=BigInt(t.getUTCSeconds())<<32n,e|=BigInt(t.getUTCMinutes())<<26n,e|=BigInt(t.getUTCHours())<<21n,e|=BigInt(t.getUTCDate())<<16n,e|=BigInt(t.getUTCMonth()+1)<<12n,e|=BigInt(t.getUTCFullYear()<2e3?t.getUTCFullYear()-1900:t.getUTCFullYear()),e}function x(t,e=0){let o=t.u16();return(o&4095)<2079?(t.o-=2,It(t.i64())):It(BigInt(o)&0xfffn|0x11000n)}function N(t,e=It(0x1181fn)){e.getUTCFullYear()>=2079?t.u16(Number(Mi(e)&0xffffn)):t.i64(Mi(e))}function d(t,e){let o={};return o.skillLevel=t.u8(),o.occurTime=x(t,e),o.statusEffectId=t.u32(),o.sourceId=t.u64(),o.totalTime=t.f32(),o.endTick=t.u64(),t.bool()&&(o.value=t.bytes(16)),o.effectInstanceId=t.u32(),e>=1?o.stackCount=t.u8():o.stackCount=1,o}function b(t,e){t.u8(e.skillLevel),N(t,e.occurTime),t.u32(e.statusEffectId),t.u64(e.sourceId),t.f32(e.totalTime),t.u64(e.endTick),t.bool(e.value!==void 0)&&t.bytes(e.value,{length:16}),t.u32(e.effectInstanceId),t.u8(e.stackCount)}function Ea(t){if(t.length===0)return 0n;if(t.length>8)throw new Error("Value is too large");let e=Buffer.alloc(8);return t.copy(e),e.readBigInt64LE()}function m(t,e=0){let o=t.u8(),i=t.bytes(o>>1&7),a=Ea(i)<<4n|BigInt(o>>4);return o&1?-a:a}function p(t,e=0n){let o=Buffer.alloc(8),i=e<0n;o.writeBigInt64LE((i?-e:e)>>4n);let a=0;for(let[r,n]of o.entries())n!=0&&(a=r+1);if(a>7)throw new Error("Value is too large");t.u8(Number((i?-e:e)&0xfn)<<4|(a&7)<<1|(i?1:0)),t.bytes(o.subarray(0,a),{length:a})}function ht(t,e){let o={};return o.statPair=t.array(t.u16(),()=>{let i={};return i.StatType=t.u8(),i.Value=m(t,e),i}),o.name=t.string(),o.level=t.u16(),o.statusEffectDatas=t.array(t.u16(),()=>d(t,e)),o.characterId=t.u64(),o.gearLevel=t.f32(),o.playerId=t.u64(),o.classId=t.u16(),o}function Dt(t,e){t.array(e.statPair,{lenType:"u16"},o=>{t.u8(o.statType),p(t,o.value)}),t.string(e.name),t.u16(e.level),t.array(e.statusEffectDatas,{lenType:"u16"},o=>{b(t,o)}),t.u64(e.characterId),t.f32(e.gearLevel),t.u64(e.playerId),t.u16(e.classId)}var Ct="InitPC";function vt(t,e){let o={};return o.statPair=t.array(t.u16(),()=>{let i={};return i.statType=t.u8(),i.value=m(t,e),i}),o.statusEffectDatas=t.array(t.u16(),()=>d(t,e)),o.addonSkillFeatureList=t.array(t.u16(),()=>{let i={};return i.addonSkillFeatureIdList=t.array(t.u16(),()=>t.u32()),i.skillId=t.u32(),i}),o.abilityDataList=t.array(t.u16(),()=>v(t,e)),o}function Rt(t,e){t.array(e.statPair,{lenType:"u16"},o=>{t.u8(o.statType),p(t,o.value)}),t.array(e.statusEffectDatas,{lenType:"u16"},o=>{b(t,o)}),t.array(e.addonSkillFeatureList,{lenType:"u16"},o=>{t.array(o.addonSkillFeatureIdList,{lenType:"u16"},i=>{t.u32(i)}),t.u32(o.skillId)}),t.array(e.abilityDataList,{lenType:"u16"},o=>{R(t,o)})}var Tt="InitLocal";function kt(t,e){let o={};return o.account_CharacterId1=t.u64(),o.serverAddr=t.string(),o.account_CharacterId2=t.u64(),o}function Lt(t,e){t.u64(e.account_CharacterId1),t.string(e.serverAddr),t.u64(e.account_CharacterId2)}var At="MigrationExecute";function Pt(t){return t>>20===1?-((~t>>>0)+1&2097151):t}function l(t,e=0){let o=t.u64();return{x:Pt(Number(o&0x1fffffn)),y:Pt(Number(o>>21n&0x1fffffn)),z:Pt(Number(o>>42n&0x1fffffn))}}function y(t,e={x:0,y:0,z:0}){t.u64(BigInt(Math.round(e.x??0)>>>0&2097151)|BigInt(Math.round(e.y??0)>>>0&2097151)<<21n|BigInt(Math.round(e.z??0)>>>0&2097151)<<42n)}function S(t,e=0){return t.u16()*(2*Math.PI)/65536}function g(t,e=0){t.u16(Math.round(e*65536/(2*Math.PI))%65536)}function B(t,e){let o={};return o.spawnIndex=t.u32(),o.objectId=t.u64(),t.bool()&&(o.transitIndex=t.u32()),o.position=l(t,e),o.statusEffectDatas=t.array(t.u16(),()=>d(t,e)),o.directionYaw=S(t,e),o.statPair=t.array(t.u16(),()=>{let i={};return i.statType=t.u8(),i.value=m(t,e),i}),o.typeId=t.u32(),e>=1?(o.level=t.u16(),t.bool()&&(o.balanceLevel=t.u16())):o.level=0,o}function F(t,e){t.u32(e.spawnIndex),t.u64(e.objectId),t.bool(e.transitIndex!==void 0)&&t.u32(e.transitIndex),y(t,e.position),t.array(e.statusEffectDatas,{lenType:"u16"},o=>{b(t,o)}),g(t,e.directionYaw),t.array(e.statPair,{lenType:"u16"},o=>{t.u8(o.statType),p(t,o.value)}),t.u32(e.typeId),t.u16(e.level),t.bool(e.balanceLevel!==void 0)&&t.u16(e.balanceLevel)}function _t(t,e){let o={};return o.npcStruct=B(t,e),o}function Wt(t,e){F(t,e.npcStruct)}var wt="NewNpc";function Bt(t,e){let o={};return o.publishReason=t.u8(),o.ownerId=t.u64(),o.npcData=B(t,e),o}function Ft(t,e){t.u8(e.publishReason),t.u64(e.ownerId),F(t,e.npcData)}var Mt="NewNpcSummon";function D(t,e){let o={};return o.slot=t.u16(),o.level=t.u16(),o.itemTint=t.bytes(t.u16(),0,14),o.expireTime=x(t),o.id=t.u32(),o}function C(t,e){t.u16(e.slot),t.u16(e.level),t.bytes(e.itemTint,{maxLen:0,lenType:"u16",multiplier:14}),N(t,e.expireTime),t.u32(e.id)}function ji(t,e){let o={};return o.maxItemLevel=t.f32(),o.statPair=t.array(t.u16(),()=>{let i={};return i.statType=t.u8(),i.value=m(t,e),i}),o.name=t.string(),o.heading=S(t,e),o.characterId=t.u64(),o.playerId=t.u64(),o.addonSkillFeatureList=t.array(t.u16(),()=>{let i={};return i.addonSkillFeatureIdList=t.array(t.u16(),()=>t.u32()),i.skillId=t.u32(),i}),o.classId=t.u16(),o.level=t.u16(),o.statusEffectDatas=t.array(t.u16(),()=>d(t,e)),e>=1?(o.avgItemLevel=t.f32(),o.position=l(t),o.equipItemDataList=t.array(t.u16(),()=>D(t,e)),o.equipLifeToolDataList=t.array(t.u16(),()=>D(t,e)),o.guildName=t.string(),e>=2?o.guildId=t.u64():o.guildId=BigInt(t.u32())):(o.avgItemLevel=o.maxItemLevel,o.position={x:0,y:0,z:0},o.equipItemDataList=[],o.equipLifeToolDataList=[],o.guildName="",o.guildId=0n),o}function Ui(t,e){t.f32(e.maxItemLevel),t.array(e.statPair,{lenType:"u16"},o=>{t.u8(o.statType),p(t,o.value)}),t.string(e.name),g(t,e.heading),t.u64(e.characterId),t.u64(e.playerId),t.array(e.addonSkillFeatureList,{lenType:"u16"},o=>{t.array(o.addonSkillFeatureIdList,{lenType:"u16"},i=>{t.u32(i)}),t.u32(o.skillId)}),t.u16(e.classId),t.u16(e.level),t.array(e.statusEffectDatas,{lenType:"u16"},o=>{b(t,o)}),t.f32(e.avgItemLevel),y(t,e.position),t.array(e.equipItemDataList,{lenType:"u16"},o=>{C(t,o)}),t.array(e.equipLifeToolDataList,{lenType:"u16"},o=>{C(t,o)}),t.string(e.guildName),t.u64(e.guildId)}function jt(t,e){let o={};return o.pcStruct=ji(t,e),o}function Ut(t,e){Ui(t,e.pcStruct)}var Zt="NewPC";function M(t,e=0){return{first:t.u8(),second:t.u8(),third:t.u8()}}function O(t,e){t.u8(e.first),t.u8(e.second),t.u8(e.third)}function j(t,e=0){return{first:t.u16(),second:t.u16(),third:t.u16()}}function U(t,e){t.u16(e.first),t.u16(e.second),t.u16(e.third)}function zi(t,e){let o={};return o.tripodIndex=M(t,e),o.chainSkillEffect=t.u32(),o.skillEffect=t.u32(),o.skillId=t.u32(),o.targetObjectId=t.u64(),o.ownerId=t.u64(),o.skillLevel=t.u8(),o.projectileId=t.u64(),o.tripodLevel=j(t,e),o}function Vi(t,e){O(t,e.tripodIndex),t.u32(e.chainSkillEffect),t.u32(e.skillEffect),t.u32(e.skillId),t.u64(e.targetObjectId),t.u64(e.ownerId),t.u8(e.skillLevel),t.u64(e.projectileId),U(t,e.tripodLevel)}function qt(t,e){let o={};return o.projectileInfo=zi(t,e),o}function zt(t,e){Vi(t,e.projectileInfo)}var Vt="NewProjectile";function Ht(t,e){let o={};return o.enable=t.bool(),o.paralyzationPoint=t.u32(),o.decreasePoint=t.u32(),o.paralyzationMaxPoint=t.u32(),o.noHitCheckTime=t.u32(),o.hitCheckTime=t.u32(),o.objectId=t.u64(),o}function Gt(t,e){t.bool(e.enable),t.u32(e.paralyzationPoint),t.u32(e.decreasePoint),t.u32(e.paralyzationMaxPoint),t.u32(e.noHitCheckTime),t.u32(e.hitCheckTime),t.u64(e.objectId)}var Kt="ParalyzationStateNotify";function Hi(t,e){let o={};return o.maxHp=m(t,e),o.characterId=t.u64(),o.position=l(t,e),o.transitIndex=t.u32(),o.curHp=m(t,e),o.characterLevel=t.u16(),o.gearLevel=t.f32(),o.zoneId=t.u32(),o.partyMemberNumber=t.u8(),o.name=t.string(),o.zoneInstId=t.u64(),o.worldId=t.u8(),o.classId=t.u16(),o.auths=t.u8(),o}function Gi(t,e){p(t,e.maxHp),t.u64(e.characterId),y(t,e.position),t.u32(e.transitIndex),p(t,e.curHp),t.u16(e.characterLevel),t.f32(e.gearLevel),t.u32(e.zoneId),t.u8(e.partyMemberNumber),t.string(e.name),t.u64(e.zoneInstId),t.u8(e.worldId),t.u16(e.classId),t.u8(e.auths)}function Yt(t,e){let o={};return o.raidInstanceId=t.u32(),o.lootGrade=t.u32(),o.partyType=t.u8(),o.partyInstanceId=t.u32(),o.partyLootType=t.u8(),o.memberDatas=t.array(t.u16(),()=>Hi(t,e)),o}function $t(t,e){t.u32(e.raidInstanceId),t.u32(e.lootGrade),t.u8(e.partyType),t.u32(e.partyInstanceId),t.u8(e.partyLootType),t.array(e.memberDatas,{lenType:"u16"},o=>{Gi(t,o)})}var Qt="PartyInfo";function Jt(t,e){let o={};return o.partyLeaveType=t.u8(),o.partyInstanceId=t.u32(),o.name=t.string(),o}function Xt(t,e){t.u8(e.partyLeaveType),t.u32(e.partyInstanceId),t.string(e.name)}var te="PartyLeaveResult";function ee(t,e){let o={};return o.objectId=t.u64(),o.passiveStatusEffectList=t.array(t.u16(),()=>t.u32()),o.unk0_m=t.u8(),o}function oe(t,e){t.u64(e.objectId),t.array(e.passiveStatusEffectList,{lenType:"u16"},o=>{t.u32(o)}),t.u8(e.unk0_m)}var ie="PartyPassiveStatusEffectAddNotify";function ae(t,e){let o={};return o.objectId=t.u64(),o.passiveStatusEffectList=t.array(t.u16(),()=>t.u32()),o}function ne(t,e){t.u64(e.objectId),t.array(e.passiveStatusEffectList,{lenType:"u16"},o=>{t.u32(o)})}var re="PartyPassiveStatusEffectRemoveNotify";function se(t,e){let o={};return o.characterId=t.u64(),o.statusEffectDatas=t.array(t.u16(),()=>d(t,e)),o.playerIdOnRefresh=t.u64(),o}function ue(t,e){t.u64(e.characterId),t.array(e.statusEffectDatas,{lenType:"u16"},o=>{b(t,o)}),t.u64(e.playerIdOnRefresh)}var fe="PartyStatusEffectAddNotify";function me(t,e){let o={};return o.characterId=t.u64(),o.statusEffectIds=t.array(t.u16(),()=>t.u32()),o.reason=t.u8(),o}function pe(t,e){t.u64(e.characterId),t.array(e.statusEffectIds,{lenType:"u16"},o=>{t.u32(o)}),t.u8(e.reason)}var ce="PartyStatusEffectRemoveNotify";function le(t,e){let o={};return o.partyInstanceId=t.u32(),o.raidInstanceId=t.u32(),o.characterId=t.u64(),o}function ye(t,e){t.u32(e.partyInstanceId),t.u32(e.raidInstanceId),t.u64(e.characterId)}var de="PartyStatusEffectResultNotify";function be(t,e){let o={};return o.passiveStatusEffectList=t.array(t.u16(),()=>t.u32()),o}function Se(t,e){t.array(e.passiveStatusEffectList,{lenType:"u16"},o=>{t.u32(o)})}var ge="PassiveStatusEffectAddNotify";function xe(t,e){let o={};return o.passiveStatusEffectList=t.array(t.u16(),()=>t.u32()),o}function Ne(t,e){t.array(e.passiveStatusEffectList,{lenType:"u16"},o=>{t.u32(o)})}var Ie="PassiveStatusEffectRemoveNotify";function Ee(t,e){let o={};return e>=4?o.typeId=t.u32():o.typeId=0,o}function he(t,e){t.u32(e.typeId)}var De="RaidBossKillNotify";function Ce(t,e){let o={};return e>=3?o.raidResult=t.u8():o.raidResult=0,o}function ve(t,e){t.u8(e.raidResult)}var Re="RaidResult";function Ki(t,e){let o={};return o.unpublishReason=t.u8(),o.objectId=t.u64(),o}function Yi(t,e){t.u8(e.unpublishReason),t.u64(e.objectId)}function Te(t,e){let o={};return o.unpublishedObjects=t.array(t.u16(),()=>Ki(t,e)),o}function ke(t,e){t.array(e.unpublishedObjects,{lenType:"u16"},o=>{Yi(t,o)})}var Le="RemoveObject";function $i(t,e=0){let o={},i=t.u8();return i&1&&(o.moveTime=t.u32()),i&2&&(o.standUpTime=t.u32()),i&4&&(o.downTime=t.u32()),i&8&&(o.freezeTime=t.u32()),i&16&&(o.moveHeight=t.u32()),i&32&&(o.farmostDist=t.u32()),i&64&&(o.flag40=t.bytes(t.u16(),6)),o}function Qi(t,e){let o=(e.moveTime===void 0?0:1)|(e.standUpTime===void 0?0:2)|(e.downTime===void 0?0:4)|(e.freezeTime===void 0?0:8)|(e.moveHeight===void 0?0:16)|(e.farmostDist===void 0?0:32)|(e.flag40===void 0?0:64);t.u8(o),o&1&&t.u32(e.moveTime),o&2&&t.u32(e.standUpTime),o&4&&t.u32(e.downTime),o&8&&t.u32(e.freezeTime),o&16&&t.u32(e.moveHeight),o&32&&t.u32(e.farmostDist),o&64&&t.bytes(e.flag40,{maxLen:6,lenType:"u16"})}function Z(t,e){let o={};return o.modifier=t.u8(),o.targetId=t.u64(),o.damageType=t.u8(),t.bool()&&(o.damageAttr=t.u8()),o.curHp=m(t,e),o.unk3_m=t.u16(),o.maxHp=m(t,e),o.damage=m(t,e),o}function q(t,e){t.u8(e.modifier),t.u64(e.targetId),t.u8(e.damageType),t.bool(e.damageAttr!==void 0)&&t.u8(e.damageAttr),p(t,e.curHp),t.u16(e.unk3_m),p(t,e.maxHp),p(t,e.damage)}function Xi(t,e){let o={};return o.skillMoveOptionData=$i(t,e),o.destination=l(t,e),o.position=l(t,e),o.skillDamageEvent=Z(t,e),o}function ta(t,e){Qi(t,e.skillMoveOptionData),y(t,e.destination),y(t,e.position),q(t,e.skillDamageEvent)}function Ae(t,e){let o={};return o.skillId=t.u32(),o.skillDamageAbnormalMoveEvents=t.array(t.u16(),()=>Xi(t,e)),o.skillEffectId=t.u32(),o.sourceId=t.u64(),o}function Pe(t,e){t.u32(e.skillId),t.array(e.skillDamageAbnormalMoveEvents,{lenType:"u16"},o=>{ta(t,o)}),t.u32(e.skillEffectId),t.u64(e.sourceId)}var _e="SkillDamageAbnormalMoveNotify";function We(t,e){let o={};return o.skillLevel=t.u8(),o.sourceId=t.u64(),o.skillId=t.u32(),o.skillDamageEvents=t.array(t.u16(),()=>Z(t,e)),o.skillEffectId=t.u32(),o}function we(t,e){t.u8(e.skillLevel),t.u64(e.sourceId),t.u32(e.skillId),t.array(e.skillDamageEvents,{lenType:"u16"},o=>{q(t,o)}),t.u32(e.skillEffectId??0)}var Be="SkillDamageNotify";function Fe(t,e){let o={};return o.sourceId=t.u64(),o.skillId=t.u32(),o.stage=t.u8(),o}function Me(t,e){t.u64(e.sourceId),t.u32(e.skillId),t.u8(e.stage)}var Oe="SkillStageNotify";function ea(t,e=0){let o={},i=t.u8();return i&1&&(o.layerIndex=t.u8()),i&2&&(o.startStageIndex=t.u8()),i&4&&(o.transitIndex=t.u32()),i&8&&(o.stageStartTime=t.u32()),i&16&&(o.farmostDistance=t.u32()),i&32&&(o.tripodIndex=M(t)),i&64&&(o.tripodLevel=j(t)),o}function oa(t,e){let o=(e.layerIndex===void 0?0:1)|(e.startStageIndex===void 0?0:2)|(e.transitIndex===void 0?0:4)|(e.stageStartTime===void 0?0:8)|(e.farmostDistance===void 0?0:16)|(e.tripodIndex===void 0?0:32)|(e.tripodLevel===void 0?0:64);t.u8(o),o&1&&t.u8(e.layerIndex),o&2&&t.u8(e.startStageIndex),o&4&&t.u32(e.transitIndex),o&8&&t.u32(e.stageStartTime),o&16&&t.u32(e.farmostDistance),o&32&&O(t,e.tripodIndex),o&64&&U(t,e.tripodLevel)}function je(t,e){let o={};return o.sourceId=t.u64(),o.curDirectionYaw=S(t,e),o.newDirectionYaw=S(t,e),o.aimTargetPosition=l(t,e),t.bool()&&(o.pitchRotation=S(t,e)),t.bool()&&(o.aiStateId=t.u32()),o.curPosition=l(t,e),t.bool()&&(o.unk1_m=t.u32()),o.skillLevel=t.u8(),o.newPosition=l(t,e),o.skillId=t.u32(),o.skillOptionData=ea(t,e),o}function Ue(t,e){t.u64(e.sourceId),g(t,e.curDirectionYaw),g(t,e.newDirectionYaw),y(t,e.aimTargetPosition),t.bool(e.pitchRotation!==void 0)&&g(t,e.pitchRotation),t.bool(e.aiStateId!==void 0)&&t.u32(e.aiStateId),y(t,e.curPosition),t.bool(e.unk1_m!==void 0)&&t.u32(e.unk1_m),t.u8(e.skillLevel),y(t,e.newPosition),t.u32(e.skillId),oa(t,e.skillOptionData)}var Ze="SkillStartNotify";function qe(t,e){let o={};return o.statusEffectData=d(t,e),o.objectId=t.u64(),o.new=t.bool(),o}function ze(t,e){b(t,e.statusEffectData),t.u64(e.objectId),t.bool(e.new)}var Ve="StatusEffectAddNotify";function He(t,e){let o={};return o.statusEffectIds=t.array(t.u16(),()=>t.u32()),o.objectId=t.u64(),o.reason=t.u8(),o}function Ge(t,e){t.array(e.statusEffectIds,{lenType:"u16"},o=>{t.u32(o)}),t.u64(e.objectId),t.u8(e.reason)}var Ke="StatusEffectRemoveNotify";function Ye(t,e){let o={};return o.effectInstanceId=t.u32(),o.targetId=t.u64(),o.expirationTick=t.u64(),o}function $e(t,e){t.u32(e.effectInstanceId),t.u64(e.targetId),t.u64(e.expirationTick)}var Qe="StatusEffectDurationNotify";function Je(t,e){let o={};return o.objectId=t.u64(),o.effectInstanceId=t.u32(),o.characterId=t.u64(),o.value=t.u32(),o}function Xe(t,e){t.u64(e.objectId),t.u32(e.effectInstanceId),t.u64(e.characterId),t.u32(e.value)}var to="StatusEffectSyncDataNotify";function eo(t,e){let o={};return o.step=t.u32(),o.unk2_m=t.bool(),o.triggerId=t.u32(),o}function oo(t,e){t.u32(e.step),t.bool(e.unk2_m),t.u32(e.triggerId)}var io="TriggerBossBattleStatus";function ao(t,e){let o={};return o.packetResultCode=t.u32(),o.triggerId=t.u32(),o.unk0_m=t.u32(),o.involvedPCs=t.array(t.u16(),()=>t.u64()),o}function no(t,e){t.u32(e.packetResultCode),t.u32(e.triggerId),t.u32(e.unk0_m),t.array(e.involvedPCs,{lenType:"u16"},o=>{t.u64(o)})}var ro="TriggerFinishNotify";function so(t,e){let o={};return o.triggerId=t.u32(),o.triggerSignalType=t.u32(),o.sourceId=t.u64(),o.involvedPCs=t.array(t.u16(),()=>t.u64()),o}function uo(t,e){t.u32(e.triggerId),t.u32(e.triggerSignalType),t.u64(e.sourceId),t.array(e.involvedPCs,{lenType:"u16"},o=>{t.u64(o)})}var fo="TriggerStartNotify";function mo(t,e){let o={};return o.maxHp=m(t,e),o.characterId=t.u64(),o.unk0_m=t.u32(),o.statusEffectDatas=t.array(t.u16(),()=>d(t,e)),o.position=t.u64(),o.curHp=m(t,e),o}function po(t,e){p(t,e.maxHp),t.u64(e.characterId),t.u32(e.unk0_m),t.array(e.statusEffectDatas,{lenType:"u16"},o=>{b(t,o)}),t.u64(e.position),p(t,e.curHp)}var co="TroopMemberUpdateMinNotify";function lo(t,e){let o={};return o.identityGauge1=t.u32(),o.identityGauge2=t.u32(),o.identityGauge3=t.u32(),o.playerId=t.u64(),o}function yo(t,e){t.u32(e.identityGauge1),t.u32(e.identityGauge2),t.u32(e.identityGauge3),t.u64(e.playerId)}var bo="IdentityGaugeChangeNotify";function So(t,e){let o={};return o.objectId=t.u64(),o}function go(t,e){t.u64(e.objectId)}var xo="ZoneObjectUnpublishNotify";function ia(t,e){let o={};return o.stackCount=t.u8(),o.target=t.u8(),o.id=t.u32(),o}function aa(t,e){t.u8(e.stackCount),t.u8(e.target),t.u32(e.id)}function No(t,e){let o={};return o.zoneStatusEffectDataList=t.array(t.u16(),()=>ia(t,e)),o}function Io(t,e){t.array(e.zoneStatusEffectDataList,{lenType:"u16"},o=>{aa(t,o)})}var Eo="ZoneStatusEffectAddNotify";function ho(t,e){let o={};return o.statusEffectId=t.u32(),o}function Do(t,e){t.u32(e.statusEffectId)}var Co="ZoneStatusEffectRemoveNotify";function vo(t,e){let o={};return o.skillLevel=t.u8(),o.caster=t.u64(),o.skillId=t.u32(),o}function Ro(t,e){t.u8(e.skillLevel),t.u64(e.caster),t.u32(e.skillId)}var To="SkillCastNotify";function ko(t,e){let o={};return o.objectId=t.u64(),o.stance=t.u8(),o}function Lo(t,e){t.u64(e.objectId),t.u8(e.stance)}var Ao="IdentityStanceChangeNotify";function Po(t,e){let o={};return o.objectId=t.u64(),o.equipItemDataList=t.array(t.u16(),()=>D(t,e)),o}function _o(t,e){t.u64(e.objectId),t.array(e.equipItemDataList,{lenType:"u16"},o=>{C(t,o)})}var Wo="EquipChangeNotify";function wo(t,e){let o={};return o.objectId=t.u64(),o.equipLifeToolDataList=t.array(t.u16(),()=>D(t,e)),o}function Bo(t,e){t.u64(e.objectId),t.array(e.equipLifeToolDataList,{lenType:"u16"},o=>{C(t,o)})}var Fo="EquipLifeToolChangeNotify";function na(t,e){let o={};return t.bool()&&(o.serialNumber=t.u64(),o.id=t.u32(),o.level=t.u16(),o.slot=t.u16(),o.durability=t.u32(),o.unk1_6_m=t.u32(),o.flag=t.u32(),o.expireTime=x(t),o.lockUpdateTime=x(t)),o}function ra(t,e){t.bool(e.slot!==void 0)&&(t.u64(e.serialNumber),t.u32(e.id),t.u16(e.level),t.u16(e.slot),t.u32(e.durability),t.u32(e.unk1_6_m),t.u32(e.flag),N(t,e.expireTime),N(t,e.lockUpdateTime))}function Mo(t,e){let o={};return o.itemDataList=t.array(t.u16(),()=>na(t,e)),o.storageType=t.u8(),o}function Oo(t,e){t.array([1,20].includes(e.storageType)?e.itemDataList:[],{lenType:"u16"},o=>{ra(t,o)}),t.u8(e.storageType)}var jo="InitItem";function sa(t,e){let o={};return o.npcId=t.u32(),o.isDead=t.bool(),o}function ua(t,e){t.u32(e.npcId),t.bool(e.isDead)}function Uo(t,e){let o={};return o.raidResult=t.u8(),o.raidId=t.u32(),o.totalTime=t.u64(),o.bossKillDataList=t.array(t.u16(),()=>sa(t,e)),o.endTick=t.u64(),o.startTick=t.u64(),o}function Zo(t,e){t.u8(e.raidResult),t.u32(e.raidId),t.u64(e.totalTime),t.array(e.bossKillDataList,{lenType:"u16"},o=>{ua(t,o)}),t.u64(e.endTick),t.u64(e.startTick)}var qo="RaidBegin";function zo(t,e){let o={};return o.zoneInstId=t.u64(),o.zoneId=t.u32(),o.loadComplete=t.bool(),o.completeMembers=t.array(t.u16(),()=>t.u64()),o.totalMembers=t.array(t.u16(),()=>t.u64()),o.firstPCEnterTick=t.u64(),o.zoneLevel=t.u8(),o}function Vo(t,e){t.u64(e.zoneInstId),t.u32(e.zoneId),t.bool(e.loadComplete),t.array(e.completeMembers,{lenType:"u16"},o=>{t.u64(o)}),t.array(e.totalMembers,{lenType:"u16"},o=>{t.u64(o)}),t.u64(e.firstPCEnterTick),t.u8(e.zoneLevel)}var Ho="ZoneMemberLoadStatusNotify";function fa(t,e){let o={};return o.position=l(t),o.objectId=t.u64(),o.ownerId=t.u64(),o.skillId=t.u32(),o.skillEffect=t.u32(),o}function ma(t,e){y(t,e.position),t.u64(e.objectId),t.u64(e.ownerId),t.u32(e.skillId),t.u32(e.skillEffect)}function Go(t,e){let o={};return o.trapData=fa(t,e),o}function Ko(t,e){ma(t,e.trapData)}var Yo="NewTrap";function $o(t,e){let o={};return o.skillId=t.u32(),o.caster=t.u64(),o.newDirectionYaw=S(t),o.cancelReason=t.u8(),o.newPosition=l(t),o}function Qo(t,e){t.u32(e.skillId),t.u64(e.caster),g(t,e.newDirectionYaw),t.u8(e.cancelReason),y(t,e.newPosition)}var Jo="SkillCancelNotify";function Xo(t,e){let o={};return o.players=t.array(t.u8(),()=>{let i={};return i.name=t.string(),i.stats=t.array(t.u8(),()=>{let a={};return a.id=t.u8(),a.value=t.u32(),a}),e>=4&&(i.elixirs=t.array(t.u8(),()=>{let a={};return a.slot=t.u8(),a.entries=t.array(t.u8(),()=>{let r={};return r.level=t.u8(),r.id=t.u32(),r}),a})),e>=5&&(i.gems=t.array(t.u8(),()=>{let a={};return a.id=t.u32(),a.skillId=t.u32(),a.type=t.u8(),a.value=t.u16(),a})),i}),o}function ti(t,e){t.array(e.players,{lenType:"u8"},o=>{t.string(o.name),t.array(o.stats,{lenType:"u8"},i=>{t.u8(i.id),t.u32(i.value)}),t.array(o.elixirs,{lenType:"u8"},i=>{t.u8(i.slot),t.array(i.entries,{lenType:"u8"},a=>{t.u8(a.level),t.u32(a.id)})}),t.array(o.gems,{lenType:"u8"},i=>{t.u32(i.id),t.u32(i.skillId),t.u8(i.type),t.u16(i.value)})})}var ei="APP_StatApi";var oi=new Map([[0,[X,Q,J]],[1,[ot,tt,et]],[2,[nt,it,at]],[4,[ut,rt,st]],[5,[pt,ft,mt]],[6,[yt,ct,lt]],[7,[St,dt,bt]],[8,[Nt,gt,xt]],[9,[Ct,ht,Dt]],[10,[Tt,vt,Rt]],[11,[At,kt,Lt]],[12,[wt,_t,Wt]],[13,[Mt,Bt,Ft]],[14,[Zt,jt,Ut]],[15,[Vt,qt,zt]],[16,[Kt,Ht,Gt]],[17,[Qt,Yt,$t]],[18,[te,Jt,Xt]],[19,[ie,ee,oe]],[20,[re,ae,ne]],[21,[fe,se,ue]],[22,[ce,me,pe]],[23,[de,le,ye]],[24,[ge,be,Se]],[25,[Ie,xe,Ne]],[26,[De,Ee,he]],[27,[Re,Ce,ve]],[28,[Le,Te,ke]],[29,[_e,Ae,Pe]],[30,[Be,We,we]],[31,[Oe,Fe,Me]],[32,[Ze,je,Ue]],[34,[Ve,qe,ze]],[35,[Ke,He,Ge]],[36,[Qe,Ye,$e]],[37,[to,Je,Xe]],[38,[io,eo,oo]],[39,[ro,ao,no]],[40,[fo,so,uo]],[41,[co,mo,po]],[42,[bo,lo,yo]],[43,[xo,So,go]],[44,[Eo,No,Io]],[45,[Co,ho,Do]],[46,[To,vo,Ro]],[47,[Ao,ko,Lo]],[48,[Wo,Po,_o]],[49,[Fo,wo,Bo]],[50,[jo,Mo,Oo]],[52,[qo,Uo,Zo]],[51,[Ho,zo,Vo]],[53,[Yo,Go,Ko]],[54,[Jo,$o,Qo]],[6e4,[ei,Xo,ti]]]);var T=class{b;o;constructor(e){this.b=e,this.o=0}skip(e=0){this.o+=e}bool(){return this.u8()===1}u8(){return this.b.readUint8(this.o++)}i8(){return this.b.readInt8(this.o++)}u16(){let e=this.b.readUint16LE(this.o);return this.o+=2,e}i16(){let e=this.b.readInt16LE(this.o);return this.o+=2,e}u32(){let e=this.b.readUint32LE(this.o);return this.o+=4,e}i32(){let e=this.b.readInt32LE(this.o);return this.o+=4,e}u48(){let e=this.b.readUIntLE(this.o,6);return this.o+=6,e}i48(){let e=this.b.readIntLE(this.o,6);return this.o+=6,e}f32(){let e=this.b.readFloatLE(this.o);return this.o+=4,e}u64(){let e=this.b.readBigUint64LE(this.o);return this.o+=8,e}i64(){let e=this.b.readBigInt64LE(this.o);return this.o+=8,e}string(e){let o=this.u16();if(!e||o<=e){o=o*2;let i=this.b.toString("utf16le",this.o,this.o+o);return this.o+=o,i}return""}bytes(e=0,o,i){if(o&&e>o)return Buffer.alloc(0);i&&(e=e*i);let a=Buffer.from(this.b.subarray(this.o,this.o+e));return this.o+=e,a}array(e,o,i){return i&&e>i?[]:new Array(e).fill(void 0).map(o)}},k=class{b;o;constructor(e=65535){this.b=Buffer.allocUnsafe(e),this.o=0}get value(){return this.b.subarray(0,this.o)}skip(e=0){this.o+=e}bool(e=!1){return this.u8(e?1:0),e}u8(e=0){this.b.writeUInt8(e,this.o++)}i8(e=0){this.b.writeInt8(e,this.o++)}u16(e=0){this.o=this.b.writeUInt16LE(e,this.o)}i16(e=0){this.o=this.b.writeInt16LE(e,this.o)}u32(e=0){this.o=this.b.writeUInt32LE(e,this.o)}i32(e=0){this.o=this.b.writeInt32LE(e,this.o)}u48(e=0){this.o=this.b.writeUIntLE(e,this.o,6)}i48(e=0){this.o=this.b.writeIntLE(e,this.o,6)}f32(e=0){this.o=this.b.writeFloatLE(e,this.o)}u64(e=0n){this.o=this.b.writeBigUInt64LE(BigInt(e),this.o)}i64(e=0n){this.o=this.b.writeBigInt64LE(BigInt(e),this.o)}string(e="",o){this.u16(e.length),(!o||e.length<=o)&&(this.o+=this.b.write(e,this.o,"utf16le"))}bytes(e=Buffer.alloc(0),o={}){if(o.maxLen!==void 0){let i=o.multiplier??1;if(e.length%i)throw new Error(`Error writing bytes, chunkSize should be a multiple of intut value size, got ${e.length}%${i}`);let a=e.length/i;if(o.maxLen&&a>o.maxLen)throw new Error(`Error writing bytes, input value size exceeded maxLen, got ${a} > ${o.maxLen}`);if(!o.lenType)throw new Error(`Error writing bytes, invalid lenType when writing chunks, got ${o.lenType}`);this[o.lenType](a)}else if(o.length&&e.length!==o.length)throw new Error(`Error writing bytes, input value size doesn't match opts.length, ${e.length} !== ${o.lenType}`);this.o+=e.copy(this.b,this.o)}array(e=[],o,i){if(e===void 0||o.maxLen&&e.length>o.maxLen){this[o.lenType](0);return}this[o.lenType](e.length),e.forEach(i)}};var L=class{time;#e;#o;#t;#i;constructor(...e){if(e.length===5){let[o,i,a,r,n]=e;this.#o=o,this.time=a,this.#e=i,this.#t=r,this.#i=n}else if(e.length===3){let[o,i,a]=e;this.#o=Buffer.alloc(0),this.time=new Date,this.#e=i,this.#t=()=>o,this.#i=a}else throw new Error("[meter-core/logger/parser] - LogEvent<T>: Invalid constructor arguments")}#a;get parsed(){if(!this.#a)try{this.#a=this.#t(new T(this.#o))}catch(e){console.error(`[meter-core/logger/parser] - parsed - ${e}`);return}return this.#a}#n;get serialized(){if(!this.#n)try{if(!this.parsed)return;let e=new k;e.skip(ai),this.#i(e,this.parsed);let o=e.value;o.writeUint16LE(o.length,ca),o.writeUint16LE(this.#e,V),o.writeUintLE(+new Date,ii,H),this.#n=e.value}catch(e){console.error(`[meter-core/logger/parser] - serialized - ${e}`);return}return this.#n}},A=6,pa=2,ca=0,z=2,V=ca+pa,H=6,ii=V+z,ai=pa+z+H;import{createWriteStream as qa}from"fs";import{createReadStream as za}from"fs";import la from"net";import{TypedEmitter as ja}from"tiny-typed-emitter";var G=(u=>(u[u.CC_Auth=0]="CC_Auth",u[u.CS_Auth=1]="CS_Auth",u[u.CC_Data=2]="CC_Data",u[u.CS_Data=3]="CS_Data",u[u.CC_Logout=4]="CC_Logout",u[u.CC_OnConnect=5]="CC_OnConnect",u[u.CS_SyncDmg=1e3]="CS_SyncDmg",u[u.CS_SyncZone=1001]="CS_SyncZone",u[u.CS_Error=6e4]="CS_Error",u[u.CCS_PingPong=60001]="CCS_PingPong",u))(G||{});function ni(t){let e={};return e.version=t.u32(),e.token=t.string(7168),e}function ri(t,e){t.u32(e.version),t.string(e.token,7168)}var si="CC_Auth";function ui(t){let e={};return e.opcodes=t.array(t.u16(),()=>t.u16(),3e3),e.xorkey=t.bytes(256),e.migration=t.u16(),e}function fi(t,e){t.array(e.opcodes,{maxLen:3e3,lenType:"u16"},o=>{t.u16(o)}),t.bytes(e.xorkey,{length:256}),t.u16(e.migration)}var mi="CS_Auth";function pi(t){let e={};return e.opcode=t.u16(),e.timestamp=t.bytes(6).readUIntLE(0,6),e.data=t.bytes(t.u16(),65522),e}function ci(t,e){let o=Buffer.alloc(6);o.writeUintLE(e.timestamp,0,6),t.u16(e.opcode),t.bytes(o,{length:6}),t.bytes(e.data,{maxLen:65522,lenType:"u16"})}var li="CC_Data";function yi(t){let e={};return e.logId=t.u16(),e.timestamp=t.bytes(6).readUIntLE(0,6),e.data=t.bytes(t.u16(),65522),e}function di(t,e){let o=Buffer.alloc(6);o.writeUintLE(e.timestamp,0,6),t.u16(e.logId),t.bytes(o,{length:6}),t.bytes(e.data,{maxLen:65522,lenType:"u16"})}var bi="CS_Data";function Si(t){return{}}function gi(t,e){}var xi="CC_Logout";function Ni(t){let e={};return e.ip=t.string(21),e}function Ii(t,e){t.string(e.ip,21)}var Ei="CC_OnConnect";function hi(t){let e={};return e.table=t.array(t.u8(),()=>({name:t.string(),typeId:t.u16(),dealt:t.i48(),crit:t.u16(),fa:t.u16(),ba:t.u16(),receivedDps:t.i48(),receivedSupp:t.i48(),given:t.i48(),deadDuration:t.u32()})),e.duration=t.u32(),e}function Di(t,e){t.array(e.table,{lenType:"u8"},o=>{t.string(o.name),t.u16(o.typeId),t.i48(o.dealt),t.u16(o.crit),t.u16(o.fa),t.u16(o.ba),t.i48(o.receivedDps),t.i48(o.receivedSupp),t.i48(o.given),t.u32(o.deadDuration)}),t.u32(e.duration)}var Ci="CS_SyncDmg";function vi(t){let e={};return e.isValid=t.bool(),e}function Ri(t,e){t.bool(e.isValid)}var Ti="CS_SyncZone";function ki(t){let e={};return e.code=t.u32(),e.msg=t.string(7168),e}function Li(t,e){t.u32(e.code),t.string(e.msg,7168)}var Ai="CS_Error";function Pi(t){return{}}function _i(t,e){}var Wi="CCS_PingPong";var wi=new Map([[0,[si,ni,ri]],[1,[mi,ui,fi]],[2,[li,pi,ci]],[3,[bi,yi,di]],[4,[xi,Si,gi]],[5,[Ei,Ni,Ii]],[1e3,[Ci,hi,Di]],[1001,[Ti,vi,Ri]],[6e4,[Ai,ki,Li]],[60001,[Wi,Pi,_i]]]);var P=class{#e;#o;#t;constructor(e,o,i){this.#e=e,this.#o=o,this.#t=i}#i;get parsed(){if(!this.#i)try{this.#i=this.#t(new T(this.#e))}catch{return}return this.#i}};import Ua from"axios";var ya=(s=>(s[s.OFFLINE=0]="OFFLINE",s[s.NO_GAME=1]="NO_GAME",s[s.CONNECTING=2]="CONNECTING",s[s.AUTHING=3]="AUTHING",s[s.IDLE=4]="IDLE",s[s.SENDING=5]="SENDING",s[s.NO_AUTH=6]="NO_AUTH",s[s.ERROR=7]="ERROR",s))(ya||{}),K=class extends ja{socket;serverList=[];token;#e=[];connState=6;reconnectTimeout;gameIdleTimeout;constructor(e){super(),this.socket=new la.Socket,this.token=e,e&&this.setAuthState(0);let o=new W;this.socket.on("data",i=>{o.write(i);let a;for(;a=o.read();){if(a.length<4||a.readUint16LE(0)!=a.length)continue;let n=a.readUint16LE(2),f=wi.get(n);if(f){let[s,c,u]=f;this.emit(s,new P(Buffer.from(a.subarray(4)),n,c)),this.emit("*",s,new P(Buffer.from(a.subarray(4)),n,c))}}}).on("close",()=>{this.destroy(),[2,3,4,5,0].includes(this.connState)&&(this.setAuthState(0),clearTimeout(this.reconnectTimeout),this.reconnectTimeout=setTimeout(()=>{this.reconnect()},5e3))}).on("error",i=>{console.log(`Conn error ${i}`)}).on("connect",()=>{this.token?(this.setAuthState(3),this.#o(this.prepare("CC_Auth",{token:this.token,version:5}))):(this.setAuthState(6),this.destroy())}),this.reconnect()}destroy(){this.socket.destroy()}reconnect(){[0,1].includes(this.connState)&&(this.setAuthState(2),this.getBestServer().then(e=>{e&&this.connState===2&&(console.info(`[CloudConnection] - Picked node: ${e.ip}:${e.port} with latency ${e.latency}`),this.socket.connect(e.port,e.ip))}))}async getBestServer(){let e=await Ua.get("https://nodes-la.herysia.com/nodes");if(!(e.status!==200&&e.status!==304))return Promise.all([...e.data.map(o=>({ip:o,port:8001})),...this.serverList].map(({ip:o,port:i})=>this.getLatency(o,i))).then(o=>o.reduce((i,a)=>i&&i.latency<a.latency?i:a))}getLatency(e,o){return new Promise(i=>{let a=new la.Socket,r=+new Date;a.setTimeout(5e3),a.on("error",n=>{a.destroy(),i({ip:e,port:o,latency:5e3})}),a.on("timeout",()=>{a.destroy(),i({ip:e,port:o,latency:5e3})}),a.connect(o,e,()=>{a.destroy(),i({ip:e,port:o,latency:+new Date-r})})})}prepare(e,o){let i=G[e],a=wi.get(i);if(a){let[r,n,f]=a;try{let s=new k;s.skip(4),f(s,o);let c=s.value;return c.writeUint16LE(c.length),c.writeUint16LE(i,2),c}catch{}}}send(e,o){let i;(i=this.prepare(e,o))&&this.#e.push(i),this.flushQueue()}async flushQueue(){switch(this.connState){case 0:case 1:break;case 4:this.connState=5;let e,o;for([e,o]of this.#e.entries())if(!await this.#o(o))break;this.#e.splice(0,(e??0)+1),this.connState===5&&(this.connState=4);break;case 6:case 2:case 5:case 3:default:break}}#o(e){return new Promise(o=>{if(!e)return o(!0);this.socket.write(e,i=>{i&&console.log(i),o(!i)})})}failAuth(){this.setAuthState(6),this.destroy()}setError(){this.setAuthState(7),this.destroy()}setAuthState(e){this.connState=e,this.emit("authState",e)}initGameIdleTimeout(){this.gameIdleTimeout?this.gameIdleTimeout.refresh():this.gameIdleTimeout=setTimeout(()=>{console.info("[CloudConnection] - No game packets detected, logging out"),[7,6].includes(this.connState)||this.setAuthState(1),this.destroy()},3e5)}updateAuthToken(e){this.token=e,e&&this.connState===6&&(this.connState=0,this.reconnect())}};var Y=class extends Za{},da=class extends Y{#e;#o;#t;#i=[];#a=0;#n=!1;ip;constructor(e,o,i){super(),this.#e=o,this.#t=new K,this.#t.on("CS_Auth",r=>{let n=r.parsed;n&&(this.#i=n.opcodes,this.#e.xorTable=n.xorkey,this.#a=n.migration,this.#t.connState===3&&this.#t.setAuthState(4),this.#t.initGameIdleTimeout())}).on("CS_Data",this.handlePkt.bind(this)).on("CS_Error",r=>{switch(r.parsed?.code){case 0:case 8:this.#t.failAuth();break;case 2:this.#t.setError();break;case 10:this.#t.failAuth();break;case 6e4:this.#n=!0;break;case 5:case 4:break;case 1:case 3:case 6:case 7:case 9:default:break}console.error(`[meter-core/logger] - cloud error (${r.parsed?.code}): ${r.parsed?.msg}`)}).on("CCS_PingPong",()=>{this.#t.send("CCS_PingPong",{})}).on("CS_SyncDmg",r=>{let n=r.parsed;n&&this.emit("syncDmg",n)}).on("CS_SyncZone",r=>{let n=r.parsed;n&&this.emit("syncZone",n)}).on("authState",r=>{this.emit("authState",r)}),i&&(this.#o=qa(i,{highWaterMark:0}));let a=Buffer.allocUnsafe(A);a.writeUIntLE(5,0,A),this.#o?.write(a),e.on("*",(r,n,f,s)=>{try{if(this.#t.gameIdleTimeout?.refresh(),this.#n&&n===this.#a&&(this.#t.setAuthState(0),this.#t.destroy(),this.ip&&this.#t.send("CC_OnConnect",{ip:this.ip})),this.#i.includes(n)&&this.#e.xorTable){let c=+new Date,u=this.#e.decrypt(r,n,f,s);this.#t.send("CC_Data",{data:u,opcode:n,timestamp:c})}}catch(c){console.error(c)}})}handlePkt(e){try{let o=e.parsed;if(o){let i=oi.get(o.logId);if(i){let[a,r,n]=i,f=new L(o.data,o.logId,new Date(o.timestamp),s=>r(s,5),n);this.emit(a,f),this.emit("*",a,f),this.appendLog(f)}}}catch(o){console.error(o)}}appendLog(e){this.#o&&e.serialized&&this.#o.write(e.serialized)}onConnect(e){this.ip=e,this.#t.send("CC_OnConnect",{ip:e})}updateAuthToken(e){this.#t.updateAuthToken(e)}forceUpdateAuthState(){[0,1,2,3,4,6,7].includes(this.#t.connState)&&this.emit("authState",this.#t.connState)}},ba=class extends Y{readLogByChunk(e){let o=new W,i=za(e),a=!1,r;i.on("data",n=>{if(r===void 0){if(r=this.readVersion(n),r>5){i.destroy();return}n=n.subarray(A)}o.write(n);let f;for(;f=o.read();)this.readLogChunk(f,r)}).on("end",()=>{a=!0,this.emit("fileEnd","end")}).on("close",()=>{a||this.emit("fileEnd","closed")})}readLogChunk(e,o){try{if(e.length<8)return!1;let i=e.readUIntLE(V,z),a=new Date(e.readUintLE(ii,H)),r=e.subarray(ai),n=oi.get(i);if(n){let[f,s,c]=n,u=new L(r,i,new Date(a),Sa=>s(Sa,o),c);this.emit(f,u),this.emit("*",f,u)}}catch(i){console.error(i)}}readVersion(e){return e.readUintLE(0,A)}};export{Lt as a,L as b,ya as c,Y as d,da as e,ba as f};
