var Lr=Object.create;var O=Object.defineProperty;var Ar=Object.getOwnPropertyDescriptor;var br=Object.getOwnPropertyNames;var Pr=Object.getPrototypeOf,Wr=Object.prototype.hasOwnProperty;var Br=(n,_)=>{for(var o in _)O(n,o,{get:_[o],enumerable:!0})},Hs=(n,_,o,s)=>{if(_&&typeof _=="object"||typeof _=="function")for(let r of br(_))!Wr.call(n,r)&&r!==o&&O(n,r,{get:()=>_[r],enumerable:!(s=Ar(_,r))||s.enumerable});return n};var Gs=(n,_,o)=>(o=n!=null?Lr(Pr(n)):{},Hs(_||!n||!n.__esModule?O(o,"default",{value:n,enumerable:!0}):o,n)),Mr=n=>Hs(O({},"__esModule",{value:!0}),n);var ou={};Br(ou,{ConnState:()=>ps,LiveLogger:()=>qs,Logger:()=>j,ReplayLogger:()=>Vs});module.exports=Mr(ou);var Cr=require("tiny-typed-emitter");function T(n,_){let o={};return o.points=n.u16(),o.id=n.u32(),o.level=n.u8(),o}function L(n,_){n.u16(_.points),n.u32(_.id),n.u8(_.level)}function g(n,_){let o={};return o.abilityDataList=n.array(n.u16(),()=>T(n,_)),o}function y(n,_){n.array(_.abilityDataList,{lenType:"u16"},o=>{L(n,o)})}var nn="AbilityChangeNotify";function Ks(n,_){let o={};return o.featureType=n.u16(),o.level=n.u32(),o}function zs(n,_){n.u16(_.featureType),n.u32(_.level)}function _n(n,_){let o={};return o.activeAbilityList=n.array(n.u16(),()=>Ks(n,_)),o.objectId=n.u64(),o}function on(n,_){n.array(_.activeAbilityList,{lenType:"u16"},o=>{zs(n,o)}),n.u64(_.objectId)}var sn="ActiveAbilityNotify";function rn(n,_){let o={};return o.objectId=n.u64(),o.addonSkillFeatureList=n.array(n.u16(),()=>{let s={};return s.addonSkillFeatureIdList=n.array(n.u16(),()=>n.u32()),s.skillId=n.u32(),s}),o}function un(n,_){n.u64(_.objectId),n.array(_.addonSkillFeatureList,{lenType:"u16"},o=>{n.array(o.addonSkillFeatureIdList,{lenType:"u16"},s=>{n.u32(s)}),n.u32(o.skillId)})}var mn="AddonSkillFeatureChangeNotify";function an(n,_){let o={};return o.paralyzationMaxPoint=n.u32(),o.type=n.u8(),o.objectId=n.u64(),o.paralyzationPoint=n.u32(),o}function dn(n,_){n.u32(_.paralyzationMaxPoint),n.u8(_.type),n.u64(_.objectId),n.u32(_.paralyzationPoint)}var en="BlockSkillStateNotify";function ln(n,_){let o={};return o.sourceId=n.u64(),o.targetId=n.u64(),o.type=n.u32(),o}function hn(n,_){n.u64(_.sourceId),n.u64(_.targetId),n.u32(_.type)}var vn="CounterAttackNotify";function cn(n,_){let o={};return o.sourceId=n.u64(),o.targetId=n.u64(),_>=4?(o.effectId=n.u32(),o.directionYaw=n.u16(),o.deathType=n.u8(),o.durabilityDecrement=n.u8(),o.abnormalStatusType=n.u8(),o.damageAttr=n.u8(),o.unk0_m=n.u64(),o.unk2_m=n.u32()):(o.effectId=0,o.directionYaw=0,o.deathType=0,o.durabilityDecrement=0,o.abnormalStatusType=0,o.damageAttr=0,o.unk0_m=0n,o.unk2_m=0),o}function xn(n,_){n.u64(_.sourceId),n.u64(_.targetId),n.u32(_.effectId),n.u16(_.directionYaw),n.u8(_.deathType??0),n.u8(_.durabilityDecrement),n.u8(_.abnormalStatusType??0),n.u8(_.damageAttr??0),n.u64(_.unk0_m),n.u32(_.unk2_m)}var Sn="DeathNotify";function fn(n,_){let o={};return o.abilityDataList=n.array(n.u16(),()=>T(n,_)),o}function Nn(n,_){n.array(_.abilityDataList,{lenType:"u16"},o=>{L(n,o)})}var In="InitAbility";function En(n,_){let o={};return o.playerId=n.u64(),o}function kn(n,_){n.u64(_.playerId)}var Dn="InitEnv";var jr=[0,31,28,31,30,31,30,31,31,30,31,30,31];function Or(n){return!(n%4||!(n%100)&&n%400)}function Ur(n,_,o){if(n>99){if(n<1752||n==1752&&(_<9||_==9&&o<<14))return!1}else n+=1900;return o>0&&_<=12&&(o<=jr[_]||o==29&&_==2&&Or(n))}function Cn(n){let _=Number(n&0xffffffffn),o=Number(n>>32n&0xffffffffn),s=_&4095,r=(_&65535)>>12,u=_>>16&31;Ur(s,r,u)||(s=r=u=0);let m=_>>21&31,d=_>>26&63,i=o&63,h=o>>6&16383;return m<24&&d<60&&i<60&&h<1e3||(m=24,d=i=h=0),new Date(Date.UTC(s<=99?s+1900:s,r-1,u,m,d,i,h))}function Ys(n){let _=0n;return _|=BigInt(n.getUTCMilliseconds())<<38n,_|=BigInt(n.getUTCSeconds())<<32n,_|=BigInt(n.getUTCMinutes())<<26n,_|=BigInt(n.getUTCHours())<<21n,_|=BigInt(n.getUTCDate())<<16n,_|=BigInt(n.getUTCMonth()+1)<<12n,_|=BigInt(n.getUTCFullYear()<2e3?n.getUTCFullYear()-1900:n.getUTCFullYear()),_}function I(n,_=0){let o=n.u16();return(o&4095)<2079?(n.o-=2,Cn(n.i64())):Cn(BigInt(o)&0xfffn|0x11000n)}function E(n,_=Cn(0x1181fn)){_.getUTCFullYear()>=2079?n.u16(Number(Ys(_)&0xffffn)):n.i64(Ys(_))}function x(n,_){let o={};return o.skillLevel=n.u8(),o.occurTime=I(n,_),o.statusEffectId=n.u32(),o.sourceId=n.u64(),o.totalTime=n.f32(),o.endTick=n.u64(),n.bool()&&(o.value=n.bytes(16)),o.effectInstanceId=n.u32(),_>=1?o.stackCount=n.u8():o.stackCount=1,o}function S(n,_){n.u8(_.skillLevel),E(n,_.occurTime),n.u32(_.statusEffectId),n.u64(_.sourceId),n.f32(_.totalTime),n.u64(_.endTick),n.bool(_.value!==void 0)&&n.bytes(_.value,{length:16}),n.u32(_.effectInstanceId),n.u8(_.stackCount)}function Zr(n){if(n.length===0)return 0n;if(n.length>8)throw new Error("Value is too large");let _=Buffer.alloc(8);return n.copy(_),_.readBigInt64LE()}function e(n,_=0){let o=n.u8(),s=n.bytes(o>>1&7),r=Zr(s)<<4n|BigInt(o>>4);return o&1?-r:r}function l(n,_=0n){let o=Buffer.alloc(8),s=_<0n;o.writeBigInt64LE((s?-_:_)>>4n);let r=0;for(let[u,m]of o.entries())m!=0&&(r=u+1);if(r>7)throw new Error("Value is too large");n.u8(Number((s?-_:_)&0xfn)<<4|(r&7)<<1|(s?1:0)),n.bytes(o.subarray(0,r),{length:r})}function Rn(n,_){let o={};return o.statPair=n.array(n.u16(),()=>{let s={};return s.StatType=n.u8(),s.Value=e(n,_),s}),o.name=n.string(),o.level=n.u16(),o.statusEffectDatas=n.array(n.u16(),()=>x(n,_)),o.characterId=n.u64(),o.gearLevel=n.f32(),o.playerId=n.u64(),o.classId=n.u16(),o}function Tn(n,_){n.array(_.statPair,{lenType:"u16"},o=>{n.u8(o.statType),l(n,o.value)}),n.string(_.name),n.u16(_.level),n.array(_.statusEffectDatas,{lenType:"u16"},o=>{S(n,o)}),n.u64(_.characterId),n.f32(_.gearLevel),n.u64(_.playerId),n.u16(_.classId)}var Ln="InitPC";function An(n,_){let o={};return o.statPair=n.array(n.u16(),()=>{let s={};return s.statType=n.u8(),s.value=e(n,_),s}),o.statusEffectDatas=n.array(n.u16(),()=>x(n,_)),o.addonSkillFeatureList=n.array(n.u16(),()=>{let s={};return s.addonSkillFeatureIdList=n.array(n.u16(),()=>n.u32()),s.skillId=n.u32(),s}),o.abilityDataList=n.array(n.u16(),()=>T(n,_)),o}function bn(n,_){n.array(_.statPair,{lenType:"u16"},o=>{n.u8(o.statType),l(n,o.value)}),n.array(_.statusEffectDatas,{lenType:"u16"},o=>{S(n,o)}),n.array(_.addonSkillFeatureList,{lenType:"u16"},o=>{n.array(o.addonSkillFeatureIdList,{lenType:"u16"},s=>{n.u32(s)}),n.u32(o.skillId)}),n.array(_.abilityDataList,{lenType:"u16"},o=>{L(n,o)})}var Pn="InitLocal";function Wn(n,_){let o={};return o.account_CharacterId1=n.u64(),o.serverAddr=n.string(),o.account_CharacterId2=n.u64(),o}function Bn(n,_){n.u64(_.account_CharacterId1),n.string(_.serverAddr),n.u64(_.account_CharacterId2)}var Mn="MigrationExecute";function Fn(n){return n>>20===1?-((~n>>>0)+1&2097151):n}function v(n,_=0){let o=n.u64();return{x:Fn(Number(o&0x1fffffn)),y:Fn(Number(o>>21n&0x1fffffn)),z:Fn(Number(o>>42n&0x1fffffn))}}function c(n,_={x:0,y:0,z:0}){n.u64(BigInt(Math.round(_.x??0)>>>0&2097151)|BigInt(Math.round(_.y??0)>>>0&2097151)<<21n|BigInt(Math.round(_.z??0)>>>0&2097151)<<42n)}function f(n,_=0){return n.u16()*(2*Math.PI)/65536}function N(n,_=0){n.u16(Math.round(_*65536/(2*Math.PI))%65536)}function Z(n,_){let o={};return o.spawnIndex=n.u32(),o.objectId=n.u64(),n.bool()&&(o.transitIndex=n.u32()),o.position=v(n,_),o.statusEffectDatas=n.array(n.u16(),()=>x(n,_)),o.directionYaw=f(n,_),o.statPair=n.array(n.u16(),()=>{let s={};return s.statType=n.u8(),s.value=e(n,_),s}),o.typeId=n.u32(),_>=1?(o.level=n.u16(),n.bool()&&(o.balanceLevel=n.u16())):o.level=0,o}function p(n,_){n.u32(_.spawnIndex),n.u64(_.objectId),n.bool(_.transitIndex!==void 0)&&n.u32(_.transitIndex),c(n,_.position),n.array(_.statusEffectDatas,{lenType:"u16"},o=>{S(n,o)}),N(n,_.directionYaw),n.array(_.statPair,{lenType:"u16"},o=>{n.u8(o.statType),l(n,o.value)}),n.u32(_.typeId),n.u16(_.level),n.bool(_.balanceLevel!==void 0)&&n.u16(_.balanceLevel)}function jn(n,_){let o={};return o.npcStruct=Z(n,_),o}function On(n,_){p(n,_.npcStruct)}var Un="NewNpc";function Zn(n,_){let o={};return o.publishReason=n.u8(),o.ownerId=n.u64(),o.npcData=Z(n,_),o}function pn(n,_){n.u8(_.publishReason),n.u64(_.ownerId),p(n,_.npcData)}var qn="NewNpcSummon";function w(n,_){let o={};return o.slot=n.u16(),o.level=n.u16(),o.itemTint=n.bytes(n.u16(),0,14),o.expireTime=I(n),o.id=n.u32(),o}function R(n,_){n.u16(_.slot),n.u16(_.level),n.bytes(_.itemTint,{maxLen:0,lenType:"u16",multiplier:14}),E(n,_.expireTime),n.u32(_.id)}function Qs(n,_){let o={};return o.maxItemLevel=n.f32(),o.statPair=n.array(n.u16(),()=>{let s={};return s.statType=n.u8(),s.value=e(n,_),s}),o.name=n.string(),o.heading=f(n,_),o.characterId=n.u64(),o.playerId=n.u64(),o.addonSkillFeatureList=n.array(n.u16(),()=>{let s={};return s.addonSkillFeatureIdList=n.array(n.u16(),()=>n.u32()),s.skillId=n.u32(),s}),o.classId=n.u16(),o.level=n.u16(),o.statusEffectDatas=n.array(n.u16(),()=>x(n,_)),_>=1?(o.avgItemLevel=n.f32(),o.position=v(n),o.equipItemDataList=n.array(n.u16(),()=>w(n,_)),o.equipLifeToolDataList=n.array(n.u16(),()=>w(n,_)),o.guildName=n.string(),_>=2?o.guildId=n.u64():o.guildId=BigInt(n.u32())):(o.avgItemLevel=o.maxItemLevel,o.position={x:0,y:0,z:0},o.equipItemDataList=[],o.equipLifeToolDataList=[],o.guildName="",o.guildId=0n),o}function Js(n,_){n.f32(_.maxItemLevel),n.array(_.statPair,{lenType:"u16"},o=>{n.u8(o.statType),l(n,o.value)}),n.string(_.name),N(n,_.heading),n.u64(_.characterId),n.u64(_.playerId),n.array(_.addonSkillFeatureList,{lenType:"u16"},o=>{n.array(o.addonSkillFeatureIdList,{lenType:"u16"},s=>{n.u32(s)}),n.u32(o.skillId)}),n.u16(_.classId),n.u16(_.level),n.array(_.statusEffectDatas,{lenType:"u16"},o=>{S(n,o)}),n.f32(_.avgItemLevel),c(n,_.position),n.array(_.equipItemDataList,{lenType:"u16"},o=>{R(n,o)}),n.array(_.equipLifeToolDataList,{lenType:"u16"},o=>{R(n,o)}),n.string(_.guildName),n.u64(_.guildId)}function Hn(n,_){let o={};return o.pcStruct=Qs(n,_),o}function Gn(n,_){Js(n,_.pcStruct)}var Kn="NewPC";function q(n,_=0){return{first:n.u8(),second:n.u8(),third:n.u8()}}function V(n,_){n.u8(_.first),n.u8(_.second),n.u8(_.third)}function H(n,_=0){return{first:n.u16(),second:n.u16(),third:n.u16()}}function G(n,_){n.u16(_.first),n.u16(_.second),n.u16(_.third)}function gs(n,_){let o={};return o.tripodIndex=q(n,_),o.chainSkillEffect=n.u32(),o.skillEffect=n.u32(),o.skillId=n.u32(),o.targetObjectId=n.u64(),o.ownerId=n.u64(),o.skillLevel=n.u8(),o.projectileId=n.u64(),o.tripodLevel=H(n,_),o}function ys(n,_){V(n,_.tripodIndex),n.u32(_.chainSkillEffect),n.u32(_.skillEffect),n.u32(_.skillId),n.u64(_.targetObjectId),n.u64(_.ownerId),n.u8(_.skillLevel),n.u64(_.projectileId),G(n,_.tripodLevel)}function zn(n,_){let o={};return o.projectileInfo=gs(n,_),o}function Yn(n,_){ys(n,_.projectileInfo)}var $n="NewProjectile";function Qn(n,_){let o={};return o.enable=n.bool(),o.paralyzationPoint=n.u32(),o.decreasePoint=n.u32(),o.paralyzationMaxPoint=n.u32(),o.noHitCheckTime=n.u32(),o.hitCheckTime=n.u32(),o.objectId=n.u64(),o}function Jn(n,_){n.bool(_.enable),n.u32(_.paralyzationPoint),n.u32(_.decreasePoint),n.u32(_.paralyzationMaxPoint),n.u32(_.noHitCheckTime),n.u32(_.hitCheckTime),n.u64(_.objectId)}var Xn="ParalyzationStateNotify";function nr(n,_){let o={};return o.maxHp=e(n,_),o.characterId=n.u64(),o.position=v(n,_),o.transitIndex=n.u32(),o.curHp=e(n,_),o.characterLevel=n.u16(),o.gearLevel=n.f32(),o.zoneId=n.u32(),o.partyMemberNumber=n.u8(),o.name=n.string(),o.zoneInstId=n.u64(),o.worldId=n.u8(),o.classId=n.u16(),o.auths=n.u8(),o}function _r(n,_){l(n,_.maxHp),n.u64(_.characterId),c(n,_.position),n.u32(_.transitIndex),l(n,_.curHp),n.u16(_.characterLevel),n.f32(_.gearLevel),n.u32(_.zoneId),n.u8(_.partyMemberNumber),n.string(_.name),n.u64(_.zoneInstId),n.u8(_.worldId),n.u16(_.classId),n.u8(_.auths)}function tn(n,_){let o={};return o.raidInstanceId=n.u32(),o.lootGrade=n.u32(),o.partyType=n.u8(),o.partyInstanceId=n.u32(),o.partyLootType=n.u8(),o.memberDatas=n.array(n.u16(),()=>nr(n,_)),o}function gn(n,_){n.u32(_.raidInstanceId),n.u32(_.lootGrade),n.u8(_.partyType),n.u32(_.partyInstanceId),n.u8(_.partyLootType),n.array(_.memberDatas,{lenType:"u16"},o=>{_r(n,o)})}var yn="PartyInfo";function n_(n,_){let o={};return o.partyLeaveType=n.u8(),o.partyInstanceId=n.u32(),o.name=n.string(),o}function __(n,_){n.u8(_.partyLeaveType),n.u32(_.partyInstanceId),n.string(_.name)}var o_="PartyLeaveResult";function s_(n,_){let o={};return o.objectId=n.u64(),o.passiveStatusEffectList=n.array(n.u16(),()=>n.u32()),o.unk0_m=n.u8(),o}function r_(n,_){n.u64(_.objectId),n.array(_.passiveStatusEffectList,{lenType:"u16"},o=>{n.u32(o)}),n.u8(_.unk0_m)}var u_="PartyPassiveStatusEffectAddNotify";function m_(n,_){let o={};return o.objectId=n.u64(),o.passiveStatusEffectList=n.array(n.u16(),()=>n.u32()),o}function i_(n,_){n.u64(_.objectId),n.array(_.passiveStatusEffectList,{lenType:"u16"},o=>{n.u32(o)})}var a_="PartyPassiveStatusEffectRemoveNotify";function d_(n,_){let o={};return o.characterId=n.u64(),o.statusEffectDatas=n.array(n.u16(),()=>x(n,_)),o.playerIdOnRefresh=n.u64(),o}function e_(n,_){n.u64(_.characterId),n.array(_.statusEffectDatas,{lenType:"u16"},o=>{S(n,o)}),n.u64(_.playerIdOnRefresh)}var l_="PartyStatusEffectAddNotify";function h_(n,_){let o={};return o.characterId=n.u64(),o.statusEffectIds=n.array(n.u16(),()=>n.u32()),o.reason=n.u8(),o}function v_(n,_){n.u64(_.characterId),n.array(_.statusEffectIds,{lenType:"u16"},o=>{n.u32(o)}),n.u8(_.reason)}var c_="PartyStatusEffectRemoveNotify";function x_(n,_){let o={};return o.partyInstanceId=n.u32(),o.raidInstanceId=n.u32(),o.characterId=n.u64(),o}function S_(n,_){n.u32(_.partyInstanceId),n.u32(_.raidInstanceId),n.u64(_.characterId)}var f_="PartyStatusEffectResultNotify";function N_(n,_){let o={};return o.passiveStatusEffectList=n.array(n.u16(),()=>n.u32()),o}function I_(n,_){n.array(_.passiveStatusEffectList,{lenType:"u16"},o=>{n.u32(o)})}var E_="PassiveStatusEffectAddNotify";function k_(n,_){let o={};return o.passiveStatusEffectList=n.array(n.u16(),()=>n.u32()),o}function D_(n,_){n.array(_.passiveStatusEffectList,{lenType:"u16"},o=>{n.u32(o)})}var C_="PassiveStatusEffectRemoveNotify";function w_(n,_){let o={};return _>=4?o.typeId=n.u32():o.typeId=0,o}function R_(n,_){n.u32(_.typeId)}var T_="RaidBossKillNotify";function L_(n,_){let o={};return _>=3?o.raidResult=n.u8():o.raidResult=0,o}function A_(n,_){n.u8(_.raidResult)}var b_="RaidResult";function or(n,_){let o={};return o.unpublishReason=n.u8(),o.objectId=n.u64(),o}function sr(n,_){n.u8(_.unpublishReason),n.u64(_.objectId)}function P_(n,_){let o={};return o.unpublishedObjects=n.array(n.u16(),()=>or(n,_)),o}function W_(n,_){n.array(_.unpublishedObjects,{lenType:"u16"},o=>{sr(n,o)})}var B_="RemoveObject";function rr(n,_=0){let o={},s=n.u8();return s&1&&(o.moveTime=n.u32()),s&2&&(o.standUpTime=n.u32()),s&4&&(o.downTime=n.u32()),s&8&&(o.freezeTime=n.u32()),s&16&&(o.moveHeight=n.u32()),s&32&&(o.farmostDist=n.u32()),s&64&&(o.flag40=n.bytes(n.u16(),6)),o}function ur(n,_){let o=(_.moveTime===void 0?0:1)|(_.standUpTime===void 0?0:2)|(_.downTime===void 0?0:4)|(_.freezeTime===void 0?0:8)|(_.moveHeight===void 0?0:16)|(_.farmostDist===void 0?0:32)|(_.flag40===void 0?0:64);n.u8(o),o&1&&n.u32(_.moveTime),o&2&&n.u32(_.standUpTime),o&4&&n.u32(_.downTime),o&8&&n.u32(_.freezeTime),o&16&&n.u32(_.moveHeight),o&32&&n.u32(_.farmostDist),o&64&&n.bytes(_.flag40,{maxLen:6,lenType:"u16"})}function K(n,_){let o={};return o.modifier=n.u8(),o.targetId=n.u64(),o.damageType=n.u8(),n.bool()&&(o.damageAttr=n.u8()),o.curHp=e(n,_),o.unk3_m=n.u16(),o.maxHp=e(n,_),o.damage=e(n,_),o}function z(n,_){n.u8(_.modifier),n.u64(_.targetId),n.u8(_.damageType),n.bool(_.damageAttr!==void 0)&&n.u8(_.damageAttr),l(n,_.curHp),n.u16(_.unk3_m),l(n,_.maxHp),l(n,_.damage)}function ir(n,_){let o={};return o.skillMoveOptionData=rr(n,_),o.destination=v(n,_),o.position=v(n,_),o.skillDamageEvent=K(n,_),o}function ar(n,_){ur(n,_.skillMoveOptionData),c(n,_.destination),c(n,_.position),z(n,_.skillDamageEvent)}function M_(n,_){let o={};return o.skillId=n.u32(),o.skillDamageAbnormalMoveEvents=n.array(n.u16(),()=>ir(n,_)),o.skillEffectId=n.u32(),o.sourceId=n.u64(),o}function F_(n,_){n.u32(_.skillId),n.array(_.skillDamageAbnormalMoveEvents,{lenType:"u16"},o=>{ar(n,o)}),n.u32(_.skillEffectId),n.u64(_.sourceId)}var j_="SkillDamageAbnormalMoveNotify";function O_(n,_){let o={};return o.skillLevel=n.u8(),o.sourceId=n.u64(),o.skillId=n.u32(),o.skillDamageEvents=n.array(n.u16(),()=>K(n,_)),o.skillEffectId=n.u32(),o}function U_(n,_){n.u8(_.skillLevel),n.u64(_.sourceId),n.u32(_.skillId),n.array(_.skillDamageEvents,{lenType:"u16"},o=>{z(n,o)}),n.u32(_.skillEffectId??0)}var Z_="SkillDamageNotify";function p_(n,_){let o={};return o.sourceId=n.u64(),o.skillId=n.u32(),o.stage=n.u8(),o}function q_(n,_){n.u64(_.sourceId),n.u32(_.skillId),n.u8(_.stage)}var V_="SkillStageNotify";function dr(n,_=0){let o={},s=n.u8();return s&1&&(o.layerIndex=n.u8()),s&2&&(o.startStageIndex=n.u8()),s&4&&(o.transitIndex=n.u32()),s&8&&(o.stageStartTime=n.u32()),s&16&&(o.farmostDistance=n.u32()),s&32&&(o.tripodIndex=q(n)),s&64&&(o.tripodLevel=H(n)),o}function er(n,_){let o=(_.layerIndex===void 0?0:1)|(_.startStageIndex===void 0?0:2)|(_.transitIndex===void 0?0:4)|(_.stageStartTime===void 0?0:8)|(_.farmostDistance===void 0?0:16)|(_.tripodIndex===void 0?0:32)|(_.tripodLevel===void 0?0:64);n.u8(o),o&1&&n.u8(_.layerIndex),o&2&&n.u8(_.startStageIndex),o&4&&n.u32(_.transitIndex),o&8&&n.u32(_.stageStartTime),o&16&&n.u32(_.farmostDistance),o&32&&V(n,_.tripodIndex),o&64&&G(n,_.tripodLevel)}function H_(n,_){let o={};return o.sourceId=n.u64(),o.curDirectionYaw=f(n,_),o.newDirectionYaw=f(n,_),o.aimTargetPosition=v(n,_),n.bool()&&(o.pitchRotation=f(n,_)),n.bool()&&(o.aiStateId=n.u32()),o.curPosition=v(n,_),n.bool()&&(o.unk1_m=n.u32()),o.skillLevel=n.u8(),o.newPosition=v(n,_),o.skillId=n.u32(),o.skillOptionData=dr(n,_),o}function G_(n,_){n.u64(_.sourceId),N(n,_.curDirectionYaw),N(n,_.newDirectionYaw),c(n,_.aimTargetPosition),n.bool(_.pitchRotation!==void 0)&&N(n,_.pitchRotation),n.bool(_.aiStateId!==void 0)&&n.u32(_.aiStateId),c(n,_.curPosition),n.bool(_.unk1_m!==void 0)&&n.u32(_.unk1_m),n.u8(_.skillLevel),c(n,_.newPosition),n.u32(_.skillId),er(n,_.skillOptionData)}var K_="SkillStartNotify";function z_(n,_){let o={};return o.statusEffectData=x(n,_),o.objectId=n.u64(),o.new=n.bool(),o}function Y_(n,_){S(n,_.statusEffectData),n.u64(_.objectId),n.bool(_.new)}var $_="StatusEffectAddNotify";function Q_(n,_){let o={};return o.statusEffectIds=n.array(n.u16(),()=>n.u32()),o.objectId=n.u64(),o.reason=n.u8(),o}function J_(n,_){n.array(_.statusEffectIds,{lenType:"u16"},o=>{n.u32(o)}),n.u64(_.objectId),n.u8(_.reason)}var X_="StatusEffectRemoveNotify";function t_(n,_){let o={};return o.effectInstanceId=n.u32(),o.targetId=n.u64(),o.expirationTick=n.u64(),o}function g_(n,_){n.u32(_.effectInstanceId),n.u64(_.targetId),n.u64(_.expirationTick)}var y_="StatusEffectDurationNotify";function no(n,_){let o={};return o.objectId=n.u64(),o.effectInstanceId=n.u32(),o.characterId=n.u64(),o.value=n.u32(),o}function _o(n,_){n.u64(_.objectId),n.u32(_.effectInstanceId),n.u64(_.characterId),n.u32(_.value)}var oo="StatusEffectSyncDataNotify";function so(n,_){let o={};return o.step=n.u32(),o.unk2_m=n.bool(),o.triggerId=n.u32(),o}function ro(n,_){n.u32(_.step),n.bool(_.unk2_m),n.u32(_.triggerId)}var uo="TriggerBossBattleStatus";function mo(n,_){let o={};return o.packetResultCode=n.u32(),o.triggerId=n.u32(),o.unk0_m=n.u32(),o.involvedPCs=n.array(n.u16(),()=>n.u64()),o}function io(n,_){n.u32(_.packetResultCode),n.u32(_.triggerId),n.u32(_.unk0_m),n.array(_.involvedPCs,{lenType:"u16"},o=>{n.u64(o)})}var ao="TriggerFinishNotify";function eo(n,_){let o={};return o.triggerId=n.u32(),o.triggerSignalType=n.u32(),o.sourceId=n.u64(),o.involvedPCs=n.array(n.u16(),()=>n.u64()),o}function lo(n,_){n.u32(_.triggerId),n.u32(_.triggerSignalType),n.u64(_.sourceId),n.array(_.involvedPCs,{lenType:"u16"},o=>{n.u64(o)})}var ho="TriggerStartNotify";function vo(n,_){let o={};return o.maxHp=e(n,_),o.characterId=n.u64(),o.unk0_m=n.u32(),o.statusEffectDatas=n.array(n.u16(),()=>x(n,_)),o.position=n.u64(),o.curHp=e(n,_),o}function co(n,_){l(n,_.maxHp),n.u64(_.characterId),n.u32(_.unk0_m),n.array(_.statusEffectDatas,{lenType:"u16"},o=>{S(n,o)}),n.u64(_.position),l(n,_.curHp)}var xo="TroopMemberUpdateMinNotify";function So(n,_){let o={};return o.identityGauge1=n.u32(),o.identityGauge2=n.u32(),o.identityGauge3=n.u32(),o.playerId=n.u64(),o}function fo(n,_){n.u32(_.identityGauge1),n.u32(_.identityGauge2),n.u32(_.identityGauge3),n.u64(_.playerId)}var No="IdentityGaugeChangeNotify";function Io(n,_){let o={};return o.objectId=n.u64(),o}function Eo(n,_){n.u64(_.objectId)}var ko="ZoneObjectUnpublishNotify";function lr(n,_){let o={};return o.stackCount=n.u8(),o.target=n.u8(),o.id=n.u32(),o}function hr(n,_){n.u8(_.stackCount),n.u8(_.target),n.u32(_.id)}function Do(n,_){let o={};return o.zoneStatusEffectDataList=n.array(n.u16(),()=>lr(n,_)),o}function Co(n,_){n.array(_.zoneStatusEffectDataList,{lenType:"u16"},o=>{hr(n,o)})}var wo="ZoneStatusEffectAddNotify";function Ro(n,_){let o={};return o.statusEffectId=n.u32(),o}function To(n,_){n.u32(_.statusEffectId)}var Lo="ZoneStatusEffectRemoveNotify";function Ao(n,_){let o={};return o.skillLevel=n.u8(),o.caster=n.u64(),o.skillId=n.u32(),o}function bo(n,_){n.u8(_.skillLevel),n.u64(_.caster),n.u32(_.skillId)}var Po="SkillCastNotify";function Wo(n,_){let o={};return o.objectId=n.u64(),o.stance=n.u8(),o}function Bo(n,_){n.u64(_.objectId),n.u8(_.stance)}var Mo="IdentityStanceChangeNotify";function Fo(n,_){let o={};return o.objectId=n.u64(),o.equipItemDataList=n.array(n.u16(),()=>w(n,_)),o}function jo(n,_){n.u64(_.objectId),n.array(_.equipItemDataList,{lenType:"u16"},o=>{R(n,o)})}var Oo="EquipChangeNotify";function Uo(n,_){let o={};return o.objectId=n.u64(),o.equipLifeToolDataList=n.array(n.u16(),()=>w(n,_)),o}function Zo(n,_){n.u64(_.objectId),n.array(_.equipLifeToolDataList,{lenType:"u16"},o=>{R(n,o)})}var po="EquipLifeToolChangeNotify";function vr(n,_){let o={};return n.bool()&&(o.serialNumber=n.u64(),o.id=n.u32(),o.level=n.u16(),o.slot=n.u16(),o.durability=n.u32(),o.unk1_6_m=n.u32(),o.flag=n.u32(),o.expireTime=I(n),o.lockUpdateTime=I(n)),o}function cr(n,_){n.bool(_.slot!==void 0)&&(n.u64(_.serialNumber),n.u32(_.id),n.u16(_.level),n.u16(_.slot),n.u32(_.durability),n.u32(_.unk1_6_m),n.u32(_.flag),E(n,_.expireTime),E(n,_.lockUpdateTime))}function qo(n,_){let o={};return o.itemDataList=n.array(n.u16(),()=>vr(n,_)),o.storageType=n.u8(),o}function Vo(n,_){n.array([1,20].includes(_.storageType)?_.itemDataList:[],{lenType:"u16"},o=>{cr(n,o)}),n.u8(_.storageType)}var Ho="InitItem";function xr(n,_){let o={};return o.npcId=n.u32(),o.isDead=n.bool(),o}function Sr(n,_){n.u32(_.npcId),n.bool(_.isDead)}function Go(n,_){let o={};return o.raidResult=n.u8(),o.raidId=n.u32(),o.totalTime=n.u64(),o.bossKillDataList=n.array(n.u16(),()=>xr(n,_)),o.endTick=n.u64(),o.startTick=n.u64(),o}function Ko(n,_){n.u8(_.raidResult),n.u32(_.raidId),n.u64(_.totalTime),n.array(_.bossKillDataList,{lenType:"u16"},o=>{Sr(n,o)}),n.u64(_.endTick),n.u64(_.startTick)}var zo="RaidBegin";function Yo(n,_){let o={};return o.zoneInstId=n.u64(),o.zoneId=n.u32(),o.loadComplete=n.bool(),o.completeMembers=n.array(n.u16(),()=>n.u64()),o.totalMembers=n.array(n.u16(),()=>n.u64()),o.firstPCEnterTick=n.u64(),o.zoneLevel=n.u8(),o}function $o(n,_){n.u64(_.zoneInstId),n.u32(_.zoneId),n.bool(_.loadComplete),n.array(_.completeMembers,{lenType:"u16"},o=>{n.u64(o)}),n.array(_.totalMembers,{lenType:"u16"},o=>{n.u64(o)}),n.u64(_.firstPCEnterTick),n.u8(_.zoneLevel)}var Qo="ZoneMemberLoadStatusNotify";function fr(n,_){let o={};return o.position=v(n),o.objectId=n.u64(),o.ownerId=n.u64(),o.skillId=n.u32(),o.skillEffect=n.u32(),o}function Nr(n,_){c(n,_.position),n.u64(_.objectId),n.u64(_.ownerId),n.u32(_.skillId),n.u32(_.skillEffect)}function Jo(n,_){let o={};return o.trapData=fr(n,_),o}function Xo(n,_){Nr(n,_.trapData)}var to="NewTrap";function go(n,_){let o={};return o.skillId=n.u32(),o.caster=n.u64(),o.newDirectionYaw=f(n),o.cancelReason=n.u8(),o.newPosition=v(n),o}function yo(n,_){n.u32(_.skillId),n.u64(_.caster),N(n,_.newDirectionYaw),n.u8(_.cancelReason),c(n,_.newPosition)}var ns="SkillCancelNotify";function _s(n,_){let o={};return o.players=n.array(n.u8(),()=>{let s={};return s.name=n.string(),s.stats=n.array(n.u8(),()=>{let r={};return r.id=n.u8(),r.value=n.u32(),r}),_>=4&&(s.elixirs=n.array(n.u8(),()=>{let r={};return r.slot=n.u8(),r.entries=n.array(n.u8(),()=>{let u={};return u.level=n.u8(),u.id=n.u32(),u}),r})),_>=5&&(s.gems=n.array(n.u8(),()=>{let r={};return r.id=n.u32(),r.skillId=n.u32(),r.type=n.u8(),r.value=n.u16(),r})),s}),o}function os(n,_){n.array(_.players,{lenType:"u8"},o=>{n.string(o.name),n.array(o.stats,{lenType:"u8"},s=>{n.u8(s.id),n.u32(s.value)}),n.array(o.elixirs,{lenType:"u8"},s=>{n.u8(s.slot),n.array(s.entries,{lenType:"u8"},r=>{n.u8(r.level),n.u32(r.id)})}),n.array(o.gems,{lenType:"u8"},s=>{n.u32(s.id),n.u32(s.skillId),n.u8(s.type),n.u16(s.value)})})}var ss="APP_StatApi";var rs=new Map([[0,[nn,g,y]],[1,[sn,_n,on]],[2,[mn,rn,un]],[4,[en,an,dn]],[5,[vn,ln,hn]],[6,[Sn,cn,xn]],[7,[In,fn,Nn]],[8,[Dn,En,kn]],[9,[Ln,Rn,Tn]],[10,[Pn,An,bn]],[11,[Mn,Wn,Bn]],[12,[Un,jn,On]],[13,[qn,Zn,pn]],[14,[Kn,Hn,Gn]],[15,[$n,zn,Yn]],[16,[Xn,Qn,Jn]],[17,[yn,tn,gn]],[18,[o_,n_,__]],[19,[u_,s_,r_]],[20,[a_,m_,i_]],[21,[l_,d_,e_]],[22,[c_,h_,v_]],[23,[f_,x_,S_]],[24,[E_,N_,I_]],[25,[C_,k_,D_]],[26,[T_,w_,R_]],[27,[b_,L_,A_]],[28,[B_,P_,W_]],[29,[j_,M_,F_]],[30,[Z_,O_,U_]],[31,[V_,p_,q_]],[32,[K_,H_,G_]],[34,[$_,z_,Y_]],[35,[X_,Q_,J_]],[36,[y_,t_,g_]],[37,[oo,no,_o]],[38,[uo,so,ro]],[39,[ao,mo,io]],[40,[ho,eo,lo]],[41,[xo,vo,co]],[42,[No,So,fo]],[43,[ko,Io,Eo]],[44,[wo,Do,Co]],[45,[Lo,Ro,To]],[46,[Po,Ao,bo]],[47,[Mo,Wo,Bo]],[48,[Oo,Fo,jo]],[49,[po,Uo,Zo]],[50,[Ho,qo,Vo]],[52,[zo,Go,Ko]],[51,[Qo,Yo,$o]],[53,[to,Jo,Xo]],[54,[ns,go,yo]],[6e4,[ss,_s,os]]]);var A=class{b;o;constructor(_){this.b=_,this.o=0}skip(_=0){this.o+=_}bool(){return this.u8()===1}u8(){return this.b.readUint8(this.o++)}i8(){return this.b.readInt8(this.o++)}u16(){let _=this.b.readUint16LE(this.o);return this.o+=2,_}i16(){let _=this.b.readInt16LE(this.o);return this.o+=2,_}u32(){let _=this.b.readUint32LE(this.o);return this.o+=4,_}i32(){let _=this.b.readInt32LE(this.o);return this.o+=4,_}u48(){let _=this.b.readUIntLE(this.o,6);return this.o+=6,_}i48(){let _=this.b.readIntLE(this.o,6);return this.o+=6,_}f32(){let _=this.b.readFloatLE(this.o);return this.o+=4,_}u64(){let _=this.b.readBigUint64LE(this.o);return this.o+=8,_}i64(){let _=this.b.readBigInt64LE(this.o);return this.o+=8,_}string(_){let o=this.u16();if(!_||o<=_){o=o*2;let s=this.b.toString("utf16le",this.o,this.o+o);return this.o+=o,s}return""}bytes(_=0,o,s){if(o&&_>o)return Buffer.alloc(0);s&&(_=_*s);let r=Buffer.from(this.b.subarray(this.o,this.o+_));return this.o+=_,r}array(_,o,s){return s&&_>s?[]:new Array(_).fill(void 0).map(o)}},b=class{b;o;constructor(_=65535){this.b=Buffer.allocUnsafe(_),this.o=0}get value(){return this.b.subarray(0,this.o)}skip(_=0){this.o+=_}bool(_=!1){return this.u8(_?1:0),_}u8(_=0){this.b.writeUInt8(_,this.o++)}i8(_=0){this.b.writeInt8(_,this.o++)}u16(_=0){this.o=this.b.writeUInt16LE(_,this.o)}i16(_=0){this.o=this.b.writeInt16LE(_,this.o)}u32(_=0){this.o=this.b.writeUInt32LE(_,this.o)}i32(_=0){this.o=this.b.writeInt32LE(_,this.o)}u48(_=0){this.o=this.b.writeUIntLE(_,this.o,6)}i48(_=0){this.o=this.b.writeIntLE(_,this.o,6)}f32(_=0){this.o=this.b.writeFloatLE(_,this.o)}u64(_=0n){this.o=this.b.writeBigUInt64LE(BigInt(_),this.o)}i64(_=0n){this.o=this.b.writeBigInt64LE(BigInt(_),this.o)}string(_="",o){this.u16(_.length),(!o||_.length<=o)&&(this.o+=this.b.write(_,this.o,"utf16le"))}bytes(_=Buffer.alloc(0),o={}){if(o.maxLen!==void 0){let s=o.multiplier??1;if(_.length%s)throw new Error(`Error writing bytes, chunkSize should be a multiple of intut value size, got ${_.length}%${s}`);let r=_.length/s;if(o.maxLen&&r>o.maxLen)throw new Error(`Error writing bytes, input value size exceeded maxLen, got ${r} > ${o.maxLen}`);if(!o.lenType)throw new Error(`Error writing bytes, invalid lenType when writing chunks, got ${o.lenType}`);this[o.lenType](r)}else if(o.length&&_.length!==o.length)throw new Error(`Error writing bytes, input value size doesn't match opts.length, ${_.length} !== ${o.lenType}`);this.o+=_.copy(this.b,this.o)}array(_=[],o,s){if(_===void 0||o.maxLen&&_.length>o.maxLen){this[o.lenType](0);return}this[o.lenType](_.length),_.forEach(s)}};var W=class{time;#_;#o;#n;#s;constructor(..._){if(_.length===5){let[o,s,r,u,m]=_;this.#o=o,this.time=r,this.#_=s,this.#n=u,this.#s=m}else if(_.length===3){let[o,s,r]=_;this.#o=Buffer.alloc(0),this.time=new Date,this.#_=s,this.#n=()=>o,this.#s=r}else throw new Error("[meter-core/logger/parser] - LogEvent<T>: Invalid constructor arguments")}#r;get parsed(){if(!this.#r)try{this.#r=this.#n(new A(this.#o))}catch(_){console.error(`[meter-core/logger/parser] - parsed - ${_}`);return}return this.#r}#u;get serialized(){if(!this.#u)try{if(!this.parsed)return;let _=new b;_.skip(ms),this.#s(_,this.parsed);let o=_.value;o.writeUint16LE(o.length,Er),o.writeUint16LE(this.#_,$),o.writeUintLE(+new Date,us,Q),this.#u=_.value}catch(_){console.error(`[meter-core/logger/parser] - serialized - ${_}`);return}return this.#u}},B=6,Ir=2,Er=0,Y=2,$=Er+Ir,Q=6,us=$+Y,ms=Ir+Y+Q;var wr=require("fs");var P=class{buffer;position;out;constructor(){this.buffer=null,this.position=0,this.out=[]}write(_){for(;_.length>0;){if(this.buffer){if(this.buffer.length<2){let r=this.buffer[0],u=(_[0]<<8)+r;this.buffer=Buffer.alloc(u),this.buffer[0]=r,this.position=1}let s=Math.min(_.length,this.buffer.length-this.position);_.copy(this.buffer,this.position,0,s),this.position+=s,this.position===this.buffer.length&&(this.out.push(this.buffer),this.buffer=null,this.position=0),_=_.subarray(s);continue}if(_.length<2){this.buffer=Buffer.from(_),this.position=_.length;break}let o=_.readUInt16LE(0);if(o===0){this.buffer=null;return}if(o>_.length){this.buffer=Buffer.alloc(o),_.copy(this.buffer),this.position=_.length;break}this.out.push(_.subarray(0,o)),_=_.subarray(o)}}read(){return this.out.shift()}};var Rr=require("fs");var Zs=Gs(require("net")),kr=require("tiny-typed-emitter");var J=(a=>(a[a.CC_Auth=0]="CC_Auth",a[a.CS_Auth=1]="CS_Auth",a[a.CC_Data=2]="CC_Data",a[a.CS_Data=3]="CS_Data",a[a.CC_Logout=4]="CC_Logout",a[a.CC_OnConnect=5]="CC_OnConnect",a[a.CS_SyncDmg=1e3]="CS_SyncDmg",a[a.CS_SyncZone=1001]="CS_SyncZone",a[a.CS_Error=6e4]="CS_Error",a[a.CCS_PingPong=60001]="CCS_PingPong",a))(J||{});function is(n){let _={};return _.version=n.u32(),_.token=n.string(7168),_}function as(n,_){n.u32(_.version),n.string(_.token,7168)}var ds="CC_Auth";function es(n){let _={};return _.opcodes=n.array(n.u16(),()=>n.u16(),3e3),_.xorkey=n.bytes(256),_.migration=n.u16(),_}function ls(n,_){n.array(_.opcodes,{maxLen:3e3,lenType:"u16"},o=>{n.u16(o)}),n.bytes(_.xorkey,{length:256}),n.u16(_.migration)}var hs="CS_Auth";function vs(n){let _={};return _.opcode=n.u16(),_.timestamp=n.bytes(6).readUIntLE(0,6),_.data=n.bytes(n.u16(),65522),_}function cs(n,_){let o=Buffer.alloc(6);o.writeUintLE(_.timestamp,0,6),n.u16(_.opcode),n.bytes(o,{length:6}),n.bytes(_.data,{maxLen:65522,lenType:"u16"})}var xs="CC_Data";function Ss(n){let _={};return _.logId=n.u16(),_.timestamp=n.bytes(6).readUIntLE(0,6),_.data=n.bytes(n.u16(),65522),_}function fs(n,_){let o=Buffer.alloc(6);o.writeUintLE(_.timestamp,0,6),n.u16(_.logId),n.bytes(o,{length:6}),n.bytes(_.data,{maxLen:65522,lenType:"u16"})}var Ns="CS_Data";function Is(n){return{}}function Es(n,_){}var ks="CC_Logout";function Ds(n){let _={};return _.ip=n.string(21),_}function Cs(n,_){n.string(_.ip,21)}var ws="CC_OnConnect";function Rs(n){let _={};return _.table=n.array(n.u8(),()=>({name:n.string(),typeId:n.u16(),dealt:n.i48(),crit:n.u16(),fa:n.u16(),ba:n.u16(),receivedDps:n.i48(),receivedSupp:n.i48(),given:n.i48(),deadDuration:n.u32()})),_.duration=n.u32(),_}function Ts(n,_){n.array(_.table,{lenType:"u8"},o=>{n.string(o.name),n.u16(o.typeId),n.i48(o.dealt),n.u16(o.crit),n.u16(o.fa),n.u16(o.ba),n.i48(o.receivedDps),n.i48(o.receivedSupp),n.i48(o.given),n.u32(o.deadDuration)}),n.u32(_.duration)}var Ls="CS_SyncDmg";function As(n){let _={};return _.isValid=n.bool(),_}function bs(n,_){n.bool(_.isValid)}var Ps="CS_SyncZone";function Ws(n){let _={};return _.code=n.u32(),_.msg=n.string(7168),_}function Bs(n,_){n.u32(_.code),n.string(_.msg,7168)}var Ms="CS_Error";function Fs(n){return{}}function js(n,_){}var Os="CCS_PingPong";var Us=new Map([[0,[ds,is,as]],[1,[hs,es,ls]],[2,[xs,vs,cs]],[3,[Ns,Ss,fs]],[4,[ks,Is,Es]],[5,[ws,Ds,Cs]],[1e3,[Ls,Rs,Ts]],[1001,[Ps,As,bs]],[6e4,[Ms,Ws,Bs]],[60001,[Os,Fs,js]]]);var M=class{#_;#o;#n;constructor(_,o,s){this.#_=_,this.#o=o,this.#n=s}#s;get parsed(){if(!this.#s)try{this.#s=this.#n(new A(this.#_))}catch{return}return this.#s}};var Dr=Gs(require("axios")),ps=(i=>(i[i.OFFLINE=0]="OFFLINE",i[i.NO_GAME=1]="NO_GAME",i[i.CONNECTING=2]="CONNECTING",i[i.AUTHING=3]="AUTHING",i[i.IDLE=4]="IDLE",i[i.SENDING=5]="SENDING",i[i.NO_AUTH=6]="NO_AUTH",i[i.ERROR=7]="ERROR",i))(ps||{}),X=class extends kr.TypedEmitter{socket;serverList=[];token;#_=[];connState=6;reconnectTimeout;gameIdleTimeout;constructor(_){super(),this.socket=new Zs.default.Socket,this.token=_,_&&this.setAuthState(0);let o=new P;this.socket.on("data",s=>{o.write(s);let r;for(;r=o.read();){if(r.length<4||r.readUint16LE(0)!=r.length)continue;let m=r.readUint16LE(2),d=Us.get(m);if(d){let[i,h,a]=d;this.emit(i,new M(Buffer.from(r.subarray(4)),m,h)),this.emit("*",i,new M(Buffer.from(r.subarray(4)),m,h))}}}).on("close",()=>{this.destroy(),[2,3,4,5,0].includes(this.connState)&&(this.setAuthState(0),clearTimeout(this.reconnectTimeout),this.reconnectTimeout=setTimeout(()=>{this.reconnect()},5e3))}).on("error",s=>{console.log(`Conn error ${s}`)}).on("connect",()=>{this.token?(this.setAuthState(3),this.#o(this.prepare("CC_Auth",{token:this.token,version:5}))):(this.setAuthState(6),this.destroy())}),this.reconnect()}destroy(){this.socket.destroy()}reconnect(){[0,1].includes(this.connState)&&(this.setAuthState(2),this.getBestServer().then(_=>{_&&this.connState===2&&(console.info(`[CloudConnection] - Picked node: ${_.ip}:${_.port} with latency ${_.latency}`),this.socket.connect(_.port,_.ip))}))}async getBestServer(){let _=await Dr.default.get("https://nodes-la.herysia.com/nodes");if(!(_.status!==200&&_.status!==304))return Promise.all([..._.data.map(o=>({ip:o,port:8001})),...this.serverList].map(({ip:o,port:s})=>this.getLatency(o,s))).then(o=>o.reduce((s,r)=>s&&s.latency<r.latency?s:r))}getLatency(_,o){return new Promise(s=>{let r=new Zs.default.Socket,u=+new Date;r.setTimeout(5e3),r.on("error",m=>{r.destroy(),s({ip:_,port:o,latency:5e3})}),r.on("timeout",()=>{r.destroy(),s({ip:_,port:o,latency:5e3})}),r.connect(o,_,()=>{r.destroy(),s({ip:_,port:o,latency:+new Date-u})})})}prepare(_,o){let s=J[_],r=Us.get(s);if(r){let[u,m,d]=r;try{let i=new b;i.skip(4),d(i,o);let h=i.value;return h.writeUint16LE(h.length),h.writeUint16LE(s,2),h}catch{}}}send(_,o){let s;(s=this.prepare(_,o))&&this.#_.push(s),this.flushQueue()}async flushQueue(){switch(this.connState){case 0:case 1:break;case 4:this.connState=5;let _,o;for([_,o]of this.#_.entries())if(!await this.#o(o))break;this.#_.splice(0,(_??0)+1),this.connState===5&&(this.connState=4);break;case 6:case 2:case 5:case 3:default:break}}#o(_){return new Promise(o=>{if(!_)return o(!0);this.socket.write(_,s=>{s&&console.log(s),o(!s)})})}failAuth(){this.setAuthState(6),this.destroy()}setError(){this.setAuthState(7),this.destroy()}setAuthState(_){this.connState=_,this.emit("authState",_)}initGameIdleTimeout(){this.gameIdleTimeout?this.gameIdleTimeout.refresh():this.gameIdleTimeout=setTimeout(()=>{console.info("[CloudConnection] - No game packets detected, logging out"),[7,6].includes(this.connState)||this.setAuthState(1),this.destroy()},3e5)}updateAuthToken(_){this.token=_,_&&this.connState===6&&(this.connState=0,this.reconnect())}};var j=class extends Cr.TypedEmitter{},qs=class extends j{#_;#o;#n;#s=[];#r=0;#u=!1;ip;constructor(_,o,s){super(),this.#_=o,this.#n=new X,this.#n.on("CS_Auth",u=>{let m=u.parsed;m&&(this.#s=m.opcodes,this.#_.xorTable=m.xorkey,this.#r=m.migration,this.#n.connState===3&&this.#n.setAuthState(4),this.#n.initGameIdleTimeout())}).on("CS_Data",this.handlePkt.bind(this)).on("CS_Error",u=>{switch(u.parsed?.code){case 0:case 8:this.#n.failAuth();break;case 2:this.#n.setError();break;case 10:this.#n.failAuth();break;case 6e4:this.#u=!0;break;case 5:case 4:break;case 1:case 3:case 6:case 7:case 9:default:break}console.error(`[meter-core/logger] - cloud error (${u.parsed?.code}): ${u.parsed?.msg}`)}).on("CCS_PingPong",()=>{this.#n.send("CCS_PingPong",{})}).on("CS_SyncDmg",u=>{let m=u.parsed;m&&this.emit("syncDmg",m)}).on("CS_SyncZone",u=>{let m=u.parsed;m&&this.emit("syncZone",m)}).on("authState",u=>{this.emit("authState",u)}),s&&(this.#o=(0,wr.createWriteStream)(s,{highWaterMark:0}));let r=Buffer.allocUnsafe(B);r.writeUIntLE(5,0,B),this.#o?.write(r),_.on("*",(u,m,d,i)=>{try{if(this.#n.gameIdleTimeout?.refresh(),this.#u&&m===this.#r&&(this.#n.setAuthState(0),this.#n.destroy(),this.ip&&this.#n.send("CC_OnConnect",{ip:this.ip})),this.#s.includes(m)&&this.#_.xorTable){let h=+new Date,a=this.#_.decrypt(u,m,d,i);this.#n.send("CC_Data",{data:a,opcode:m,timestamp:h})}}catch(h){console.error(h)}})}handlePkt(_){try{let o=_.parsed;if(o){let s=rs.get(o.logId);if(s){let[r,u,m]=s,d=new W(o.data,o.logId,new Date(o.timestamp),i=>u(i,5),m);this.emit(r,d),this.emit("*",r,d),this.appendLog(d)}}}catch(o){console.error(o)}}appendLog(_){this.#o&&_.serialized&&this.#o.write(_.serialized)}onConnect(_){this.ip=_,this.#n.send("CC_OnConnect",{ip:_})}updateAuthToken(_){this.#n.updateAuthToken(_)}forceUpdateAuthState(){[0,1,2,3,4,6,7].includes(this.#n.connState)&&this.emit("authState",this.#n.connState)}},Vs=class extends j{readLogByChunk(_){let o=new P,s=(0,Rr.createReadStream)(_),r=!1,u;s.on("data",m=>{if(u===void 0){if(u=this.readVersion(m),u>5){s.destroy();return}m=m.subarray(B)}o.write(m);let d;for(;d=o.read();)this.readLogChunk(d,u)}).on("end",()=>{r=!0,this.emit("fileEnd","end")}).on("close",()=>{r||this.emit("fileEnd","closed")})}readLogChunk(_,o){try{if(_.length<8)return!1;let s=_.readUIntLE($,Y),r=new Date(_.readUintLE(us,Q)),u=_.subarray(ms),m=rs.get(s);if(m){let[d,i,h]=m,a=new W(u,s,new Date(r),Tr=>i(Tr,o),h);this.emit(d,a),this.emit("*",d,a)}}catch(s){console.error(s)}}readVersion(_){return _.readUintLE(0,B)}};0&&(module.exports={ConnState,LiveLogger,Logger,ReplayLogger});
