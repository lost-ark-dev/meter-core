var jo=Object.create;var he=Object.defineProperty;var Fo=Object.getOwnPropertyDescriptor;var Uo=Object.getOwnPropertyNames;var Vo=Object.getPrototypeOf,Ho=Object.prototype.hasOwnProperty;var qo=(e,t,n)=>t in e?he(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var Go=(e,t)=>{for(var n in t)he(e,n,{get:t[n],enumerable:!0})},zs=(e,t,n,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Uo(t))!Ho.call(e,o)&&o!==n&&he(e,o,{get:()=>t[o],enumerable:!(a=Fo(t,o))||a.enumerable});return e};var Ks=(e,t,n)=>(n=e!=null?jo(Vo(e)):{},zs(t||!e||!e.__esModule?he(n,"default",{value:e,enumerable:!0}):n,e)),Zo=e=>zs(he({},"__esModule",{value:!0}),e);var se=(e,t,n)=>(qo(e,typeof t!="symbol"?t+"":t,n),n),Qe=(e,t,n)=>{if(!t.has(e))throw TypeError("Cannot "+n)};var P=(e,t,n)=>(Qe(e,t,"read from private field"),n?n.call(e):t.get(e)),oe=(e,t,n)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,n)},Pe=(e,t,n,a)=>(Qe(e,t,"write to private field"),a?a.call(e,n):t.set(e,n),n);var ie=(e,t,n)=>(Qe(e,t,"access private method"),n);var xi={};Go(xi,{Parser:()=>qs});module.exports=Zo(xi);var Oo=require("tiny-typed-emitter");var z=(c=>(c[c.none=0]="none",c[c.slot=1]="slot",c[c.stat=2]="stat",c[c.ability_point=3]="ability_point",c[c.combat_effect=4]="combat_effect",c[c.skill_damage=5]="skill_damage",c[c.skill_critical_ratio=6]="skill_critical_ratio",c[c.skill_critical_damage=7]="skill_critical_damage",c[c.skill_penetration=8]="skill_penetration",c[c.npc_grade_less_damage=9]="npc_grade_less_damage",c[c.npc_grade_less_critical_ratio=10]="npc_grade_less_critical_ratio",c[c.npc_grade_less_critical_damage=11]="npc_grade_less_critical_damage",c[c.npc_grade_less_penetration=12]="npc_grade_less_penetration",c[c.npc_grade_greater_damage=13]="npc_grade_greater_damage",c[c.npc_grade_greater_critical_ratio=14]="npc_grade_greater_critical_ratio",c[c.npc_grade_greater_critical_damage=15]="npc_grade_greater_critical_damage",c[c.npc_grade_greater_penetration=16]="npc_grade_greater_penetration",c[c.npc_species_damage=17]="npc_species_damage",c[c.npc_species_critical_ratio=18]="npc_species_critical_ratio",c[c.npc_species_critical_damage=19]="npc_species_critical_damage",c[c.npc_species_penetration=20]="npc_species_penetration",c[c.npc_attr_damage=21]="npc_attr_damage",c[c.npc_attr_critical_ratio=22]="npc_attr_critical_ratio",c[c.npc_attr_critical_damage=23]="npc_attr_critical_damage",c[c.npc_attr_penetration=24]="npc_attr_penetration",c[c.mana_reduction=25]="mana_reduction",c[c.skill_mana_reduction=26]="skill_mana_reduction",c[c.skill_cooldown_reduction=27]="skill_cooldown_reduction",c[c.ability_feature=28]="ability_feature",c[c.class_option=29]="class_option",c[c.ability_point_passive=30]="ability_point_passive",c[c.instrument=31]="instrument",c[c.skill_feature=32]="skill_feature",c[c.npc_adaptation=33]="npc_adaptation",c[c.skill_group_damage=34]="skill_group_damage",c[c.skill_group_cooldown_reduction=35]="skill_group_cooldown_reduction",c[c.skill_level=36]="skill_level",c[c.skill_feature_level=37]="skill_feature_level",c[c.life_casting_speed=38]="life_casting_speed",c[c.life_casting_tier=39]="life_casting_tier",c[c.life_bonus_type_success=40]="life_bonus_type_success",c[c.life_bonus_type_extra=41]="life_bonus_type_extra",c[c.life_bonus_type_skill_bonus=42]="life_bonus_type_skill_bonus",c[c.life_bonus_type_minigame_perfect=43]="life_bonus_type_minigame_perfect",c[c.life_durability_bonus=44]="life_durability_bonus",c[c.life_mini_game_difficulty=45]="life_mini_game_difficulty",c[c.combat_effect_cooldown_reduction=46]="combat_effect_cooldown_reduction",c[c.skill_damage_addend=47]="skill_damage_addend",c[c.awakening_usable_count_addend=48]="awakening_usable_count_addend",c[c.battle_item_heal=49]="battle_item_heal",c[c.party_heal=50]="party_heal",c[c.party_shield=51]="party_shield",c[c.identity_gauge=52]="identity_gauge",c[c.attack_power_amplify_addend=53]="attack_power_amplify_addend",c[c.attack_power_amplify_multiplier=54]="attack_power_amplify_multiplier",c[c.not_in_party_damage=55]="not_in_party_damage",c[c.skill_effect_group_set_damage=56]="skill_effect_group_set_damage",c))(z||{});var Re=(v=>(v[v.none=0]="none",v[v.modify_damage=1]="modify_damage",v[v.modify_final_damage=2]="modify_final_damage",v[v.modify_critical_ratio=3]="modify_critical_ratio",v[v.modify_critical_multiplier=4]="modify_critical_multiplier",v[v.modify_penetration=5]="modify_penetration",v[v.modify_penetration_when_critical=6]="modify_penetration_when_critical",v[v.exec_active_effect_when_damage=7]="exec_active_effect_when_damage",v[v.exec_active_effect_when_critical=8]="exec_active_effect_when_critical",v[v.exec_reactive_effect_when_miss=9]="exec_reactive_effect_when_miss",v[v.exec_reactive_effect_when_damage=10]="exec_reactive_effect_when_damage",v[v.exec_reactive_effect_when_critical=11]="exec_reactive_effect_when_critical",v[v.exec_after_effect=12]="exec_after_effect",v[v.exec_after_skill=13]="exec_after_skill",v[v.apply_heal=14]="apply_heal",v[v.modify_reactive_damage=15]="modify_reactive_damage",v[v.modify_damage_shield_multiplier=16]="modify_damage_shield_multiplier",v[v.exec_active_effect_when_kill=17]="exec_active_effect_when_kill",v[v.exec_start_skill=18]="exec_start_skill",v[v.modify_penetration_addend=19]="modify_penetration_addend",v[v.modify_penetration_addend_when_critical=20]="modify_penetration_addend_when_critical",v[v.modify_reactive_critical_multiplier=21]="modify_reactive_critical_multiplier",v[v.modify_damage_when_critical=22]="modify_damage_when_critical",v[v.modify_paralyzation_point=23]="modify_paralyzation_point",v[v.exec_when_counter=24]="exec_when_counter",v[v.exec_when_be_killed=25]="exec_when_be_killed",v))(Re||{});var Je=(p=>(p[p.none=0]="none",p[p.underling=1]="underling",p[p.normal=2]="normal",p[p.elite=3]="elite",p[p.named=4]="named",p[p.seed=5]="seed",p[p.boss=6]="boss",p[p.raid=7]="raid",p[p.lucky=8]="lucky",p[p.epic_raid=9]="epic_raid",p[p.commander=10]="commander",p))(Je||{});var we=(n=>(n[n.absolute=0]="absolute",n[n.relative=1]="relative",n))(we||{});var ge=(_=>(_[_.none=0]="none",_[_.enable_notify=1]="enable_notify",_[_.enable_dir_change=2]="enable_dir_change",_[_.change_move_dist=3]="change_move_dist",_[_.change_layer=4]="change_layer",_[_.change_stage_speed=5]="change_stage_speed",_[_.change_stage_collision=6]="change_stage_collision",_[_.change_max_target=7]="change_max_target",_[_.change_area_range=8]="change_area_range",_[_.change_area_angle=9]="change_area_angle",_[_.change_cost=10]="change_cost",_[_.recover_cost=11]="recover_cost",_[_.recover_used_cost=12]="recover_used_cost",_[_.reduce_default_cooldown=13]="reduce_default_cooldown",_[_.reduce_active_cooldown=14]="reduce_active_cooldown",_[_.enable_stage_buff=15]="enable_stage_buff",_[_.add_stage_buff=16]="add_stage_buff",_[_.change_buff_area_range=17]="change_buff_area_range",_[_.change_buff_duration=18]="change_buff_duration",_[_.change_buff_stat=19]="change_buff_stat",_[_.change_buff_stack=20]="change_buff_stack",_[_.change_buff_param=21]="change_buff_param",_[_.change_buff_expired_action=22]="change_buff_expired_action",_[_.change_chain_ratio=23]="change_chain_ratio",_[_.change_abnormal=24]="change_abnormal",_[_.change_abnormal_ratio=25]="change_abnormal_ratio",_[_.change_dam_attr=26]="change_dam_attr",_[_.change_dam_value=27]="change_dam_value",_[_.change_dam_coefficient=28]="change_dam_coefficient",_[_.change_dam_critical=29]="change_dam_critical",_[_.change_dam_critical_rate=30]="change_dam_critical_rate",_[_.change_attack_stage_speed=31]="change_attack_stage_speed",_[_.change_stack_charge_time=32]="change_stack_charge_time",_[_.change_stack_max_count=33]="change_stack_max_count",_[_.change_targeting=34]="change_targeting",_[_.change_min_range=35]="change_min_range",_[_.change_max_range=36]="change_max_range",_[_.change_push_info=37]="change_push_info",_[_.change_parts_attack_attr=38]="change_parts_attack_attr",_[_.change_skill_chain_info=39]="change_skill_chain_info",_[_.change_skill_chain_delay=40]="change_skill_chain_delay",_[_.change_behit_move_info=41]="change_behit_move_info",_[_.add_buff_stat=42]="add_buff_stat",_[_.add_chain_skill_effect=43]="add_chain_skill_effect",_[_.remove_chain_skill_effect=44]="remove_chain_skill_effect",_[_.add_chain_combat_effect=45]="add_chain_combat_effect",_[_.remove_chain_combat_effect=46]="remove_chain_combat_effect",_[_.change_skill_effect_bonus=47]="change_skill_effect_bonus",_[_.change_skill_effect_ai_point=48]="change_skill_effect_ai_point",_[_.change_dam_addend=49]="change_dam_addend",_[_.change_hitted=50]="change_hitted",_[_.change_skill_move_speed=51]="change_skill_move_speed",_[_.add_skill_buff=52]="add_skill_buff",_[_.change_skill_bonus=53]="change_skill_bonus",_[_.change_skill_normal_info=54]="change_skill_normal_info",_[_.change_skill_invisibility=55]="change_skill_invisibility",_[_.change_skill_constraint=56]="change_skill_constraint",_[_.change_skill_book_type=57]="change_skill_book_type",_[_.change_projection_skill_effect_id=58]="change_projection_skill_effect_id",_[_.change_push_pvp_info=59]="change_push_pvp_info",_[_.change_forced_critical=60]="change_forced_critical",_[_.change_instance_skill_effect_info=61]="change_instance_skill_effect_info",_[_.change_skill_start_stage=62]="change_skill_start_stage",_[_.change_skill_effect_dir_target=63]="change_skill_effect_dir_target",_[_.change_stage_dir_rate=64]="change_stage_dir_rate",_[_.change_projection=65]="change_projection",_[_.change_skill_view=66]="change_skill_view",_[_.change_projectile_speed=67]="change_projectile_speed",_[_.change_projectile_dist=68]="change_projectile_dist",_[_.change_projectile_resourcescale=69]="change_projectile_resourcescale",_[_.change_projectile_max_target_hit_count=70]="change_projectile_max_target_hit_count",_[_.change_summon_trap_lifetime=71]="change_summon_trap_lifetime",_[_.change_summon_trap_destroy_delaytime=72]="change_summon_trap_destroy_delaytime",_[_.change_summon_trap_react_info=73]="change_summon_trap_react_info",_[_.change_summon_trap_invoke_effect=74]="change_summon_trap_invoke_effect",_[_.change_summon_trap_count=75]="change_summon_trap_count",_[_.enable_identity_event=76]="enable_identity_event",_[_.change_identity_proc_value=77]="change_identity_proc_value",_[_.change_skill_effect_identity_proc_info=78]="change_skill_effect_identity_proc_info",_[_.change_identity_proc_pvp_value=79]="change_identity_proc_pvp_value",_[_.change_skill_effect_identity_proc_pvp_info=80]="change_skill_effect_identity_proc_pvp_info",_[_.change_skill_effect_identity_proc_replace_info=81]="change_skill_effect_identity_proc_replace_info",_[_.change_skill_effect_identity_proc_replace_pvp_info=82]="change_skill_effect_identity_proc_replace_pvp_info",_[_.swap_chain_skill_effect=83]="swap_chain_skill_effect",_[_.swap_chain_combat_effect=84]="swap_chain_combat_effect",_[_.change_charge_scale=85]="change_charge_scale",_[_.change_summon_npc_id=86]="change_summon_npc_id",_[_.change_summon_npc_sight_range=87]="change_summon_npc_sight_range",_[_.change_summon_npc_pursuit_range=88]="change_summon_npc_pursuit_range",_[_.change_summon_npc_walk_movespeed=89]="change_summon_npc_walk_movespeed",_[_.change_summon_npc_battle_movespeed=90]="change_summon_npc_battle_movespeed",_[_.change_summon_npc_life_time=91]="change_summon_npc_life_time",_[_.change_summon_npc_ai_index=92]="change_summon_npc_ai_index",_[_.change_summon_npc_invincible_duration=93]="change_summon_npc_invincible_duration",_[_.change_summon_npc_acquire_identity=94]="change_summon_npc_acquire_identity",_[_.change_summon_npc_skill_id=95]="change_summon_npc_skill_id",_[_.change_summon_npc_die_skill_id=96]="change_summon_npc_die_skill_id",_[_.change_summon_npc_destroy_skill_id=97]="change_summon_npc_destroy_skill_id",_[_.change_summon_npc_spawn_buff_id=98]="change_summon_npc_spawn_buff_id",_[_.change_summon_npc_count=99]="change_summon_npc_count",_[_.change_summon_npc_stat=100]="change_summon_npc_stat",_[_.change_summon_npc_threat_point=101]="change_summon_npc_threat_point",_[_.change_summon_npc_skill_usable_tick=102]="change_summon_npc_skill_usable_tick",_[_.change_summon_npc_skill_use_order=103]="change_summon_npc_skill_use_order",_[_.change_combat_effect_arg=104]="change_combat_effect_arg",_[_.change_skill_effect_cost=105]="change_skill_effect_cost",_[_.change_accumulate_dam_rate=106]="change_accumulate_dam_rate",_[_.change_projectile_bank_data_addend=107]="change_projectile_bank_data_addend",_[_.change_identity_category=108]="change_identity_category",_[_.change_skill_slot_visible_effect=109]="change_skill_slot_visible_effect",_[_.change_attack_mask=110]="change_attack_mask",_[_.change_aim_target_max_range=111]="change_aim_target_max_range",_))(ge||{}),re=(r=>(r[r.none=0]="none",r[r.hp=1]="hp",r[r.mp=2]="mp",r[r.str=3]="str",r[r.agi=4]="agi",r[r.int=5]="int",r[r.con=6]="con",r[r.str_x=7]="str_x",r[r.agi_x=8]="agi_x",r[r.int_x=9]="int_x",r[r.con_x=10]="con_x",r[r.criticalhit=15]="criticalhit",r[r.specialty=16]="specialty",r[r.oppression=17]="oppression",r[r.rapidity=18]="rapidity",r[r.endurance=19]="endurance",r[r.mastery=20]="mastery",r[r.criticalhit_x=21]="criticalhit_x",r[r.specialty_x=22]="specialty_x",r[r.oppression_x=23]="oppression_x",r[r.rapidity_x=24]="rapidity_x",r[r.endurance_x=25]="endurance_x",r[r.mastery_x=26]="mastery_x",r[r.max_hp=27]="max_hp",r[r.max_mp=28]="max_mp",r[r.max_hp_x=29]="max_hp_x",r[r.max_mp_x=30]="max_mp_x",r[r.max_hp_x_x=31]="max_hp_x_x",r[r.max_mp_x_x=32]="max_mp_x_x",r[r.normal_hp_recovery=33]="normal_hp_recovery",r[r.combat_hp_recovery=34]="combat_hp_recovery",r[r.normal_hp_recovery_rate=35]="normal_hp_recovery_rate",r[r.combat_hp_recovery_rate=36]="combat_hp_recovery_rate",r[r.normal_mp_recovery=37]="normal_mp_recovery",r[r.combat_mp_recovery=38]="combat_mp_recovery",r[r.normal_mp_recovery_rate=39]="normal_mp_recovery_rate",r[r.combat_mp_recovery_rate=40]="combat_mp_recovery_rate",r[r.self_recovery_rate=41]="self_recovery_rate",r[r.drain_hp_dam_rate=42]="drain_hp_dam_rate",r[r.drain_mp_dam_rate=43]="drain_mp_dam_rate",r[r.dam_reflection_rate=44]="dam_reflection_rate",r[r.char_attack_dam=47]="char_attack_dam",r[r.skill_effect_dam_addend=48]="skill_effect_dam_addend",r[r.attack_power_rate=49]="attack_power_rate",r[r.skill_damage_rate=50]="skill_damage_rate",r[r.attack_power_rate_x=51]="attack_power_rate_x",r[r.skill_damage_rate_x=52]="skill_damage_rate_x",r[r.cooldown_reduction=53]="cooldown_reduction",r[r.paralyzation_point_rate=54]="paralyzation_point_rate",r[r.def=55]="def",r[r.res=56]="res",r[r.def_x=57]="def_x",r[r.res_x=58]="res_x",r[r.def_x_x=59]="def_x_x",r[r.res_x_x=60]="res_x_x",r[r.critical_physical_inc_rate=65]="critical_physical_inc_rate",r[r.critical_magical_inc_rate=66]="critical_magical_inc_rate",r[r.def_pen_rate=67]="def_pen_rate",r[r.res_pen_rate=68]="res_pen_rate",r[r.physical_inc_rate=69]="physical_inc_rate",r[r.magical_inc_rate=70]="magical_inc_rate",r[r.self_shield_rate=71]="self_shield_rate",r[r.hit_rate=72]="hit_rate",r[r.dodge_rate=73]="dodge_rate",r[r.critical_hit_rate=74]="critical_hit_rate",r[r.critical_res_rate=75]="critical_res_rate",r[r.critical_dam_rate=76]="critical_dam_rate",r[r.attack_speed=77]="attack_speed",r[r.attack_speed_rate=78]="attack_speed_rate",r[r.move_speed=79]="move_speed",r[r.move_speed_rate=80]="move_speed_rate",r[r.prop_move_speed=81]="prop_move_speed",r[r.prop_move_speed_rate=82]="prop_move_speed_rate",r[r.vehicle_move_speed=83]="vehicle_move_speed",r[r.vehicle_move_speed_rate=84]="vehicle_move_speed_rate",r[r.ship_move_speed=85]="ship_move_speed",r[r.ship_move_speed_rate=86]="ship_move_speed_rate",r[r.fire_dam_rate=87]="fire_dam_rate",r[r.ice_dam_rate=88]="ice_dam_rate",r[r.electricity_dam_rate=89]="electricity_dam_rate",r[r.earth_dam_rate=91]="earth_dam_rate",r[r.dark_dam_rate=92]="dark_dam_rate",r[r.holy_dam_rate=93]="holy_dam_rate",r[r.elements_dam_rate=94]="elements_dam_rate",r[r.fire_res_rate=95]="fire_res_rate",r[r.ice_res_rate=96]="ice_res_rate",r[r.electricity_res_rate=97]="electricity_res_rate",r[r.earth_res_rate=99]="earth_res_rate",r[r.dark_res_rate=100]="dark_res_rate",r[r.holy_res_rate=101]="holy_res_rate",r[r.elements_res_rate=102]="elements_res_rate",r[r.self_cc_time_rate=105]="self_cc_time_rate",r[r.enemy_cc_time_rate=106]="enemy_cc_time_rate",r[r.identity_value1=107]="identity_value1",r[r.identity_value2=108]="identity_value2",r[r.identity_value3=109]="identity_value3",r[r.awakening_dam_rate=110]="awakening_dam_rate",r[r.item_drop_rate=111]="item_drop_rate",r[r.gold_rate=112]="gold_rate",r[r.exp_rate=113]="exp_rate",r[r.attack_power_addend=123]="attack_power_addend",r[r.attack_power_addend_2=124]="attack_power_addend_2",r[r.npc_species_humanoid_dam_rate=125]="npc_species_humanoid_dam_rate",r[r.npc_species_devil_dam_rate=126]="npc_species_devil_dam_rate",r[r.npc_species_substance_dam_rate=127]="npc_species_substance_dam_rate",r[r.npc_species_undead_dam_rate=128]="npc_species_undead_dam_rate",r[r.npc_species_plant_dam_rate=129]="npc_species_plant_dam_rate",r[r.npc_species_insect_dam_rate=130]="npc_species_insect_dam_rate",r[r.npc_species_spirit_dam_rate=131]="npc_species_spirit_dam_rate",r[r.npc_species_wild_beast_dam_rate=132]="npc_species_wild_beast_dam_rate",r[r.npc_species_mechanic_dam_rate=133]="npc_species_mechanic_dam_rate",r[r.npc_species_ancient_dam_rate=134]="npc_species_ancient_dam_rate",r[r.npc_species_god_dam_rate=135]="npc_species_god_dam_rate",r[r.npc_species_archfiend_dam_rate=136]="npc_species_archfiend_dam_rate",r[r.vitality=137]="vitality",r[r.ship_booter_speed=138]="ship_booter_speed",r[r.ship_wreck_speed_rate=139]="ship_wreck_speed_rate",r[r.island_speed_rate=140]="island_speed_rate",r[r.attack_power_sub_rate_1=141]="attack_power_sub_rate_1",r[r.attack_power_sub_rate_2=142]="attack_power_sub_rate_2",r[r.physical_inc_sub_rate_1=143]="physical_inc_sub_rate_1",r[r.physical_inc_sub_rate_2=144]="physical_inc_sub_rate_2",r[r.magical_inc_sub_rate_1=145]="magical_inc_sub_rate_1",r[r.magical_inc_sub_rate_2=146]="magical_inc_sub_rate_2",r[r.skill_damage_sub_rate_1=147]="skill_damage_sub_rate_1",r[r.skill_damage_sub_rate_2=148]="skill_damage_sub_rate_2",r[r.resource_recovery_rate=149]="resource_recovery_rate",r[r.weapon_dam=151]="weapon_dam",r[r.weapon_dam_x=152]="weapon_dam_x",r))(re||{});var Se=(s=>(s[s.normal=0]="normal",s[s.hard=1]="hard",s[s.hellchaos=2]="hellchaos",s[s.challenge=3]="challenge",s[s.special=4]="special",s[s.extreme=5]="extreme",s))(Se||{});var Ys=require("tiny-typed-emitter");var V,ve,j,Ie,Xe,_e,Ce,ye=class extends Ys.TypedEmitter{constructor(n,a,o=!0,i=!!process.env.DEV){super();oe(this,Ie);oe(this,_e);se(this,"PartyStatusEffectRegistry");se(this,"LocalStatusEffectRegistry");oe(this,V,void 0);oe(this,ve,void 0);oe(this,j,void 0);se(this,"debug");se(this,"trace",!1);this.PartyStatusEffectRegistry=new Map,this.LocalStatusEffectRegistry=new Map,this.debug=i,Pe(this,V,n),Pe(this,ve,a),Pe(this,j,o)}getStatusEffectRegistryForPlayer(n,a){let o=this.getPlayerRegistry(a),i=o.get(n);if(i)return i;let s=new Map;return o.set(n,s),s}hasStatusEffectRegistryForPlayer(n,a){return this.getPlayerRegistry(a).has(n)}getPlayerRegistry(n){switch(n){case 1:return this.LocalStatusEffectRegistry;case 0:return this.PartyStatusEffectRegistry;default:break}return this.LocalStatusEffectRegistry}RemoveLocalObject(n,a){let o=this.LocalStatusEffectRegistry.get(n);if(o)for(let[,i]of o)this.RemoveStatusEffect(n,i.instanceId,1,void 0,a);this.LocalStatusEffectRegistry.delete(n)}RemovePartyObject(n,a){let o=this.PartyStatusEffectRegistry.get(n);if(o)for(let[,i]of o)this.RemoveStatusEffect(n,i.instanceId,0,void 0,a);this.PartyStatusEffectRegistry.delete(n)}RegisterStatusEffect(n){let a=this.getStatusEffectRegistryForPlayer(n.targetId,n.type),o=a.get(n.instanceId);o?P(this,j)&&o.expirationTimer&&(clearTimeout(o.expirationTimer),o.expirationTimer=void 0):n.effectType===0&&this.emit("shieldApplied",n),a.set(n.instanceId,n),this.SetupStatusEffectTimeout(n)}HasAnyStatusEffect(n,a,o,i){if(!this.hasStatusEffectRegistryForPlayer(n,a))return!1;let s=this.getStatusEffectRegistryForPlayer(n,a);for(let[,u]of s)if(!(!P(this,j)&&!this.IsReplayStatusEffectValidElseRemove(u,i))){for(let m of o)if(m===u.statusEffectId)return!0}return!1}IsReplayStatusEffectValidElseRemove(n,a){return n.expireAt===void 0||n.expireAt.getTime()>a.getTime()?!0:(this.ExpireStatusEffectByTimeout(n),!1)}HasAnyStatusEffectFromParty(n,a,o,i,s){if(!this.hasStatusEffectRegistryForPlayer(n,a))return!1;let u=this.getStatusEffectRegistryForPlayer(n,a);for(let[,m]of u)if(!(!P(this,j)&&!this.IsReplayStatusEffectValidElseRemove(m,s))&&i.includes(m.statusEffectId)){let d=P(this,V).getPartyIdFromEntityId(m.sourceId);if(this.ValidForWholeRaid(m))return d!==void 0;if(d===o)return!0}return!1}RemoveStatusEffect(n,a,o,i,s){if(!this.hasStatusEffectRegistryForPlayer(n,o))return;let u=this.getStatusEffectRegistryForPlayer(n,o),m=u.get(a);return m&&(P(this,j)&&(clearTimeout(m.expirationTimer),m.expirationTimer=void 0),u.delete(a),i===4&&(P(this,j)||this.IsReplayStatusEffectValidElseRemove(m,s))&&this.RegisterValueUpdate(m,m.value,0)),m}GetStatusEffects(n,a,o,i){if(!this.hasStatusEffectRegistryForPlayer(n,a))return[];let s=this.getStatusEffectRegistryForPlayer(n,a);if(!P(this,j))for(let[,m]of s)this.IsReplayStatusEffectValidElseRemove(m,o);let u=[...s.values()];return i!==void 0?u.filter((m,d,f)=>m.sourceId===i):u}GetStatusEffectsFromParty(n,a,o,i){if(!this.hasStatusEffectRegistryForPlayer(n,a))return[];let s=this.getStatusEffectRegistryForPlayer(n,a);if(!P(this,j))for(let[,u]of s)this.IsReplayStatusEffectValidElseRemove(u,i);return[...s.values()].filter(u=>this.ValidForWholeRaid(u)?P(this,V).getPartyIdFromEntityId(u.sourceId)!==void 0:o===P(this,V).getPartyIdFromEntityId(u.sourceId))}Clear(n){let a=0;for(let[,i]of this.LocalStatusEffectRegistry){for(let[,s]of i)this.RemoveStatusEffect(s.targetId,s.instanceId,s.type,void 0,n);a+=i.size}let o=0;for(let[,i]of this.PartyStatusEffectRegistry){for(let[,s]of i)this.RemoveStatusEffect(s.targetId,s.instanceId,s.type,void 0,n);o+=i.size}this.trace&&console.log("On Clear SE in local",a,"in party",o),this.LocalStatusEffectRegistry.clear(),this.PartyStatusEffectRegistry.clear()}UpdateDuration(n,a,o,i){let u=this.getStatusEffectRegistryForPlayer(a,i).get(n);if(u){let m=o-u.timestamp;if(P(this,j)&&u.expirationTimer&&(this.trace&&console.log("Clearing timeout for",u.instanceId,"because of duration change"),clearTimeout(u.expirationTimer),u.expirationTimer=void 0),u.expireAt){let d=u.expireAt.getTime()+Number(m),f=d-u.pktTime.getTime();f>0?(this.trace&&console.log("Extending duration by",m,"ms","New timeout delay",f,"from",u.expireAt.toISOString(),"to",new Date(d).toISOString()),P(this,j)&&(u.expirationTimer=setTimeout(this.ExpireStatusEffectByTimeout.bind(this,u),f)),u.expireAt=new Date(d),u.timestamp=o):u.expireAt=void 0}}else this.debug&&console.error("Tried to update duration for SE with instanceId",n," on target",a,"but where is no such SE registered")}SyncStatusEffect(n,a,o,i,s){let u=ie(this,_e,Ce).call(this,a,s),m=u?0:1,d=u?a:o;if(!d)return;let p=this.getStatusEffectRegistryForPlayer(d,m).get(n);if(!p)return;let E=p.value;p.value=i,this.RegisterValueUpdate(p,E,i)}ValidForWholeRaid(n){return(n.buffCategory===3||n.buffCategory===1||n.buffCategory===2)&&n.category===1&&n.showType===1}SetupStatusEffectTimeout(n){if(n.expirationDelay>0&&n.expirationDelay<604800){let a=n.pktTime.getTime()>n.occurTime.getTime()?n.pktTime:n.occurTime,o=Math.ceil(n.expirationDelay*1e3),i=a.getTime()+o+ye.TIMEOUT_DELAY_MS-n.pktTime.getTime();n.expireAt=new Date(n.pktTime.getTime()+i),this.trace&&console.log("Setting up statuseffect expiration time for",n.name,n.instanceId,"to",n.expireAt.toISOString(),"with delay",i),P(this,j)&&(n.expirationTimer=setTimeout(this.ExpireStatusEffectByTimeout.bind(this,n),i))}}ExpireStatusEffectByTimeout(n){this.debug&&console.error("Triggered timeout on",n.name,"with iid",n.instanceId),this.RemoveStatusEffect(n.targetId,n.instanceId,n.type,void 0,new Date)}RegisterValueUpdate(n,a,o){n.effectType===0&&this.emit("shieldChanged",n,a,o)}newPC(n,a,o){let i=ie(this,_e,Ce).call(this,n.pcStruct.characterId,a);i?this.RemovePartyObject(n.pcStruct.characterId,o):this.RemoveLocalObject(n.pcStruct.playerId,o);for(let s of n.pcStruct.statusEffectDatas)this.RegisterStatusEffect(this.buildStatusEffect(s,i?n.pcStruct.characterId:n.pcStruct.playerId,s.sourceId,i?0:1,o))}buildStatusEffect(n,a,o,i,s){let u=n.value?n.value.readUInt32LE():0,m=n.value?n.value.readUInt32LE(8):0,d=u<m?u:m,f=0,p=0,E=0,H="Unknown",w=1,W=P(this,ve).skillBuff.get(n.statusEffectId);if(W){switch(H=W.name,W.category){case"debuff":f=1;break}switch(W.buffcategory){case"bracelet":p=1;break;case"etc":p=2;break;case"battleitem":p=3;break}switch(W.iconshowtype){case"all":E=1;break}switch(W.type){case"shield":w=0;break}}return{instanceId:n.effectInstanceId,sourceId:o,statusEffectId:n.statusEffectId,targetId:a,type:i,dbTarget:W?.target??"none",value:d,buffCategory:p,category:f,showType:E,expirationDelay:n.totalTime,expirationTimer:void 0,timestamp:n.endTick,expireAt:void 0,occurTime:n.occurTime,name:H,pktTime:s,effectType:w,stackCount:n.stackCount}}getStatusEffects(n,a,o,i){let s=[],u=[],m=ie(this,Ie,Xe).call(this,n,o),d=this.GetStatusEffects(m?n.characterId:n.entityId,m?0:1,i,void 0);for(let f of d)u.push([f.statusEffectId,f.sourceId,f.stackCount]);if(a){let f=ie(this,Ie,Xe).call(this,a,o),p=P(this,V).isEntityInParty(n.entityId),E=p?P(this,V).getPartyIdFromEntityId(n.entityId):void 0,H=p&&E?this.GetStatusEffectsFromParty(f?a.characterId:a.entityId,f?0:1,E,i):this.GetStatusEffects(f?a.characterId:a.entityId,f?0:1,i,n.entityId);for(let w of H)w.type===1&&w.category===1&&w.sourceId!==n.entityId&&w.dbTarget==="self"||s.push([w.statusEffectId,w.sourceId,w.stackCount])}return[u,s]}},pe=ye;V=new WeakMap,ve=new WeakMap,j=new WeakMap,Ie=new WeakSet,Xe=function(n,a){if(n.entityType!==1)return!1;let o=n;return ie(this,_e,Ce).call(this,o.characterId,a)},_e=new WeakSet,Ce=function(n,a){let o=P(this,V).isCharacterInParty(a),i=P(this,V).isCharacterInParty(n);if(o){if(!i||n===a)return!1;let s=P(this,V).getPartyIdFromCharacterId(a),u=P(this,V).getPartyIdFromCharacterId(n);return s===u}return!1},se(pe,"TIMEOUT_DELAY_MS",1e3);var Le=class{#e;#o;#a;#i;entities=new Map;localPlayer;constructor(t,n,a,o){this.#e=t,this.#o=n,this.#a=a,this.#i=o,this.localPlayer={entityId:0n,entityType:1,name:"You",class:0,gearLevel:0,characterId:0n,stance:0,stats:new Map,skills:new Map,items:{lifeToolList:new Map,equipList:new Map}}}processNewPC(t){let n=t.parsed;if(!n)return;let a={entityId:n.pcStruct.playerId,entityType:1,name:n.pcStruct.name,class:n.pcStruct.classId,gearLevel:n.pcStruct.maxItemLevel,characterId:n.pcStruct.characterId,stance:0,stats:this.#i.getStatPairMap(n.pcStruct.statPair),skills:new Map,items:{lifeToolList:new Map,equipList:new Map}};this.entities.set(a.entityId,a);let o=this.#e.getEntityId(a.characterId);return o&&this.#o.changeEntityId(o,n.pcStruct.playerId),this.#e.addMapping(a.characterId,a.entityId),this.#o.completeEntry(a.characterId,a.entityId),this.#a.newPC(n,this.localPlayer.characterId,t.time),a.itemSet=this.getPlayerSetOptions(n.pcStruct.equipItemDataList),n.pcStruct.equipItemDataList.forEach(i=>{i.id!==void 0&&i.slot!==void 0&&a.items.equipList.set(i.slot,i.id)}),n.pcStruct.equipLifeToolDataList.forEach(i=>{i.id!==void 0&&i.slot!==void 0&&a.items.lifeToolList.set(i.slot,i.id)}),a}processInitEnv(t){let n=t.parsed;if(!n)return;this.localPlayer.entityId!==0n&&this.#o.changeEntityId(this.localPlayer.entityId,n.playerId),this.entities.clear();let a={entityId:n.playerId,entityType:1,name:this.localPlayer.name,class:this.localPlayer.class,gearLevel:this.localPlayer.gearLevel,characterId:this.localPlayer.characterId,stance:this.localPlayer.stance,stats:this.localPlayer.stats,skills:this.localPlayer.skills,items:this.localPlayer.items};this.localPlayer=a,this.entities.set(a.entityId,a),this.#o.clear(a),this.#a.Clear(t.time)}processInitPC(t){let n=t.parsed;if(!n)return;this.entities.clear();let a;this.localPlayer.characterId===n.characterId?a={entityId:n.playerId,entityType:1,name:n.name,class:n.classId,gearLevel:n.gearLevel,characterId:n.characterId,stance:this.localPlayer.stance,stats:this.#i.getStatPairMap(n.statPair),skills:this.localPlayer.skills,itemSet:this.localPlayer.itemSet,items:this.localPlayer.items}:a={entityId:n.playerId,entityType:1,name:n.name,class:n.classId,gearLevel:n.gearLevel,characterId:n.characterId,stance:0,stats:this.#i.getStatPairMap(n.statPair),skills:new Map,items:{lifeToolList:new Map,equipList:new Map}},this.localPlayer=a,this.entities.set(a.entityId,a),this.#e.addMapping(a.characterId,a.entityId),this.#o.setOwnName(n.name),this.#o.completeEntry(a.characterId,n.playerId),this.#a.RemoveLocalObject(n.playerId,t.time);for(let o of n.statusEffectDatas){let i=this.getSourceEntity(o.sourceId);this.#a.RegisterStatusEffect(this.#a.buildStatusEffect(o,n.playerId,i.entityId,1,t.time))}return a}processNewNpc(t){let n=t.parsed;if(!n)return;let a=!1,o=this.#i.npc.get(n.npcStruct.typeId);o&&[6,7,9,10].includes(Je[o.grade])&&(a=!0);let i={entityId:n.npcStruct.objectId,entityType:2,name:o?.name??n.npcStruct.objectId.toString(16),typeId:n.npcStruct.typeId,isBoss:a,grade:o?.grade??"none",pushimmune:o?.pushimmune??!1,stats:this.#i.getStatPairMap(n.npcStruct.statPair),level:n.npcStruct.level,balanceLevel:n.npcStruct.balanceLevel??n.npcStruct.level},s=this.#i.getNpcEsther(n.npcStruct.typeId);s!==void 0&&(i.entityType=4,i.name=s.name,i.icon=s.icon),this.entities.set(i.entityId,i),this.#a.RemoveLocalObject(n.npcStruct.objectId,t.time);for(let u of n.npcStruct.statusEffectDatas){let m=this.getSourceEntity(u.sourceId);this.#a.RegisterStatusEffect(this.#a.buildStatusEffect(u,n.npcStruct.objectId,m.entityId,1,t.time))}return i}processNewNpcSummon(t){let n=t.parsed;if(!n)return;let a=!1,o=this.#i.npc.get(n.npcData.typeId);o&&["boss","raid","epic_raid","commander"].includes(o.grade)&&(a=!0);let i={entityId:n.npcData.objectId,entityType:3,name:o?.name??n.npcData.objectId.toString(16),ownerId:n.ownerId,typeId:n.npcData.typeId,isBoss:a,grade:o?.grade??"none",pushimmune:o?.pushimmune??!1,stats:this.#i.getStatPairMap(n.npcData.statPair),level:n.npcData.level,balanceLevel:n.npcData.balanceLevel??n.npcData.level};this.#a.RemoveLocalObject(n.npcData.objectId,t.time);for(let s of n.npcData.statusEffectDatas){let u=this.getSourceEntity(s.sourceId);this.#a.RegisterStatusEffect(this.#a.buildStatusEffect(s,n.npcData.objectId,u.entityId,1,t.time))}return this.entities.set(i.entityId,i),i}getPlayerSetOptions(t){let n=new Map;t.forEach(o=>{if(o.id&&o.slot&&o.slot>=1&&o.slot<=6){let i=this.#i.itemSet.items.get(o.id);if(i){let s=n.get(i.setname);s||(s=new Map,n.set(i.setname,s)),s.set(i.level,(s.get(i.level)??0)+1)}}});let a=[];return n.forEach((o,i)=>{let s=this.#i.itemSet.seteffects.get(i);if(!s)return;let u=0,m=0;for(let[d,f]of[...o.entries()].sort((p,E)=>E[0]-p[0])){let p=s.get(d);if(!p)return;for(let[E,H]of[...p.entries()])E>u&&f+m>=E&&(a.push(...H.options),u=Math.max(u,E));m=f}}),a}getSourceEntity(t){let n=this.entities.get(t);if((n?.entityType===5||n?.entityType===3)&&(t=n.ownerId),n=this.entities.get(t),n)return n;let a={entityId:t,entityType:2,name:t.toString(16),stats:new Map};return this.entities.set(t,a),a}guessIsPlayer(t,n){let a=this.#i.getSkillClassId(n);if(a!==0){let o;if(t.entityType===1){let i=t;if(i.class===a)return i;o={entityId:i.entityId,entityType:1,name:i.name,class:a,gearLevel:i.gearLevel,characterId:i.characterId,stance:i.stance,stats:i.stats,skills:new Map,items:{lifeToolList:new Map,equipList:new Map}}}else if(t.entityType===0)o={entityId:t.entityId,entityType:1,name:t.name,class:a,gearLevel:0,characterId:0n,stance:0,stats:new Map,skills:new Map,items:{lifeToolList:new Map,equipList:new Map}};else return t;return this.entities.set(t.entityId,o),o}return t}getOrCreateEntity(t){let n=this.entities.get(t);return n||(n={entityId:t,entityType:0,name:t.toString(16),stats:new Map},this.entities.set(t,n)),n}getEntityByName(t){return[...this.entities.values()].find(n=>n.name===t)}};var $s=require("tiny-typed-emitter");var Ae=class{ip;zoneSyncStatus=0;cache=new Map;constructor(t,n,a){}updatePlayerStats(t){t.forEach(n=>{let a=this.cache.get(n.name);a?(a.info=n,a.status=2):this.cache.set(n.name,{hash:"",status:2,info:n})})}getStats(t){if(!this.isCurrentZoneValid())return;let n=this.cache.get(t);if(n&&n.status===2)return n.info.stats}isCurrentZoneValid(){return this.zoneSyncStatus!==0&&(this.zoneSyncStatus&10)===0}};var Yo={isLive:!0,dontResetOnZoneChange:!1,resetAfterPhaseTransition:!1,splitOnPhaseTransition:!1,broadcastInterval:100},Be=class extends $s.TypedEmitter{#e;encounters;#o;#a;#i;#n;options;resetTimer;#t=!1;phaseTransitionResetRequest;phaseTransitionResetRequestTime;#s;constructor(t,n,a,o,i){super(),this.#o=t,this.#a=n,this.#i=a,this.#n=o,this.options={...Yo,...i},this.resetTimer=null,this.phaseTransitionResetRequest=!1,this.phaseTransitionResetRequestTime=0,this.#s=new Map,this.encounters=[],this.#e={startedOn:0,lastCombatPacket:0,fightStartedOn:0,localPlayer:this.#o.localPlayer.name,currentBoss:void 0,killState:0,zoneLevel:Se[0],entities:new Map,damageStatistics:{totalDamageDealt:0,topDamageDealt:0,totalDamageTaken:0,topDamageTaken:0,totalHealingDone:0,topHealingDone:0,totalShieldDone:0,topShieldDone:0,debuffs:new Map,buffs:new Map,topShieldGotten:0,totalEffectiveShieldingDone:0,topEffectiveShieldingDone:0,topEffectiveShieldingUsed:0,effectiveShieldingBuffs:new Map,appliedShieldingBuffs:new Map}}}onCounterAttack(t,n){let a=this.updateEntity(t,{},n);a.hits.counter+=1}onInitEnv(t,n){this.options.isLive?(this.#e.entities.forEach((a,o,i)=>{a.hits.total===0&&i.delete(o)}),this.options.dontResetOnZoneChange===!1&&this.resetTimer===null&&(this.resetTimer=setTimeout(()=>{this.resetState(+n+6e3)},6e3),this.emit("message","new-zone"))):(this.splitEncounter(n),this.emit("message","new-zone"))}splitEncounter(t){if(this.#e.fightStartedOn!==0&&(this.#e.damageStatistics.totalDamageDealt!==0||this.#e.damageStatistics.totalDamageTaken!==0)){let n=this.#e,a=this.#o.localPlayer.name;this.resetState(+t),n.entities.forEach(o=>{o.isPlayer&&(o.statApiValid=this.#i.isCurrentZoneValid()&&this.#i.cache.get(o.name)?.status===2)}),n.localPlayer=a,this.applyBreakdowns(n.entities),this.encounters.push(n)}}getBossIfStillExist(){if(this.#e.currentBoss?.id){let t=BigInt(`0x0${this.#e.currentBoss?.id}`);return this.#o.entities.has(t)?this.#e.currentBoss:void 0}}resetState(t,n=!0){this.#t=!1,this.cancelReset(),this.resetBreakdowns(),this.#e={startedOn:+t,lastCombatPacket:+t,fightStartedOn:0,localPlayer:this.#o.localPlayer.name,currentBoss:this.getBossIfStillExist(),entities:new Map,killState:0,zoneLevel:this.#e.zoneLevel,damageStatistics:{totalDamageDealt:0,topDamageDealt:0,totalDamageTaken:0,topDamageTaken:0,totalHealingDone:0,topHealingDone:0,totalShieldDone:0,topShieldDone:0,debuffs:new Map,buffs:new Map,appliedShieldingBuffs:new Map,effectiveShieldingBuffs:new Map,topEffectiveShieldingDone:0,topEffectiveShieldingUsed:0,topShieldGotten:0,totalEffectiveShieldingDone:0}},n&&this.emit("reset-state",this.#e)}cancelReset(){this.resetTimer&&clearTimeout(this.resetTimer),this.resetTimer=null}onPhaseTransition(t,n){this.options.isLive&&(this.emit("message",`phase-transition-${t}`),this.options.resetAfterPhaseTransition&&(this.phaseTransitionResetRequest=!0,this.phaseTransitionResetRequestTime=+n)),!this.options.isLive&&this.options.splitOnPhaseTransition&&this.splitEncounter(n)}updateOptions(t){this.options={...this.options,...t}}onDeath(t,n){let a=this.#e.entities.get(t.name),o=0;a?a.isDead?o=a.deaths:o=a.deaths+1:o=1,this.updateEntity(t,{isDead:!0,deathTime:+n,deaths:o},n)}onDamage(t,n,a,o,i,s){if((o.modifier&15)===11&&o.skillId===0&&o.skillEffectId===0)return;this.phaseTransitionResetRequest&&this.phaseTransitionResetRequestTime>0&&this.phaseTransitionResetRequestTime<+s-8e3&&(this.resetState(+s),this.phaseTransitionResetRequest=!1);let[u,m]=this.#a.getStatusEffects(t,a,this.#o.localPlayer.characterId,s);if(this.#n.isBattleItem(o.skillEffectId,"attack")&&n&&n.entityType===5){let g=n;o.skillEffectId=g.skillEffectId}let d=this.updateEntity(t,{},s),f=this.updateEntity(a,{currentHp:o.targetCurHp,maxHp:o.targetMaxHp},s);if(!d||!f)return;!f.isPlayer&&o.targetCurHp<0&&(o.damage=o.damage+o.targetCurHp);let p=o.skillId;o.skillId===0&&o.skillEffectId!==0&&(p=o.skillEffectId);let E=d.skills.get(p);E||(E={...this.createEntitySkill(),id:p,...this.getSkillNameIcon(o.skillId,o.skillEffectId)},d.skills.set(p,E));let H=o.modifier&15,w=(o.modifier>>4&7)-1,W=(H&9)!==0,ee=new Set,A=new Set;u.forEach(([g])=>{ee.add(g)}),m.forEach(([g])=>{A.add(g)}),E.damageInfo.damageDealt+=o.damage,o.damage>E.maxDamage&&(E.maxDamage=o.damage),d.hits.total+=1,E.hits.total+=1,d.damageInfo.damageDealt+=o.damage,f.damageTaken+=o.damage;let ke=W?1:0;d.hits.crit+=ke,E.hits.crit+=ke;let De=!1,Ne=!1,Te=this.#n.getSkillEffectDirectionalMask(o.skillEffectId)-1;if(Te===0||Te===2){Ne=w===0;let g=Ne?1:0;d.hits.backAttack+=g,d.hits.totalBackAttack+=1,E.hits.backAttack+=g,E.hits.totalBackAttack+=1}if(Te===1||Te===2){De=w===1;let g=De?1:0;d.hits.frontAttack+=g,d.hits.totalFrontAttack+=1,E.hits.frontAttack+=g,E.hits.totalFrontAttack+=1}if(d.isPlayer){this.#e.damageStatistics.totalDamageDealt+=o.damage,this.#e.damageStatistics.topDamageDealt=Math.max(this.#e.damageStatistics.topDamageDealt,d.damageInfo.damageDealt);let g=!1,ne=!1;ee.forEach(l=>{if(!this.#e.damageStatistics.buffs.has(l)){let D=this.#n.getStatusEffectHeaderData(l);D&&this.#e.damageStatistics.buffs.set(l,D)}let R=this.#e.damageStatistics.buffs.get(l);R&&!g&&(g=(R.buffcategory==="classskill"||R.buffcategory==="identity"||R.buffcategory==="ability")&&R.source.skill!==void 0&&R.target===1&&this.#n.isSupportClassId(R.source.skill.classid));let Z=E.damageDealtBuffedBy.get(l)??0;E.damageDealtBuffedBy.set(l,Z+o.damage);let te=d.damageDealtBuffedBy.get(l)??0;d.damageDealtBuffedBy.set(l,te+o.damage);let fe=d.hits.hitsBuffedBy.get(l)??0;d.hits.hitsBuffedBy.set(l,fe+1);let N=E.hits.hitsBuffedBy.get(l)??0;E.hits.hitsBuffedBy.set(l,N+1)}),A.forEach(l=>{if(!this.#e.damageStatistics.debuffs.has(l)){let D=this.#n.getStatusEffectHeaderData(l);D&&this.#e.damageStatistics.debuffs.set(l,D)}let R=this.#e.damageStatistics.debuffs.get(l);R&&!ne&&(ne=(R.buffcategory==="classskill"||R.buffcategory==="identity"||R.buffcategory==="ability")&&R.source.skill!==void 0&&R.target===1&&this.#n.isSupportClassId(R.source.skill.classid));let Z=E.damageDealtDebuffedBy.get(l)??0;E.damageDealtDebuffedBy.set(l,Z+o.damage);let te=d.damageDealtDebuffedBy.get(l)??0;d.damageDealtDebuffedBy.set(l,te+o.damage);let fe=d.hits.hitsDebuffedBy.get(l)??0;d.hits.hitsDebuffedBy.set(l,fe+1);let N=E.hits.hitsDebuffedBy.get(l)??0;E.hits.hitsDebuffedBy.set(l,N+1)});let Gs=ne?1:0,Zs=g?1:0;if(E.damageInfo.damageDealtBuffedBySupport+=g?o.damage:0,E.damageInfo.damageDealtDebuffedBySupport+=ne?o.damage:0,d.damageInfo.damageDealtBuffedBySupport+=g?o.damage:0,d.damageInfo.damageDealtDebuffedBySupport+=ne?o.damage:0,d.hits.hitsBuffedBySupport+=Zs,d.hits.hitsDebuffedBySupport+=Gs,E.hits.hitsBuffedBySupport+=Zs,E.hits.hitsDebuffedBySupport+=Gs,o.damage>0&&d.isPlayer){let l={multDmg:{sumRate:0,totalRate:1,values:Array()},atkPowSubRate2:{selfSumRate:0,sumRate:0,values:Array()},atkPowSubRate1:{sumRate:0,totalRate:1,values:Array()},skillDamRate:{selfSumRate:0,sumRate:0,values:Array()},atkPowAmplify:{values:Array()},crit:{selfSumRate:0,sumRate:0,values:Array()},critDmgRate:2};if(u.forEach(([N,D,T])=>{let b=this.#o.entities.get(D);if(!b)return;let h=this.getBuffAfterTripods(this.#n.skillBuff.get(N),b,o);if(h){if(h.type==="skill_damage_amplify"&&h.statuseffectvalues&&b.entityType===1&&D!==t.entityId){let I=h.statuseffectvalues[0]??0,S=h.statuseffectvalues[4]??0;if((I===0||I===o.skillId)&&(S===0||S===o.skillEffectId)){let x=h.statuseffectvalues[1]??0;if(x!==0){let k=x/1e4*T;l.multDmg.values.push({casterEntity:b,rate:k}),l.multDmg.sumRate+=k,l.multDmg.totalRate*=1+k}}}else if(h.type==="attack_power_amplify"&&h.statuseffectvalues&&b.entityType===1&&D!==t.entityId){let I=h.statuseffectvalues[0]??0;if(I!==0){let S=I/1e4*T,x=this.#i.getStats(b.name)?.find(O=>O.id===4)?.value,k=this.#i.getStats(t.name)?.find(O=>O.id===4)?.value;x&&k&&(S*=x/k),l.atkPowAmplify.values.push({casterEntity:b,rate:S})}}h.passiveoption.forEach(I=>{if(z[I.type]===2){if(I.keystat==="attack_power_sub_rate_2"){let S=I.value;if(S!==0){let x=S/1e4*T;b.entityType===1&&D!==t.entityId?(l.atkPowSubRate2.values.push({casterEntity:b,rate:x}),l.atkPowSubRate2.sumRate+=x):l.atkPowSubRate2.selfSumRate+=x}}else if(I.keystat==="attack_power_sub_rate_1"){let S=I.value;if(S!==0){let x=S/1e4*T;b.entityType===1&&D!==t.entityId&&(l.atkPowSubRate1.values.push({casterEntity:b,rate:x}),l.atkPowSubRate1.sumRate+=x,l.atkPowSubRate1.totalRate*=1+x)}}else if(I.keystat==="skill_damage_rate"){let S=I.value;if(S!==0){let x=S/1e4*T;b.entityType===1&&D!==t.entityId?(l.skillDamRate.values.push({casterEntity:b,rate:x}),l.skillDamRate.sumRate+=x):l.skillDamRate.selfSumRate+=x}}}if(I.keystat==="critical_hit_rate"){let S=I.value;if(S!==0){let x=S/1e4*T;b.entityType===1&&D!==t.entityId?(l.crit.values.push({casterEntity:b,rate:x}),l.crit.sumRate+=x):l.crit.selfSumRate+=x}}if(b.entityType===1&&D!==t.entityId)if(I.keystat==="skill_damage_sub_rate_2"){let S=I.value;if(S!==0){let x=S/1e4*T,k=this.#i.getStats(b.name)?.find(O=>O.id===1)?.value??0;switch(b.class){case 204:x*=1+k/.0699*.35/1e4;break;case 105:x*=1+k/.0699*.63/1e4;break;case 602:x*=1+k/.0699*.38/1e4;break;default:break}l.multDmg.values.push({casterEntity:b,rate:x}),l.multDmg.sumRate+=x,l.multDmg.totalRate*=1+x}}else I.keystat==="critical_dam_rate"&&h.category==="buff"&&(l.critDmgRate+=I.value/1e4*T);else if(z[I.type]===4){let S=this.#n.combatEffect.get(I.keyindex);l.critDmgRate+=T*this.getCritMultiplierFromCombatEffect(S,{self:t,target:a,caster:b,skill:this.#n.skill.get(p),hitOption:w,targetCount:i})}})}}),m.forEach(([N,D,T])=>{let b=this.#o.entities.get(D);if(!b)return;let h=this.getBuffAfterTripods(this.#n.skillBuff.get(N),b,o);if(h){if(h.type==="instant_stat_amplify"&&h.statuseffectvalues){let I=h.statuseffectvalues[0]??0;if(I!==0){let S=I/1e4*T;b.entityType===1&&D!==t.entityId?(l.crit.values.push({casterEntity:b,rate:S}),l.crit.sumRate+=S):l.crit.selfSumRate+=S}}if(!(b.entityType!==1||D===t.entityId)){if(h.type==="instant_stat_amplify"&&h.statuseffectvalues){let I=h.statuseffectvalues[0]??0;if(o.damageType===0){let S=h.statuseffectvalues[2]??0;if(S!==0){let k=-(S/1e4)*T*.5;l.multDmg.values.push({casterEntity:b,rate:k}),l.multDmg.sumRate+=k,l.multDmg.totalRate*=1+k}let x=h.statuseffectvalues[7]??0;if(x!==0){let k=x/1e4*T;l.multDmg.values.push({casterEntity:b,rate:k}),l.multDmg.sumRate+=k,l.multDmg.totalRate*=1+k}if(W){let k=h.statuseffectvalues[9]??0;if(k!==0){let O=k/1e4*T;l.multDmg.values.push({casterEntity:b,rate:O}),l.multDmg.sumRate+=O,l.multDmg.totalRate*=1+O}}}else if(o.damageType===1){let S=h.statuseffectvalues[3]??0;if(S!==0){let k=-(S/1e4)*T*.5;l.multDmg.values.push({casterEntity:b,rate:k}),l.multDmg.sumRate+=k,l.multDmg.totalRate*=1+k}let x=h.statuseffectvalues[8]??0;if(x!==0){let k=x/1e4*T;l.multDmg.values.push({casterEntity:b,rate:k}),l.multDmg.sumRate+=k,l.multDmg.totalRate*=1+k}if(W){let k=h.statuseffectvalues[10]??0;if(k!==0){let O=k/1e4*T;l.multDmg.values.push({casterEntity:b,rate:O}),l.multDmg.sumRate+=O,l.multDmg.totalRate*=1+O}}}}if(h.type==="skill_damage_amplify"&&h.statuseffectvalues){let I=h.statuseffectvalues[0]??0,S=h.statuseffectvalues[4]??0;if((I===0||I===o.skillId)&&(S===0||S===o.skillEffectId)){let x=h.statuseffectvalues[1]??0;if(x!==0){let k=x/1e4*T;l.multDmg.values.push({casterEntity:b,rate:k}),l.multDmg.sumRate+=k,l.multDmg.totalRate*=1+k}}}if(h.type==="directional_attack_amplify"&&h.statuseffectvalues){if(De){let I=h.statuseffectvalues[0]??0;if(I!==0){let S=I/100*T;l.multDmg.values.push({casterEntity:b,rate:S}),l.multDmg.sumRate+=S,l.multDmg.totalRate*=1+S}}if(Ne){let I=h.statuseffectvalues[4]??0;if(I!==0){let S=I/100*T;l.multDmg.values.push({casterEntity:b,rate:S}),l.multDmg.sumRate+=S,l.multDmg.totalRate*=1+S}}}}}}),l.crit.values.length>0){let N=this.#n.skill.get(o.skillId);t.itemSet?.forEach(D=>{if(z[D.type]===2&&re[D.keystat]===76)l.critDmgRate+=D.value/1e4;else if(z[D.type]===4){let T=this.#n.combatEffect.get(D.keyindex);l.critDmgRate+=this.getCritMultiplierFromCombatEffect(T,{self:t,target:a,caster:t,skill:N,hitOption:w,targetCount:i})}t.skills.get(o.skillId)?.tripods.forEach(T=>{let b=new Map;T.options.forEach(h=>{let I=ge[h.type];if(I===45){if((h.params[0]??0)===0||o.skillEffectId===(h.params[0]??0)){let S=h.params[1];if(S){let x=this.#n.combatEffect.get(S);x&&b.set(x.id,x)}}}else if(I===46)b.delete(h.params[0]??0);else if(I===104){if((h.params[0]??0)===0||o.skillEffectId===(h.params[0]??0)){let S=b.get(h.params[1]??0);if(S){let x=Qo(S);b.set(S.id,x),x.effects.forEach(k=>{k.actions.forEach(O=>{for(let ae=0;ae<h.params.length-2;ae++)we[h.paramtype]===1?O.args[ae]*=1+(h.params[ae+2]??0)/100:O.args[ae]+=h.params[ae+2]??0})})}}}else I===29?((h.params[0]??0)===0||o.skillEffectId===(h.params[0]??0))&&(l.critDmgRate+=(h.params[1]??0)/1e4):I===30&&((h.params[0]??0)===0||o.skillEffectId===(h.params[0]??0))&&(l.crit.selfSumRate+=(h.params[1]??0)/1e4)}),b.forEach(h=>{l.critDmgRate+=this.getCritMultiplierFromCombatEffect(h,{self:t,target:a,caster:t,skill:N,hitOption:w,targetCount:i})})})})}if(l.skillDamRate.values.length>0){let N=this.#i.getStats(t.name)?.find(D=>D.id===5)?.value;N&&(l.skillDamRate.selfSumRate+=N/1e4)}let R=0;if(l.crit.values.length>0){l.crit.selfSumRate+=(this.#i.getStats(t.name)?.find(D=>D.id===0)?.value??0)/.2794/1e4;let N=Math.min(Math.max(0,1-l.crit.selfSumRate),l.crit.sumRate);R=(N*l.critDmgRate-N)/(l.crit.selfSumRate*l.critDmgRate-l.crit.selfSumRate+1)}let Z=l.atkPowAmplify.values.length<=0?{rate:0}:l.atkPowAmplify.values.reduce((N,D)=>N.rate>D.rate?N:D),te=(1+R)*(1+l.atkPowSubRate2.sumRate/(1+l.atkPowSubRate2.selfSumRate))*(1+l.skillDamRate.sumRate/(1+l.skillDamRate.selfSumRate))*(1+Z.rate)*l.multDmg.totalRate*l.atkPowSubRate1.totalRate-1,fe=R+l.atkPowSubRate2.sumRate/(1+l.atkPowSubRate2.selfSumRate)+l.skillDamRate.sumRate/(1+l.skillDamRate.selfSumRate)+Z.rate+(l.multDmg.totalRate-1)+(l.atkPowSubRate1.totalRate-1);{let N=te*o.damage/(fe*(1+te)),D=R*N/l.crit.sumRate;l.crit.values.forEach(h=>{let I=h.rate*D,S=this.#e.entities.get(h.casterEntity.name);this.applyRdps(d,S,E,I)}),l.atkPowSubRate2.values.forEach(h=>{let I=h.rate/(1+l.atkPowSubRate2.selfSumRate)*N,S=this.#e.entities.get(h.casterEntity.name);this.applyRdps(d,S,E,I)}),l.skillDamRate.values.forEach(h=>{let I=h.rate/(1+l.skillDamRate.selfSumRate)*N,S=this.#e.entities.get(h.casterEntity.name);this.applyRdps(d,S,E,I)});let T=(l.multDmg.totalRate-1)*N/l.multDmg.sumRate;l.multDmg.values.forEach(h=>{let I=h.rate*T,S=this.#e.entities.get(h.casterEntity.name);this.applyRdps(d,S,E,I)});let b=(l.atkPowSubRate1.totalRate-1)*N/l.atkPowSubRate1.sumRate;if(l.atkPowSubRate1.values.forEach(h=>{let I=h.rate*b,S=this.#e.entities.get(h.casterEntity.name);this.applyRdps(d,S,E,I)}),Z.rate>0){let h=Z.rate*N,I=this.#e.entities.get(Z.casterEntity?.name);this.applyRdps(d,I,E,h)}}}let v={timestamp:+s,damage:o.damage,targetEntity:f.id,isCrit:W,isBackAttack:Ne,isFrontAttack:De,isBuffedBySupport:g,isDebuffedBySupport:ne,buffedBy:[...ee],debuffedBy:[...A]},Wo=BigInt("0x"+d.id);this.addBreakdown(Wo,p,v)}f.isPlayer&&(this.#e.damageStatistics.totalDamageTaken+=o.damage,this.#e.damageStatistics.topDamageTaken=Math.max(this.#e.damageStatistics.topDamageTaken,f.damageTaken)),f.isBoss&&(this.#e.currentBoss=f),this.#e.fightStartedOn===0&&(this.#e.fightStartedOn=+s),this.#e.lastCombatPacket=+s}getBuffAfterTripods(t,n,a){if(!t||n.entityType!==1)return t;let o=$o(t);return n.skills.get(a.skillId)?.tripods.forEach(i=>{i.options.forEach(s=>{let u=ge[s.type];if(u===19){if(((s.params[0]??0)===0||a.skillEffectId===(s.params[0]??0))&&o.id===(s.params[1]??0)){let m=new Map;for(let d=2;d<s.params.length;d+=2)s.params[d]&&s.params[d+1]&&m.set(s.params[d]??0,s.params[d+1]??0);o.passiveoption.forEach(d=>{let f=m.get(re[d.keystat]);z[d.type]===2&&f&&(we[s.paramtype]===0?d.value+=f:d.value*=1+f/100)})}}else if(u===42){if(((s.params[0]??0)===0||a.skillEffectId===(s.params[0]??0))&&o.id===(s.params[1]??0)){let m=re[s.params[2]??0],d=s.params[3]??0;m&&d!==void 0&&o.passiveoption.push({type:"stat",keystat:m,keyindex:0,value:d})}}else if(u===21&&o.statuseffectvalues&&((s.params[0]??0)===0||a.skillEffectId===(s.params[0]??0))&&o.id===(s.params[1]??0))if((s.params[2]??0)===0)o.statuseffectvalues=s.params.slice(3);else{let m=[];for(let d=0;d<Math.max(o.statuseffectvalues.length,s.params.length-3);d++)s.params[d+3]&&m.push((o.statuseffectvalues[d]??0)*(1+(s.params[d+3]??0)/100));o.statuseffectvalues=m}})}),o}getCritMultiplierFromCombatEffect(t,n){if(!t)return 0;let a=0;return t.effects.filter(o=>o.actions.find(i=>Re[i.type]===4)).forEach(o=>{this.#n.isCombatEffectConditionsValid({effect:o,...n})&&o.actions.filter(i=>Re[i.type]===4).forEach(i=>{a+=(i.args[0]??0)/100})}),a}applyRdps(t,n,a,o){n&&(n.damageInfo.rdpsDamageGiven+=o),n&&this.#n.isSupportClassId(n.classId)&&(t.damageInfo.rdpsDamageReceivedSupp+=o,a.damageInfo.rdpsDamageReceivedSupp+=o),t.damageInfo.rdpsDamageReceived+=o,a.damageInfo.rdpsDamageReceived+=o}onStartSkill(t,n,a){let o=this.updateEntity(t,{isDead:!1},a);if(o){o.hits.casts+=1;let i=o.skills.get(n);i||(i={...this.createEntitySkill(),id:n,...this.getSkillNameIcon(n,0)},o.skills.set(n,i)),i.hits.casts+=1}}onShieldUsed(t,n,a,o){if(o<0&&console.error("Shield change values was negative, shield ammount increased"),t.entityType===1&&n.entityType===1){if(!this.#e.damageStatistics.effectiveShieldingBuffs.has(a)){let f=this.#n.getStatusEffectHeaderData(a);f&&this.#e.damageStatistics.effectiveShieldingBuffs.set(a,f)}let i=new Date,s=this.updateEntity(t,{},i),u=this.updateEntity(n,{},i);s.damagePreventedByShield+=o;let m=s.damagePreventedByShieldBy.get(a)??0;s.damagePreventedByShieldBy.set(a,m+o),this.#e.damageStatistics.topEffectiveShieldingUsed=Math.max(s.damagePreventedByShield,this.#e.damageStatistics.topEffectiveShieldingUsed),u.damagePreventedWithShieldOnOthers+=o;let d=u.damagePreventedWithShieldOnOthersBy.get(a)??0;u.damagePreventedWithShieldOnOthersBy.set(a,d+o),this.#e.damageStatistics.topEffectiveShieldingDone=Math.max(u.damagePreventedWithShieldOnOthers,this.#e.damageStatistics.topEffectiveShieldingDone),this.#e.damageStatistics.totalEffectiveShieldingDone+=o}}onShieldApplied(t,n,a,o){let i=new Date,s=this.updateEntity(t,{},i),u=this.updateEntity(n,{},i);if(u.isPlayer&&s.isPlayer){if(!this.#e.damageStatistics.appliedShieldingBuffs.has(a)){let f=this.#n.getStatusEffectHeaderData(a);f&&this.#e.damageStatistics.appliedShieldingBuffs.set(a,f)}s.shieldReceived+=o,u.shieldDone+=o;let m=u.shieldDoneBy.get(a)??0;u.shieldDoneBy.set(a,m+o);let d=s.shieldReceivedBy.get(a)??0;s.shieldReceivedBy.set(a,d+o),this.#e.damageStatistics.topShieldDone=Math.max(u.shieldDone,this.#e.damageStatistics.topShieldDone),this.#e.damageStatistics.topShieldGotten=Math.max(s.shieldReceived,this.#e.damageStatistics.topShieldGotten),this.#e.damageStatistics.totalShieldDone+=o}}getSkillNameIcon(t,n){if(t===0&&n===0)return{name:"Bleed",icon:"buff_168.png"};if(t===0){let a=this.#n.skillEffect.get(n);if(a&&a.itemname)return{name:a.itemname,icon:a.icon??""};if(a){if(a.sourceskill?.[0]){let o=this.#n.skill.get(a.sourceskill[0]);if(o)return{name:o.name,icon:o.icon}}else{let o=this.#n.skill.get(Math.floor(n/10));if(o)return{name:o.name,icon:o.icon}}return{name:a.comment}}else return{name:this.#n.getSkillName(t)}}else{let a=this.#n.skill.get(t);return!a&&(a=this.#n.skill.get(t-t%10),!a)?{name:this.#n.getSkillName(t),icon:""}:a.summonsourceskill?.[0]?(a=this.#n.skill.get(a.summonsourceskill[0]),a?{name:a.name+" (Summon)",icon:a.icon}:{name:this.#n.getSkillName(t),icon:""}):a.sourceskill?.[0]?(a=this.#n.skill.get(a.sourceskill[0]),a?{name:a.name,icon:a.icon}:{name:this.#n.getSkillName(t),icon:""}):{name:a.name,icon:a.icon}}}updateEntity(t,n,a){let o={lastUpdate:+a},i=this.#e.entities.get(t.name),s={};if(!i||t.entityType===1&&i.isPlayer!==!0){if(t.entityType===1){let u=t;s={classId:u.class,gearScore:u.gearLevel,isPlayer:!0}}else if(t.entityType===2||t.entityType===3){let u=t;s={npcId:u.typeId,isBoss:u.isBoss}}else if(t.entityType===4){let u=t;s={npcId:u.typeId,isBoss:u.isBoss,isEsther:!0,icon:u.icon}}}return i?Object.assign(i,n,o,s):(i={...this.createEntity(),...n,...o,...s,name:t.name,id:t.entityId.toString(16)},this.#e.entities.set(t.name,i)),i}updateOrCreateEntity(t,n,a){if(!(!n.name||!n.id)){for(let[o,i]of this.#e.entities)if(n.id===i.id){this.#e.entities.delete(o),this.updateEntity(t,{...i,...n},a);return}this.updateEntity(t,n,a)}}createEntitySkill(){return{id:0,name:"",icon:"",damageInfo:{damageDealt:0,rdpsDamageReceived:0,rdpsDamageReceivedSupp:0,rdpsDamageGiven:0,damageDealtDebuffedBySupport:0,damageDealtBuffedBySupport:0},maxDamage:0,hits:{casts:0,total:0,crit:0,backAttack:0,totalBackAttack:0,frontAttack:0,totalFrontAttack:0,counter:0,hitsDebuffedBySupport:0,hitsBuffedBySupport:0,hitsBuffedBy:new Map,hitsDebuffedBy:new Map},breakdown:[],damageDealtDebuffedBy:new Map,damageDealtBuffedBy:new Map}}createEntity(){return{lastUpdate:0,id:"",npcId:0,name:"",classId:0,isBoss:!1,isPlayer:!1,isDead:!1,deaths:0,deathTime:0,gearScore:0,currentHp:0,maxHp:0,damageInfo:{damageDealt:0,rdpsDamageReceived:0,rdpsDamageReceivedSupp:0,rdpsDamageGiven:0,damageDealtDebuffedBySupport:0,damageDealtBuffedBySupport:0},healingDone:0,shieldDone:0,damageTaken:0,skills:new Map,hits:{casts:0,total:0,crit:0,backAttack:0,totalBackAttack:0,frontAttack:0,totalFrontAttack:0,counter:0,hitsDebuffedBySupport:0,hitsBuffedBySupport:0,hitsBuffedBy:new Map,hitsDebuffedBy:new Map},damageDealtDebuffedBy:new Map,damageDealtBuffedBy:new Map,damagePreventedByShieldBy:new Map,damagePreventedWithShieldOnOthersBy:new Map,shieldDoneBy:new Map,shieldReceivedBy:new Map,damagePreventedWithShieldOnOthers:0,damagePreventedByShield:0,shieldReceived:0,statApiValid:!1}}getBroadcast(){let t={...this.#e};return t.entities=new Map,this.#e.entities.forEach((n,a)=>{!n.isPlayer&&!n.isEsther||(n.statApiValid=this.#t||this.#i.isCurrentZoneValid()&&this.#i.cache.get(n.name)?.status===2,t.entities.set(a,{...n}))}),t.localPlayer=this.#o.localPlayer.name,t}resetBreakdowns(){this.#s.clear()}createBreakdownEntity(t){return this.#s.has(t)||this.#s.set(t,new Map),this.#s.get(t)}removeBreakdownEntry(t){this.#s.delete(t)}addBreakdown(t,n,a){let o=this.createBreakdownEntity(t);if(o.has(n))o.get(n).push(a);else{let i=new Array(a);o.set(n,i)}}getBreakdowns(t,n){let a=this.#s.get(t);if(a)return a.get(n)}clearBreakdowns(t,n){let a=this.#s.get(t);a&&a.delete(n)}applyBreakdowns(t,n=!0){t.forEach(a=>{a.skills.forEach(o=>{let i=BigInt("0x"+a.id),s=this.getBreakdowns(i,o.id);s&&(o.breakdown=[...s])})}),n&&this.resetBreakdowns()}setKillState(t){this.#e.killState=t}setZoneLevel(t){this.#e.zoneLevel=Se[t]}onSyncDmg(t){this.resetState(+new Date,!1),this.#t=!0,this.#e.lastCombatPacket=+new Date,this.#e.fightStartedOn=this.#e.lastCombatPacket-t.duration,t.table.forEach(n=>{let a={...this.createEntity(),classId:n.typeId<1e3?n.typeId:0,npcId:n.typeId>=1e3?n.typeId:0,isPlayer:n.typeId<1e3,isEsther:n.typeId>=1e3,damageInfo:{damageDealt:n.dealt,rdpsDamageGiven:n.given,rdpsDamageReceived:n.receivedDps+n.receivedSupp,rdpsDamageReceivedSupp:n.receivedSupp,damageDealtBuffedBySupport:0,damageDealtDebuffedBySupport:0},isDead:n.deadDuration>0,deaths:n.deadDuration>0?1:0,deathTime:n.deadDuration>0?this.#e.lastCombatPacket-n.deadDuration:0,hits:{total:1,crit:n.crit/100,backAttack:n.ba/100,totalBackAttack:n.ba>0?1:0,frontAttack:n.fa/100,totalFrontAttack:n.fa>0?1:0,counter:0,hitsDebuffedBySupport:0,hitsBuffedBySupport:0,casts:0,hitsBuffedBy:new Map,hitsDebuffedBy:new Map},id:n.name,name:n.name,lastUpdate:this.#e.lastCombatPacket};if(a.skills.set(0,{...this.createEntitySkill(),icon:"",name:"Uncategorized",id:0,maxDamage:a.damageInfo.damageDealt,damageInfo:a.damageInfo,hits:a.hits}),a.isEsther){let o=this.#n.getNpcEsther(a.npcId);o&&(a.icon=o.icon)}this.#e.entities.set(n.name,a)})}};function $o(e){return{id:e.id,name:e.name,desc:e.desc,icon:e.icon,iconshowtype:e.iconshowtype,duration:e.duration,category:e.category,type:e.type,statuseffectvalues:e.statuseffectvalues?.map(n=>n),buffcategory:e.buffcategory,target:e.target,uniquegroup:e.uniquegroup,overlapFlag:e.overlapFlag,passiveoption:e.passiveoption.map(n=>({keyindex:n.keyindex,keystat:n.keystat,type:n.type,value:n.value})),setname:e.setname,sourceskill:e.sourceskill?.map(n=>n)}}function Qo(e){return{id:e.id,effects:e.effects.map(t=>({...t,conditions:t.conditions.map(n=>({...n})),actions:t.actions.map(n=>({...n,args:n.args.map(a=>a)}))}))}}var Ao=require("tiny-typed-emitter");function ue(e,t){let n={};return n.points=e.u16(),n.id=e.u32(),n.level=e.u8(),n}function le(e,t){e.u16(t.points),e.u32(t.id),e.u8(t.level)}function tn(e,t){let n={};return n.abilityDataList=e.array(e.u16(),()=>ue(e,t)),n}function an(e,t){e.array(t.abilityDataList,{lenType:"u16"},n=>{le(e,n)})}var sn="AbilityChangeNotify";function Qs(e,t){let n={};return n.featureType=e.u16(),n.level=e.u32(),n}function Js(e,t){e.u16(t.featureType),e.u32(t.level)}function on(e,t){let n={};return n.activeAbilityList=e.array(e.u16(),()=>Qs(e,t)),n.objectId=e.u64(),n}function rn(e,t){e.array(t.activeAbilityList,{lenType:"u16"},n=>{Js(e,n)}),e.u64(t.objectId)}var _n="ActiveAbilityNotify";function un(e,t){let n={};return n.objectId=e.u64(),n.addonSkillFeatureList=e.array(e.u16(),()=>{let a={};return a.addonSkillFeatureIdList=e.array(e.u16(),()=>e.u32()),a.skillId=e.u32(),a}),n}function ln(e,t){e.u64(t.objectId),e.array(t.addonSkillFeatureList,{lenType:"u16"},n=>{e.array(n.addonSkillFeatureIdList,{lenType:"u16"},a=>{e.u32(a)}),e.u32(n.skillId)})}var mn="AddonSkillFeatureChangeNotify";function dn(e,t){let n={};return n.paralyzationMaxPoint=e.u32(),n.type=e.u8(),n.objectId=e.u64(),n.paralyzationPoint=e.u32(),n}function cn(e,t){e.u32(t.paralyzationMaxPoint),e.u8(t.type),e.u64(t.objectId),e.u32(t.paralyzationPoint)}var fn="BlockSkillStateNotify";function hn(e,t){let n={};return n.sourceId=e.u64(),n.targetId=e.u64(),n.type=e.u32(),n}function Sn(e,t){e.u64(t.sourceId),e.u64(t.targetId),e.u32(t.type)}var pn="CounterAttackNotify";function vn(e,t){let n={};return n.sourceId=e.u64(),n.targetId=e.u64(),t>=4?(n.effectId=e.u32(),n.directionYaw=e.u16(),n.deathType=e.u8(),n.durabilityDecrement=e.u8(),n.abnormalStatusType=e.u8(),n.damageAttr=e.u8(),n.unk0_m=e.u64(),n.unk2_m=e.u32()):(n.effectId=0,n.directionYaw=0,n.deathType=0,n.durabilityDecrement=0,n.abnormalStatusType=0,n.damageAttr=0,n.unk0_m=0n,n.unk2_m=0),n}function In(e,t){e.u64(t.sourceId),e.u64(t.targetId),e.u32(t.effectId),e.u16(t.directionYaw),e.u8(t.deathType??0),e.u8(t.durabilityDecrement),e.u8(t.abnormalStatusType??0),e.u8(t.damageAttr??0),e.u64(t.unk0_m),e.u32(t.unk2_m)}var En="DeathNotify";function xn(e,t){let n={};return n.abilityDataList=e.array(e.u16(),()=>ue(e,t)),n}function bn(e,t){e.array(t.abilityDataList,{lenType:"u16"},n=>{le(e,n)})}var kn="InitAbility";function Dn(e,t){let n={};return n.playerId=e.u64(),n}function Nn(e,t){e.u64(t.playerId)}var Tn="InitEnv";var Xo=[0,31,28,31,30,31,30,31,31,30,31,30,31];function yo(e){return!(e%4||!(e%100)&&e%400)}function ei(e,t,n){if(e>99){if(e<1752||e==1752&&(t<9||t==9&&n<<14))return!1}else e+=1900;return n>0&&t<=12&&(n<=Xo[t]||n==29&&t==2&&yo(e))}function Pn(e){let t=Number(e&0xffffffffn),n=Number(e>>32n&0xffffffffn),a=t&4095,o=(t&65535)>>12,i=t>>16&31;ei(a,o,i)||(a=o=i=0);let s=t>>21&31,u=t>>26&63,m=n&63,d=n>>6&16383;return s<24&&u<60&&m<60&&d<1e3||(s=24,u=m=d=0),new Date(Date.UTC(a<=99?a+1900:a,o-1,i,s,u,m,d))}function Xs(e){let t=0n;return t|=BigInt(e.getUTCMilliseconds())<<38n,t|=BigInt(e.getUTCSeconds())<<32n,t|=BigInt(e.getUTCMinutes())<<26n,t|=BigInt(e.getUTCHours())<<21n,t|=BigInt(e.getUTCDate())<<16n,t|=BigInt(e.getUTCMonth()+1)<<12n,t|=BigInt(e.getUTCFullYear()<2e3?e.getUTCFullYear()-1900:e.getUTCFullYear()),t}function K(e,t=0){let n=e.u16();return(n&4095)<2079?(e.o-=2,Pn(e.i64())):Pn(BigInt(n)&0xfffn|0x11000n)}function Y(e,t=Pn(0x1181fn)){t.getUTCFullYear()>=2079?e.u16(Number(Xs(t)&0xffffn)):e.i64(Xs(t))}function F(e,t){let n={};return n.skillLevel=e.u8(),n.occurTime=K(e,t),n.statusEffectId=e.u32(),n.sourceId=e.u64(),n.totalTime=e.f32(),n.endTick=e.u64(),e.bool()&&(n.value=e.bytes(16)),n.effectInstanceId=e.u32(),t>=1?n.stackCount=e.u8():n.stackCount=1,n}function U(e,t){e.u8(t.skillLevel),Y(e,t.occurTime),e.u32(t.statusEffectId),e.u64(t.sourceId),e.f32(t.totalTime),e.u64(t.endTick),e.bool(t.value!==void 0)&&e.bytes(t.value,{length:16}),e.u32(t.effectInstanceId),e.u8(t.stackCount)}function ni(e){if(e.length===0)return 0n;if(e.length>8)throw new Error("Value is too large");let t=Buffer.alloc(8);return e.copy(t),t.readBigInt64LE()}function C(e,t=0){let n=e.u8(),a=e.bytes(n>>1&7),o=ni(a)<<4n|BigInt(n>>4);return n&1?-o:o}function L(e,t=0n){let n=Buffer.alloc(8),a=t<0n;n.writeBigInt64LE((a?-t:t)>>4n);let o=0;for(let[i,s]of n.entries())s!=0&&(o=i+1);if(o>7)throw new Error("Value is too large");e.u8(Number((a?-t:t)&0xfn)<<4|(o&7)<<1|(a?1:0)),e.bytes(n.subarray(0,o),{length:o})}function wn(e,t){let n={};return n.statPair=e.array(e.u16(),()=>{let a={};return a.StatType=e.u8(),a.Value=C(e,t),a}),n.name=e.string(),n.level=e.u16(),n.statusEffectDatas=e.array(e.u16(),()=>F(e,t)),n.characterId=e.u64(),n.gearLevel=e.f32(),n.playerId=e.u64(),n.classId=e.u16(),n}function gn(e,t){e.array(t.statPair,{lenType:"u16"},n=>{e.u8(n.statType),L(e,n.value)}),e.string(t.name),e.u16(t.level),e.array(t.statusEffectDatas,{lenType:"u16"},n=>{U(e,n)}),e.u64(t.characterId),e.f32(t.gearLevel),e.u64(t.playerId),e.u16(t.classId)}var Cn="InitPC";function Ln(e,t){let n={};return n.statPair=e.array(e.u16(),()=>{let a={};return a.statType=e.u8(),a.value=C(e,t),a}),n.statusEffectDatas=e.array(e.u16(),()=>F(e,t)),n.addonSkillFeatureList=e.array(e.u16(),()=>{let a={};return a.addonSkillFeatureIdList=e.array(e.u16(),()=>e.u32()),a.skillId=e.u32(),a}),n.abilityDataList=e.array(e.u16(),()=>ue(e,t)),n}function An(e,t){e.array(t.statPair,{lenType:"u16"},n=>{e.u8(n.statType),L(e,n.value)}),e.array(t.statusEffectDatas,{lenType:"u16"},n=>{U(e,n)}),e.array(t.addonSkillFeatureList,{lenType:"u16"},n=>{e.array(n.addonSkillFeatureIdList,{lenType:"u16"},a=>{e.u32(a)}),e.u32(n.skillId)}),e.array(t.abilityDataList,{lenType:"u16"},n=>{le(e,n)})}var Bn="InitLocal";function Mn(e,t){let n={};return n.account_CharacterId1=e.u64(),n.serverAddr=e.string(),n.account_CharacterId2=e.u64(),n}function Ee(e,t){e.u64(t.account_CharacterId1),e.string(t.serverAddr),e.u64(t.account_CharacterId2)}var On="MigrationExecute";function Wn(e){return e>>20===1?-((~e>>>0)+1&2097151):e}function B(e,t=0){let n=e.u64();return{x:Wn(Number(n&0x1fffffn)),y:Wn(Number(n>>21n&0x1fffffn)),z:Wn(Number(n>>42n&0x1fffffn))}}function M(e,t={x:0,y:0,z:0}){e.u64(BigInt(Math.round(t.x??0)>>>0&2097151)|BigInt(Math.round(t.y??0)>>>0&2097151)<<21n|BigInt(Math.round(t.z??0)>>>0&2097151)<<42n)}function q(e,t=0){return e.u16()*(2*Math.PI)/65536}function G(e,t=0){e.u16(Math.round(t*65536/(2*Math.PI))%65536)}function Oe(e,t){let n={};return n.spawnIndex=e.u32(),n.objectId=e.u64(),e.bool()&&(n.transitIndex=e.u32()),n.position=B(e,t),n.statusEffectDatas=e.array(e.u16(),()=>F(e,t)),n.directionYaw=q(e,t),n.statPair=e.array(e.u16(),()=>{let a={};return a.statType=e.u8(),a.value=C(e,t),a}),n.typeId=e.u32(),t>=1?(n.level=e.u16(),e.bool()&&(n.balanceLevel=e.u16())):n.level=0,n}function We(e,t){e.u32(t.spawnIndex),e.u64(t.objectId),e.bool(t.transitIndex!==void 0)&&e.u32(t.transitIndex),M(e,t.position),e.array(t.statusEffectDatas,{lenType:"u16"},n=>{U(e,n)}),G(e,t.directionYaw),e.array(t.statPair,{lenType:"u16"},n=>{e.u8(n.statType),L(e,n.value)}),e.u32(t.typeId),e.u16(t.level),e.bool(t.balanceLevel!==void 0)&&e.u16(t.balanceLevel)}function jn(e,t){let n={};return n.npcStruct=Oe(e,t),n}function Fn(e,t){We(e,t.npcStruct)}var Un="NewNpc";function Vn(e,t){let n={};return n.publishReason=e.u8(),n.ownerId=e.u64(),n.npcData=Oe(e,t),n}function Hn(e,t){e.u8(t.publishReason),e.u64(t.ownerId),We(e,t.npcData)}var qn="NewNpcSummon";function X(e,t){let n={};return n.slot=e.u16(),n.level=e.u16(),n.itemTint=e.bytes(e.u16(),0,14),n.expireTime=K(e),n.id=e.u32(),n}function y(e,t){e.u16(t.slot),e.u16(t.level),e.bytes(t.itemTint,{maxLen:0,lenType:"u16",multiplier:14}),Y(e,t.expireTime),e.u32(t.id)}function eo(e,t){let n={};return n.maxItemLevel=e.f32(),n.statPair=e.array(e.u16(),()=>{let a={};return a.statType=e.u8(),a.value=C(e,t),a}),n.name=e.string(),n.heading=q(e,t),n.characterId=e.u64(),n.playerId=e.u64(),n.addonSkillFeatureList=e.array(e.u16(),()=>{let a={};return a.addonSkillFeatureIdList=e.array(e.u16(),()=>e.u32()),a.skillId=e.u32(),a}),n.classId=e.u16(),n.level=e.u16(),n.statusEffectDatas=e.array(e.u16(),()=>F(e,t)),t>=1?(n.avgItemLevel=e.f32(),n.position=B(e),n.equipItemDataList=e.array(e.u16(),()=>X(e,t)),n.equipLifeToolDataList=e.array(e.u16(),()=>X(e,t)),n.guildName=e.string(),t>=2?n.guildId=e.u64():n.guildId=BigInt(e.u32())):(n.avgItemLevel=n.maxItemLevel,n.position={x:0,y:0,z:0},n.equipItemDataList=[],n.equipLifeToolDataList=[],n.guildName="",n.guildId=0n),n}function no(e,t){e.f32(t.maxItemLevel),e.array(t.statPair,{lenType:"u16"},n=>{e.u8(n.statType),L(e,n.value)}),e.string(t.name),G(e,t.heading),e.u64(t.characterId),e.u64(t.playerId),e.array(t.addonSkillFeatureList,{lenType:"u16"},n=>{e.array(n.addonSkillFeatureIdList,{lenType:"u16"},a=>{e.u32(a)}),e.u32(n.skillId)}),e.u16(t.classId),e.u16(t.level),e.array(t.statusEffectDatas,{lenType:"u16"},n=>{U(e,n)}),e.f32(t.avgItemLevel),M(e,t.position),e.array(t.equipItemDataList,{lenType:"u16"},n=>{y(e,n)}),e.array(t.equipLifeToolDataList,{lenType:"u16"},n=>{y(e,n)}),e.string(t.guildName),e.u64(t.guildId)}function Zn(e,t){let n={};return n.pcStruct=eo(e,t),n}function zn(e,t){no(e,t.pcStruct)}var Kn="NewPC";function je(e,t=0){return{first:e.u8(),second:e.u8(),third:e.u8()}}function Fe(e,t){e.u8(t.first),e.u8(t.second),e.u8(t.third)}function Ue(e,t=0){return{first:e.u16(),second:e.u16(),third:e.u16()}}function Ve(e,t){e.u16(t.first),e.u16(t.second),e.u16(t.third)}function so(e,t){let n={};return n.tripodIndex=je(e,t),n.chainSkillEffect=e.u32(),n.skillEffect=e.u32(),n.skillId=e.u32(),n.targetObjectId=e.u64(),n.ownerId=e.u64(),n.skillLevel=e.u8(),n.projectileId=e.u64(),n.tripodLevel=Ue(e,t),n}function oo(e,t){Fe(e,t.tripodIndex),e.u32(t.chainSkillEffect),e.u32(t.skillEffect),e.u32(t.skillId),e.u64(t.targetObjectId),e.u64(t.ownerId),e.u8(t.skillLevel),e.u64(t.projectileId),Ve(e,t.tripodLevel)}function Yn(e,t){let n={};return n.projectileInfo=so(e,t),n}function $n(e,t){oo(e,t.projectileInfo)}var Qn="NewProjectile";function Jn(e,t){let n={};return n.enable=e.bool(),n.paralyzationPoint=e.u32(),n.decreasePoint=e.u32(),n.paralyzationMaxPoint=e.u32(),n.noHitCheckTime=e.u32(),n.hitCheckTime=e.u32(),n.objectId=e.u64(),n}function Xn(e,t){e.bool(t.enable),e.u32(t.paralyzationPoint),e.u32(t.decreasePoint),e.u32(t.paralyzationMaxPoint),e.u32(t.noHitCheckTime),e.u32(t.hitCheckTime),e.u64(t.objectId)}var yn="ParalyzationStateNotify";function io(e,t){let n={};return n.maxHp=C(e,t),n.characterId=e.u64(),n.position=B(e,t),n.transitIndex=e.u32(),n.curHp=C(e,t),n.characterLevel=e.u16(),n.gearLevel=e.f32(),n.zoneId=e.u32(),n.partyMemberNumber=e.u8(),n.name=e.string(),n.zoneInstId=e.u64(),n.worldId=e.u8(),n.classId=e.u16(),n.auths=e.u8(),n}function ro(e,t){L(e,t.maxHp),e.u64(t.characterId),M(e,t.position),e.u32(t.transitIndex),L(e,t.curHp),e.u16(t.characterLevel),e.f32(t.gearLevel),e.u32(t.zoneId),e.u8(t.partyMemberNumber),e.string(t.name),e.u64(t.zoneInstId),e.u8(t.worldId),e.u16(t.classId),e.u8(t.auths)}function et(e,t){let n={};return n.raidInstanceId=e.u32(),n.lootGrade=e.u32(),n.partyType=e.u8(),n.partyInstanceId=e.u32(),n.partyLootType=e.u8(),n.memberDatas=e.array(e.u16(),()=>io(e,t)),n}function nt(e,t){e.u32(t.raidInstanceId),e.u32(t.lootGrade),e.u8(t.partyType),e.u32(t.partyInstanceId),e.u8(t.partyLootType),e.array(t.memberDatas,{lenType:"u16"},n=>{ro(e,n)})}var tt="PartyInfo";function at(e,t){let n={};return n.partyLeaveType=e.u8(),n.partyInstanceId=e.u32(),n.name=e.string(),n}function st(e,t){e.u8(t.partyLeaveType),e.u32(t.partyInstanceId),e.string(t.name)}var ot="PartyLeaveResult";function it(e,t){let n={};return n.objectId=e.u64(),n.passiveStatusEffectList=e.array(e.u16(),()=>e.u32()),n.unk0_m=e.u8(),n}function rt(e,t){e.u64(t.objectId),e.array(t.passiveStatusEffectList,{lenType:"u16"},n=>{e.u32(n)}),e.u8(t.unk0_m)}var _t="PartyPassiveStatusEffectAddNotify";function ut(e,t){let n={};return n.objectId=e.u64(),n.passiveStatusEffectList=e.array(e.u16(),()=>e.u32()),n}function lt(e,t){e.u64(t.objectId),e.array(t.passiveStatusEffectList,{lenType:"u16"},n=>{e.u32(n)})}var mt="PartyPassiveStatusEffectRemoveNotify";function dt(e,t){let n={};return n.characterId=e.u64(),n.statusEffectDatas=e.array(e.u16(),()=>F(e,t)),n.playerIdOnRefresh=e.u64(),n}function ct(e,t){e.u64(t.characterId),e.array(t.statusEffectDatas,{lenType:"u16"},n=>{U(e,n)}),e.u64(t.playerIdOnRefresh)}var ft="PartyStatusEffectAddNotify";function ht(e,t){let n={};return n.characterId=e.u64(),n.statusEffectIds=e.array(e.u16(),()=>e.u32()),n.reason=e.u8(),n}function St(e,t){e.u64(t.characterId),e.array(t.statusEffectIds,{lenType:"u16"},n=>{e.u32(n)}),e.u8(t.reason)}var pt="PartyStatusEffectRemoveNotify";function vt(e,t){let n={};return n.partyInstanceId=e.u32(),n.raidInstanceId=e.u32(),n.characterId=e.u64(),n}function It(e,t){e.u32(t.partyInstanceId),e.u32(t.raidInstanceId),e.u64(t.characterId)}var Et="PartyStatusEffectResultNotify";function xt(e,t){let n={};return n.passiveStatusEffectList=e.array(e.u16(),()=>e.u32()),n}function bt(e,t){e.array(t.passiveStatusEffectList,{lenType:"u16"},n=>{e.u32(n)})}var kt="PassiveStatusEffectAddNotify";function Dt(e,t){let n={};return n.passiveStatusEffectList=e.array(e.u16(),()=>e.u32()),n}function Nt(e,t){e.array(t.passiveStatusEffectList,{lenType:"u16"},n=>{e.u32(n)})}var Tt="PassiveStatusEffectRemoveNotify";function Pt(e,t){let n={};return t>=4?n.typeId=e.u32():n.typeId=0,n}function Rt(e,t){e.u32(t.typeId)}var wt="RaidBossKillNotify";function gt(e,t){let n={};return t>=3?n.raidResult=e.u8():n.raidResult=0,n}function Ct(e,t){e.u8(t.raidResult)}var Lt="RaidResult";function _o(e,t){let n={};return n.unpublishReason=e.u8(),n.objectId=e.u64(),n}function uo(e,t){e.u8(t.unpublishReason),e.u64(t.objectId)}function At(e,t){let n={};return n.unpublishedObjects=e.array(e.u16(),()=>_o(e,t)),n}function Bt(e,t){e.array(t.unpublishedObjects,{lenType:"u16"},n=>{uo(e,n)})}var Mt="RemoveObject";function lo(e,t=0){let n={},a=e.u8();return a&1&&(n.moveTime=e.u32()),a&2&&(n.standUpTime=e.u32()),a&4&&(n.downTime=e.u32()),a&8&&(n.freezeTime=e.u32()),a&16&&(n.moveHeight=e.u32()),a&32&&(n.farmostDist=e.u32()),a&64&&(n.flag40=e.bytes(e.u16(),6)),n}function mo(e,t){let n=(t.moveTime===void 0?0:1)|(t.standUpTime===void 0?0:2)|(t.downTime===void 0?0:4)|(t.freezeTime===void 0?0:8)|(t.moveHeight===void 0?0:16)|(t.farmostDist===void 0?0:32)|(t.flag40===void 0?0:64);e.u8(n),n&1&&e.u32(t.moveTime),n&2&&e.u32(t.standUpTime),n&4&&e.u32(t.downTime),n&8&&e.u32(t.freezeTime),n&16&&e.u32(t.moveHeight),n&32&&e.u32(t.farmostDist),n&64&&e.bytes(t.flag40,{maxLen:6,lenType:"u16"})}function He(e,t){let n={};return n.modifier=e.u8(),n.targetId=e.u64(),n.damageType=e.u8(),e.bool()&&(n.damageAttr=e.u8()),n.curHp=C(e,t),n.unk3_m=e.u16(),n.maxHp=C(e,t),n.damage=C(e,t),n}function qe(e,t){e.u8(t.modifier),e.u64(t.targetId),e.u8(t.damageType),e.bool(t.damageAttr!==void 0)&&e.u8(t.damageAttr),L(e,t.curHp),e.u16(t.unk3_m),L(e,t.maxHp),L(e,t.damage)}function fo(e,t){let n={};return n.skillMoveOptionData=lo(e,t),n.destination=B(e,t),n.position=B(e,t),n.skillDamageEvent=He(e,t),n}function ho(e,t){mo(e,t.skillMoveOptionData),M(e,t.destination),M(e,t.position),qe(e,t.skillDamageEvent)}function Ot(e,t){let n={};return n.skillId=e.u32(),n.skillDamageAbnormalMoveEvents=e.array(e.u16(),()=>fo(e,t)),n.skillEffectId=e.u32(),n.sourceId=e.u64(),n}function Wt(e,t){e.u32(t.skillId),e.array(t.skillDamageAbnormalMoveEvents,{lenType:"u16"},n=>{ho(e,n)}),e.u32(t.skillEffectId),e.u64(t.sourceId)}var jt="SkillDamageAbnormalMoveNotify";function Ft(e,t){let n={};return n.skillLevel=e.u8(),n.sourceId=e.u64(),n.skillId=e.u32(),n.skillDamageEvents=e.array(e.u16(),()=>He(e,t)),n.skillEffectId=e.u32(),n}function Ut(e,t){e.u8(t.skillLevel),e.u64(t.sourceId),e.u32(t.skillId),e.array(t.skillDamageEvents,{lenType:"u16"},n=>{qe(e,n)}),e.u32(t.skillEffectId??0)}var Vt="SkillDamageNotify";function Ht(e,t){let n={};return n.sourceId=e.u64(),n.skillId=e.u32(),n.stage=e.u8(),n}function qt(e,t){e.u64(t.sourceId),e.u32(t.skillId),e.u8(t.stage)}var Gt="SkillStageNotify";function So(e,t=0){let n={},a=e.u8();return a&1&&(n.layerIndex=e.u8()),a&2&&(n.startStageIndex=e.u8()),a&4&&(n.transitIndex=e.u32()),a&8&&(n.stageStartTime=e.u32()),a&16&&(n.farmostDistance=e.u32()),a&32&&(n.tripodIndex=je(e)),a&64&&(n.tripodLevel=Ue(e)),n}function po(e,t){let n=(t.layerIndex===void 0?0:1)|(t.startStageIndex===void 0?0:2)|(t.transitIndex===void 0?0:4)|(t.stageStartTime===void 0?0:8)|(t.farmostDistance===void 0?0:16)|(t.tripodIndex===void 0?0:32)|(t.tripodLevel===void 0?0:64);e.u8(n),n&1&&e.u8(t.layerIndex),n&2&&e.u8(t.startStageIndex),n&4&&e.u32(t.transitIndex),n&8&&e.u32(t.stageStartTime),n&16&&e.u32(t.farmostDistance),n&32&&Fe(e,t.tripodIndex),n&64&&Ve(e,t.tripodLevel)}function Zt(e,t){let n={};return n.sourceId=e.u64(),n.curDirectionYaw=q(e,t),n.newDirectionYaw=q(e,t),n.aimTargetPosition=B(e,t),e.bool()&&(n.pitchRotation=q(e,t)),e.bool()&&(n.aiStateId=e.u32()),n.curPosition=B(e,t),e.bool()&&(n.unk1_m=e.u32()),n.skillLevel=e.u8(),n.newPosition=B(e,t),n.skillId=e.u32(),n.skillOptionData=So(e,t),n}function zt(e,t){e.u64(t.sourceId),G(e,t.curDirectionYaw),G(e,t.newDirectionYaw),M(e,t.aimTargetPosition),e.bool(t.pitchRotation!==void 0)&&G(e,t.pitchRotation),e.bool(t.aiStateId!==void 0)&&e.u32(t.aiStateId),M(e,t.curPosition),e.bool(t.unk1_m!==void 0)&&e.u32(t.unk1_m),e.u8(t.skillLevel),M(e,t.newPosition),e.u32(t.skillId),po(e,t.skillOptionData)}var Kt="SkillStartNotify";function Yt(e,t){let n={};return n.statusEffectData=F(e,t),n.objectId=e.u64(),n.new=e.bool(),n}function $t(e,t){U(e,t.statusEffectData),e.u64(t.objectId),e.bool(t.new)}var Qt="StatusEffectAddNotify";function Jt(e,t){let n={};return n.statusEffectIds=e.array(e.u16(),()=>e.u32()),n.objectId=e.u64(),n.reason=e.u8(),n}function Xt(e,t){e.array(t.statusEffectIds,{lenType:"u16"},n=>{e.u32(n)}),e.u64(t.objectId),e.u8(t.reason)}var yt="StatusEffectRemoveNotify";function ea(e,t){let n={};return n.effectInstanceId=e.u32(),n.targetId=e.u64(),n.expirationTick=e.u64(),n}function na(e,t){e.u32(t.effectInstanceId),e.u64(t.targetId),e.u64(t.expirationTick)}var ta="StatusEffectDurationNotify";function aa(e,t){let n={};return n.objectId=e.u64(),n.effectInstanceId=e.u32(),n.characterId=e.u64(),n.value=e.u32(),n}function sa(e,t){e.u64(t.objectId),e.u32(t.effectInstanceId),e.u64(t.characterId),e.u32(t.value)}var oa="StatusEffectSyncDataNotify";function ia(e,t){let n={};return n.step=e.u32(),n.unk2_m=e.bool(),n.triggerId=e.u32(),n}function ra(e,t){e.u32(t.step),e.bool(t.unk2_m),e.u32(t.triggerId)}var _a="TriggerBossBattleStatus";function ua(e,t){let n={};return n.packetResultCode=e.u32(),n.triggerId=e.u32(),n.unk0_m=e.u32(),n.involvedPCs=e.array(e.u16(),()=>e.u64()),n}function la(e,t){e.u32(t.packetResultCode),e.u32(t.triggerId),e.u32(t.unk0_m),e.array(t.involvedPCs,{lenType:"u16"},n=>{e.u64(n)})}var ma="TriggerFinishNotify";function da(e,t){let n={};return n.triggerId=e.u32(),n.triggerSignalType=e.u32(),n.sourceId=e.u64(),n.involvedPCs=e.array(e.u16(),()=>e.u64()),n}function ca(e,t){e.u32(t.triggerId),e.u32(t.triggerSignalType),e.u64(t.sourceId),e.array(t.involvedPCs,{lenType:"u16"},n=>{e.u64(n)})}var fa="TriggerStartNotify";function ha(e,t){let n={};return n.maxHp=C(e,t),n.characterId=e.u64(),n.unk0_m=e.u32(),n.statusEffectDatas=e.array(e.u16(),()=>F(e,t)),n.position=e.u64(),n.curHp=C(e,t),n}function Sa(e,t){L(e,t.maxHp),e.u64(t.characterId),e.u32(t.unk0_m),e.array(t.statusEffectDatas,{lenType:"u16"},n=>{U(e,n)}),e.u64(t.position),L(e,t.curHp)}var pa="TroopMemberUpdateMinNotify";function va(e,t){let n={};return n.identityGauge1=e.u32(),n.identityGauge2=e.u32(),n.identityGauge3=e.u32(),n.playerId=e.u64(),n}function Ia(e,t){e.u32(t.identityGauge1),e.u32(t.identityGauge2),e.u32(t.identityGauge3),e.u64(t.playerId)}var Ea="IdentityGaugeChangeNotify";function xa(e,t){let n={};return n.objectId=e.u64(),n}function ba(e,t){e.u64(t.objectId)}var ka="ZoneObjectUnpublishNotify";function vo(e,t){let n={};return n.stackCount=e.u8(),n.target=e.u8(),n.id=e.u32(),n}function Io(e,t){e.u8(t.stackCount),e.u8(t.target),e.u32(t.id)}function Da(e,t){let n={};return n.zoneStatusEffectDataList=e.array(e.u16(),()=>vo(e,t)),n}function Na(e,t){e.array(t.zoneStatusEffectDataList,{lenType:"u16"},n=>{Io(e,n)})}var Ta="ZoneStatusEffectAddNotify";function Pa(e,t){let n={};return n.statusEffectId=e.u32(),n}function Ra(e,t){e.u32(t.statusEffectId)}var wa="ZoneStatusEffectRemoveNotify";function ga(e,t){let n={};return n.skillLevel=e.u8(),n.caster=e.u64(),n.skillId=e.u32(),n}function Ca(e,t){e.u8(t.skillLevel),e.u64(t.caster),e.u32(t.skillId)}var La="SkillCastNotify";function Aa(e,t){let n={};return n.objectId=e.u64(),n.stance=e.u8(),n}function Ba(e,t){e.u64(t.objectId),e.u8(t.stance)}var Ma="IdentityStanceChangeNotify";function Oa(e,t){let n={};return n.objectId=e.u64(),n.equipItemDataList=e.array(e.u16(),()=>X(e,t)),n}function Wa(e,t){e.u64(t.objectId),e.array(t.equipItemDataList,{lenType:"u16"},n=>{y(e,n)})}var ja="EquipChangeNotify";function Fa(e,t){let n={};return n.objectId=e.u64(),n.equipLifeToolDataList=e.array(e.u16(),()=>X(e,t)),n}function Ua(e,t){e.u64(t.objectId),e.array(t.equipLifeToolDataList,{lenType:"u16"},n=>{y(e,n)})}var Va="EquipLifeToolChangeNotify";function Eo(e,t){let n={};return e.bool()&&(n.serialNumber=e.u64(),n.id=e.u32(),n.level=e.u16(),n.slot=e.u16(),n.durability=e.u32(),n.unk1_6_m=e.u32(),n.flag=e.u32(),n.expireTime=K(e),n.lockUpdateTime=K(e)),n}function xo(e,t){e.bool(t.slot!==void 0)&&(e.u64(t.serialNumber),e.u32(t.id),e.u16(t.level),e.u16(t.slot),e.u32(t.durability),e.u32(t.unk1_6_m),e.u32(t.flag),Y(e,t.expireTime),Y(e,t.lockUpdateTime))}function Ha(e,t){let n={};return n.itemDataList=e.array(e.u16(),()=>Eo(e,t)),n.storageType=e.u8(),n}function qa(e,t){e.array([1,20].includes(t.storageType)?t.itemDataList:[],{lenType:"u16"},n=>{xo(e,n)}),e.u8(t.storageType)}var Ga="InitItem";function bo(e,t){let n={};return n.npcId=e.u32(),n.isDead=e.bool(),n}function ko(e,t){e.u32(t.npcId),e.bool(t.isDead)}function Za(e,t){let n={};return n.raidResult=e.u8(),n.raidId=e.u32(),n.totalTime=e.u64(),n.bossKillDataList=e.array(e.u16(),()=>bo(e,t)),n.endTick=e.u64(),n.startTick=e.u64(),n}function za(e,t){e.u8(t.raidResult),e.u32(t.raidId),e.u64(t.totalTime),e.array(t.bossKillDataList,{lenType:"u16"},n=>{ko(e,n)}),e.u64(t.endTick),e.u64(t.startTick)}var Ka="RaidBegin";function Ya(e,t){let n={};return n.zoneInstId=e.u64(),n.zoneId=e.u32(),n.loadComplete=e.bool(),n.completeMembers=e.array(e.u16(),()=>e.u64()),n.totalMembers=e.array(e.u16(),()=>e.u64()),n.firstPCEnterTick=e.u64(),n.zoneLevel=e.u8(),n}function $a(e,t){e.u64(t.zoneInstId),e.u32(t.zoneId),e.bool(t.loadComplete),e.array(t.completeMembers,{lenType:"u16"},n=>{e.u64(n)}),e.array(t.totalMembers,{lenType:"u16"},n=>{e.u64(n)}),e.u64(t.firstPCEnterTick),e.u8(t.zoneLevel)}var Qa="ZoneMemberLoadStatusNotify";function Do(e,t){let n={};return n.position=B(e),n.objectId=e.u64(),n.ownerId=e.u64(),n.skillId=e.u32(),n.skillEffect=e.u32(),n}function No(e,t){M(e,t.position),e.u64(t.objectId),e.u64(t.ownerId),e.u32(t.skillId),e.u32(t.skillEffect)}function Ja(e,t){let n={};return n.trapData=Do(e,t),n}function Xa(e,t){No(e,t.trapData)}var ya="NewTrap";function es(e,t){let n={};return n.skillId=e.u32(),n.caster=e.u64(),n.newDirectionYaw=q(e),n.cancelReason=e.u8(),n.newPosition=B(e),n}function ns(e,t){e.u32(t.skillId),e.u64(t.caster),G(e,t.newDirectionYaw),e.u8(t.cancelReason),M(e,t.newPosition)}var ts="SkillCancelNotify";function as(e,t){let n={};return n.players=e.array(e.u8(),()=>{let a={};return a.name=e.string(),a.stats=e.array(e.u8(),()=>{let o={};return o.id=e.u8(),o.value=e.u32(),o}),t>=4&&(a.elixirs=e.array(e.u8(),()=>{let o={};return o.slot=e.u8(),o.entries=e.array(e.u8(),()=>{let i={};return i.level=e.u8(),i.id=e.u32(),i}),o})),t>=5&&(a.gems=e.array(e.u8(),()=>{let o={};return o.id=e.u32(),o.skillId=e.u32(),o.type=e.u8(),o.value=e.u16(),o})),a}),n}function ss(e,t){e.array(t.players,{lenType:"u8"},n=>{e.string(n.name),e.array(n.stats,{lenType:"u8"},a=>{e.u8(a.id),e.u32(a.value)}),e.array(n.elixirs,{lenType:"u8"},a=>{e.u8(a.slot),e.array(a.entries,{lenType:"u8"},o=>{e.u8(o.level),e.u32(o.id)})}),e.array(n.gems,{lenType:"u8"},a=>{e.u32(a.id),e.u32(a.skillId),e.u8(a.type),e.u16(a.value)})})}var os="APP_StatApi";var To=new Map([[0,[sn,tn,an]],[1,[_n,on,rn]],[2,[mn,un,ln]],[4,[fn,dn,cn]],[5,[pn,hn,Sn]],[6,[En,vn,In]],[7,[kn,xn,bn]],[8,[Tn,Dn,Nn]],[9,[Cn,wn,gn]],[10,[Bn,Ln,An]],[11,[On,Mn,Ee]],[12,[Un,jn,Fn]],[13,[qn,Vn,Hn]],[14,[Kn,Zn,zn]],[15,[Qn,Yn,$n]],[16,[yn,Jn,Xn]],[17,[tt,et,nt]],[18,[ot,at,st]],[19,[_t,it,rt]],[20,[mt,ut,lt]],[21,[ft,dt,ct]],[22,[pt,ht,St]],[23,[Et,vt,It]],[24,[kt,xt,bt]],[25,[Tt,Dt,Nt]],[26,[wt,Pt,Rt]],[27,[Lt,gt,Ct]],[28,[Mt,At,Bt]],[29,[jt,Ot,Wt]],[30,[Vt,Ft,Ut]],[31,[Gt,Ht,qt]],[32,[Kt,Zt,zt]],[34,[Qt,Yt,$t]],[35,[yt,Jt,Xt]],[36,[ta,ea,na]],[37,[oa,aa,sa]],[38,[_a,ia,ra]],[39,[ma,ua,la]],[40,[fa,da,ca]],[41,[pa,ha,Sa]],[42,[Ea,va,Ia]],[43,[ka,xa,ba]],[44,[Ta,Da,Na]],[45,[wa,Pa,Ra]],[46,[La,ga,Ca]],[47,[Ma,Aa,Ba]],[48,[ja,Oa,Wa]],[49,[Va,Fa,Ua]],[50,[Ga,Ha,qa]],[52,[Ka,Za,za]],[51,[Qa,Ya,$a]],[53,[ya,Ja,Xa]],[54,[ts,es,ns]],[6e4,[os,as,ss]]]);var me=class{b;o;constructor(t){this.b=t,this.o=0}skip(t=0){this.o+=t}bool(){return this.u8()===1}u8(){return this.b.readUint8(this.o++)}i8(){return this.b.readInt8(this.o++)}u16(){let t=this.b.readUint16LE(this.o);return this.o+=2,t}i16(){let t=this.b.readInt16LE(this.o);return this.o+=2,t}u32(){let t=this.b.readUint32LE(this.o);return this.o+=4,t}i32(){let t=this.b.readInt32LE(this.o);return this.o+=4,t}u48(){let t=this.b.readUIntLE(this.o,6);return this.o+=6,t}i48(){let t=this.b.readIntLE(this.o,6);return this.o+=6,t}f32(){let t=this.b.readFloatLE(this.o);return this.o+=4,t}u64(){let t=this.b.readBigUint64LE(this.o);return this.o+=8,t}i64(){let t=this.b.readBigInt64LE(this.o);return this.o+=8,t}string(t){let n=this.u16();if(!t||n<=t){n=n*2;let a=this.b.toString("utf16le",this.o,this.o+n);return this.o+=n,a}return""}bytes(t=0,n,a){if(n&&t>n)return Buffer.alloc(0);a&&(t=t*a);let o=Buffer.from(this.b.subarray(this.o,this.o+t));return this.o+=t,o}array(t,n,a){return a&&t>a?[]:new Array(t).fill(void 0).map(n)}},de=class{b;o;constructor(t=65535){this.b=Buffer.allocUnsafe(t),this.o=0}get value(){return this.b.subarray(0,this.o)}skip(t=0){this.o+=t}bool(t=!1){return this.u8(t?1:0),t}u8(t=0){this.b.writeUInt8(t,this.o++)}i8(t=0){this.b.writeInt8(t,this.o++)}u16(t=0){this.o=this.b.writeUInt16LE(t,this.o)}i16(t=0){this.o=this.b.writeInt16LE(t,this.o)}u32(t=0){this.o=this.b.writeUInt32LE(t,this.o)}i32(t=0){this.o=this.b.writeInt32LE(t,this.o)}u48(t=0){this.o=this.b.writeUIntLE(t,this.o,6)}i48(t=0){this.o=this.b.writeIntLE(t,this.o,6)}f32(t=0){this.o=this.b.writeFloatLE(t,this.o)}u64(t=0n){this.o=this.b.writeBigUInt64LE(BigInt(t),this.o)}i64(t=0n){this.o=this.b.writeBigInt64LE(BigInt(t),this.o)}string(t="",n){this.u16(t.length),(!n||t.length<=n)&&(this.o+=this.b.write(t,this.o,"utf16le"))}bytes(t=Buffer.alloc(0),n={}){if(n.maxLen!==void 0){let a=n.multiplier??1;if(t.length%a)throw new Error(`Error writing bytes, chunkSize should be a multiple of intut value size, got ${t.length}%${a}`);let o=t.length/a;if(n.maxLen&&o>n.maxLen)throw new Error(`Error writing bytes, input value size exceeded maxLen, got ${o} > ${n.maxLen}`);if(!n.lenType)throw new Error(`Error writing bytes, invalid lenType when writing chunks, got ${n.lenType}`);this[n.lenType](o)}else if(n.length&&t.length!==n.length)throw new Error(`Error writing bytes, input value size doesn't match opts.length, ${t.length} !== ${n.lenType}`);this.o+=t.copy(this.b,this.o)}array(t=[],n,a){if(t===void 0||n.maxLen&&t.length>n.maxLen){this[n.lenType](0);return}this[n.lenType](t.length),t.forEach(a)}};var ce=class{time;#e;#o;#a;#i;constructor(...t){if(t.length===5){let[n,a,o,i,s]=t;this.#o=n,this.time=o,this.#e=a,this.#a=i,this.#i=s}else if(t.length===3){let[n,a,o]=t;this.#o=Buffer.alloc(0),this.time=new Date,this.#e=a,this.#a=()=>n,this.#i=o}else throw new Error("[meter-core/logger/parser] - LogEvent<T>: Invalid constructor arguments")}#n;get parsed(){if(!this.#n)try{this.#n=this.#a(new me(this.#o))}catch(t){console.error(`[meter-core/logger/parser] - parsed - ${t}`);return}return this.#n}#t;get serialized(){if(!this.#t)try{if(!this.parsed)return;let t=new de;t.skip(go),this.#i(t,this.parsed);let n=t.value;n.writeUint16LE(n.length,Ro),n.writeUint16LE(this.#e,_s),n.writeUintLE(+new Date,wo,us),this.#t=t.value}catch(t){console.error(`[meter-core/logger/parser] - serialized - ${t}`);return}return this.#t}},is=6,Po=2,Ro=0,rs=2,_s=Ro+Po,us=6,wo=_s+rs,go=Po+rs+us;var Bo=require("fs");var xe=class{buffer;position;out;constructor(){this.buffer=null,this.position=0,this.out=[]}write(t){for(;t.length>0;){if(this.buffer){if(this.buffer.length<2){let o=this.buffer[0],i=(t[0]<<8)+o;this.buffer=Buffer.alloc(i),this.buffer[0]=o,this.position=1}let a=Math.min(t.length,this.buffer.length-this.position);t.copy(this.buffer,this.position,0,a),this.position+=a,this.position===this.buffer.length&&(this.out.push(this.buffer),this.buffer=null,this.position=0),t=t.subarray(a);continue}if(t.length<2){this.buffer=Buffer.from(t),this.position=t.length;break}let n=t.readUInt16LE(0);if(n===0){this.buffer=null;return}if(n>t.length){this.buffer=Buffer.alloc(n),t.copy(this.buffer),this.position=t.length;break}this.out.push(t.subarray(0,n)),t=t.subarray(n)}}read(){return this.out.shift()}};var Vs=Ks(require("net")),Co=require("tiny-typed-emitter");var Ge=(f=>(f[f.CC_Auth=0]="CC_Auth",f[f.CS_Auth=1]="CS_Auth",f[f.CC_Data=2]="CC_Data",f[f.CS_Data=3]="CS_Data",f[f.CC_Logout=4]="CC_Logout",f[f.CC_OnConnect=5]="CC_OnConnect",f[f.CS_SyncDmg=1e3]="CS_SyncDmg",f[f.CS_SyncZone=1001]="CS_SyncZone",f[f.CS_Error=6e4]="CS_Error",f[f.CCS_PingPong=60001]="CCS_PingPong",f))(Ge||{});function ls(e){let t={};return t.version=e.u32(),t.token=e.string(7168),t}function ms(e,t){e.u32(t.version),e.string(t.token,7168)}var ds="CC_Auth";function cs(e){let t={};return t.opcodes=e.array(e.u16(),()=>e.u16(),3e3),t.xorkey=e.bytes(256),t.migration=e.u16(),t}function fs(e,t){e.array(t.opcodes,{maxLen:3e3,lenType:"u16"},n=>{e.u16(n)}),e.bytes(t.xorkey,{length:256}),e.u16(t.migration)}var hs="CS_Auth";function Ss(e){let t={};return t.opcode=e.u16(),t.timestamp=e.bytes(6).readUIntLE(0,6),t.data=e.bytes(e.u16(),65522),t}function ps(e,t){let n=Buffer.alloc(6);n.writeUintLE(t.timestamp,0,6),e.u16(t.opcode),e.bytes(n,{length:6}),e.bytes(t.data,{maxLen:65522,lenType:"u16"})}var vs="CC_Data";function Is(e){let t={};return t.logId=e.u16(),t.timestamp=e.bytes(6).readUIntLE(0,6),t.data=e.bytes(e.u16(),65522),t}function Es(e,t){let n=Buffer.alloc(6);n.writeUintLE(t.timestamp,0,6),e.u16(t.logId),e.bytes(n,{length:6}),e.bytes(t.data,{maxLen:65522,lenType:"u16"})}var xs="CS_Data";function bs(e){return{}}function ks(e,t){}var Ds="CC_Logout";function Ns(e){let t={};return t.ip=e.string(21),t}function Ts(e,t){e.string(t.ip,21)}var Ps="CC_OnConnect";function Rs(e){let t={};return t.table=e.array(e.u8(),()=>({name:e.string(),typeId:e.u16(),dealt:e.i48(),crit:e.u16(),fa:e.u16(),ba:e.u16(),receivedDps:e.i48(),receivedSupp:e.i48(),given:e.i48(),deadDuration:e.u32()})),t.duration=e.u32(),t}function ws(e,t){e.array(t.table,{lenType:"u8"},n=>{e.string(n.name),e.u16(n.typeId),e.i48(n.dealt),e.u16(n.crit),e.u16(n.fa),e.u16(n.ba),e.i48(n.receivedDps),e.i48(n.receivedSupp),e.i48(n.given),e.u32(n.deadDuration)}),e.u32(t.duration)}var gs="CS_SyncDmg";function Cs(e){let t={};return t.isValid=e.bool(),t}function Ls(e,t){e.bool(t.isValid)}var As="CS_SyncZone";function Bs(e){let t={};return t.code=e.u32(),t.msg=e.string(7168),t}function Ms(e,t){e.u32(t.code),e.string(t.msg,7168)}var Os="CS_Error";function Ws(e){return{}}function js(e,t){}var Fs="CCS_PingPong";var Us=new Map([[0,[ds,ls,ms]],[1,[hs,cs,fs]],[2,[vs,Ss,ps]],[3,[xs,Is,Es]],[4,[Ds,bs,ks]],[5,[Ps,Ns,Ts]],[1e3,[gs,Rs,ws]],[1001,[As,Cs,Ls]],[6e4,[Os,Bs,Ms]],[60001,[Fs,Ws,js]]]);var be=class{#e;#o;#a;constructor(t,n,a){this.#e=t,this.#o=n,this.#a=a}#i;get parsed(){if(!this.#i)try{this.#i=this.#a(new me(this.#e))}catch{return}return this.#i}};var Lo=Ks(require("axios"));var Ze=class extends Co.TypedEmitter{socket;serverList=[];token;#e=[];connState=6;reconnectTimeout;gameIdleTimeout;constructor(t){super(),this.socket=new Vs.default.Socket,this.token=t,t&&this.setAuthState(0);let n=new xe;this.socket.on("data",a=>{n.write(a);let o;for(;o=n.read();){if(o.length<4||o.readUint16LE(0)!=o.length)continue;let s=o.readUint16LE(2),u=Us.get(s);if(u){let[m,d,f]=u;this.emit(m,new be(Buffer.from(o.subarray(4)),s,d)),this.emit("*",m,new be(Buffer.from(o.subarray(4)),s,d))}}}).on("close",()=>{this.destroy(),[2,3,4,5,0].includes(this.connState)&&(this.setAuthState(0),clearTimeout(this.reconnectTimeout),this.reconnectTimeout=setTimeout(()=>{this.reconnect()},5e3))}).on("error",a=>{console.log(`Conn error ${a}`)}).on("connect",()=>{this.token?(this.setAuthState(3),this.#o(this.prepare("CC_Auth",{token:this.token,version:5}))):(this.setAuthState(6),this.destroy())}),this.reconnect()}destroy(){this.socket.destroy()}reconnect(){[0,1].includes(this.connState)&&(this.setAuthState(2),this.getBestServer().then(t=>{t&&this.connState===2&&(console.info(`[CloudConnection] - Picked node: ${t.ip}:${t.port} with latency ${t.latency}`),this.socket.connect(t.port,t.ip))}))}async getBestServer(){let t=await Lo.default.get("https://nodes-la.herysia.com/nodes");if(!(t.status!==200&&t.status!==304))return Promise.all([...t.data.map(n=>({ip:n,port:8001})),...this.serverList].map(({ip:n,port:a})=>this.getLatency(n,a))).then(n=>n.reduce((a,o)=>a&&a.latency<o.latency?a:o))}getLatency(t,n){return new Promise(a=>{let o=new Vs.default.Socket,i=+new Date;o.setTimeout(5e3),o.on("error",s=>{o.destroy(),a({ip:t,port:n,latency:5e3})}),o.on("timeout",()=>{o.destroy(),a({ip:t,port:n,latency:5e3})}),o.connect(n,t,()=>{o.destroy(),a({ip:t,port:n,latency:+new Date-i})})})}prepare(t,n){let a=Ge[t],o=Us.get(a);if(o){let[i,s,u]=o;try{let m=new de;m.skip(4),u(m,n);let d=m.value;return d.writeUint16LE(d.length),d.writeUint16LE(a,2),d}catch{}}}send(t,n){let a;(a=this.prepare(t,n))&&this.#e.push(a),this.flushQueue()}async flushQueue(){switch(this.connState){case 0:case 1:break;case 4:this.connState=5;let t,n;for([t,n]of this.#e.entries())if(!await this.#o(n))break;this.#e.splice(0,(t??0)+1),this.connState===5&&(this.connState=4);break;case 6:case 2:case 5:case 3:default:break}}#o(t){return new Promise(n=>{if(!t)return n(!0);this.socket.write(t,a=>{a&&console.log(a),n(!a)})})}failAuth(){this.setAuthState(6),this.destroy()}setError(){this.setAuthState(7),this.destroy()}setAuthState(t){this.connState=t,this.emit("authState",t)}initGameIdleTimeout(){this.gameIdleTimeout?this.gameIdleTimeout.refresh():this.gameIdleTimeout=setTimeout(()=>{console.info("[CloudConnection] - No game packets detected, logging out"),[7,6].includes(this.connState)||this.setAuthState(1),this.destroy()},3e5)}updateAuthToken(t){this.token=t,t&&this.connState===6&&(this.connState=0,this.reconnect())}};var Hs=class extends Ao.TypedEmitter{},Ke=class extends Hs{#e;#o;#a;#i=[];#n=0;#t=!1;ip;constructor(t,n,a){super(),this.#e=n,this.#a=new Ze,this.#a.on("CS_Auth",i=>{let s=i.parsed;s&&(this.#i=s.opcodes,this.#e.xorTable=s.xorkey,this.#n=s.migration,this.#a.connState===3&&this.#a.setAuthState(4),this.#a.initGameIdleTimeout())}).on("CS_Data",this.handlePkt.bind(this)).on("CS_Error",i=>{switch(i.parsed?.code){case 0:case 8:this.#a.failAuth();break;case 2:this.#a.setError();break;case 10:this.#a.failAuth();break;case 6e4:this.#t=!0;break;case 5:case 4:break;case 1:case 3:case 6:case 7:case 9:default:break}console.error(`[meter-core/logger] - cloud error (${i.parsed?.code}): ${i.parsed?.msg}`)}).on("CCS_PingPong",()=>{this.#a.send("CCS_PingPong",{})}).on("CS_SyncDmg",i=>{let s=i.parsed;s&&this.emit("syncDmg",s)}).on("CS_SyncZone",i=>{let s=i.parsed;s&&this.emit("syncZone",s)}).on("authState",i=>{this.emit("authState",i)}),a&&(this.#o=(0,Bo.createWriteStream)(a,{highWaterMark:0}));let o=Buffer.allocUnsafe(is);o.writeUIntLE(5,0,is),this.#o?.write(o),t.on("*",(i,s,u,m)=>{try{if(this.#a.gameIdleTimeout?.refresh(),this.#t&&s===this.#n&&(this.#a.setAuthState(0),this.#a.destroy(),this.ip&&this.#a.send("CC_OnConnect",{ip:this.ip})),this.#i.includes(s)&&this.#e.xorTable){let d=+new Date,f=this.#e.decrypt(i,s,u,m);this.#a.send("CC_Data",{data:f,opcode:s,timestamp:d})}}catch(d){console.error(d)}})}handlePkt(t){try{let n=t.parsed;if(n){let a=To.get(n.logId);if(a){let[o,i,s]=a,u=new ce(n.data,n.logId,new Date(n.timestamp),m=>i(m,5),s);this.emit(o,u),this.emit("*",o,u),this.appendLog(u)}}}catch(n){console.error(n)}}appendLog(t){this.#o&&t.serialized&&this.#o.write(t.serialized)}onConnect(t){this.ip=t,this.#a.send("CC_OnConnect",{ip:t})}updateAuthToken(t){this.#a.updateAuthToken(t)}forceUpdateAuthState(){[0,1,2,3,4,6,7].includes(this.#a.connState)&&this.emit("authState",this.#a.connState)}};var Ye=class{characterIdToPartyId;entityIdToPartyId;raidInstanceToPartyInstances;ownName;characterNameToCharacterId;#e;constructor(t){this.characterIdToPartyId=new Map,this.entityIdToPartyId=new Map,this.raidInstanceToPartyInstances=new Map,this.characterNameToCharacterId=new Map,this.#e=t}add(t,n,a=void 0,o=void 0,i=void 0){!a&&!o||(a&&!o&&(o=this.#e.getEntityId(a)),o&&!a&&(a=this.#e.getEntityId(o)),a&&this.characterIdToPartyId.set(a,n),o&&this.entityIdToPartyId.set(o,n),i&&a&&this.characterNameToCharacterId.set(i,a),this.registerPartyId(t,n))}completeEntry(t,n){let a=this.getPartyIdFromCharacterId(t),o=this.getPartyIdFromEntityId(n);a&&o||(!a&&o&&this.characterIdToPartyId.set(t,o),!o&&a&&this.entityIdToPartyId.set(n,a))}changeEntityId(t,n){let a=this.getPartyIdFromEntityId(t);a&&(this.entityIdToPartyId.delete(t),this.entityIdToPartyId.set(n,a))}setOwnName(t){this.ownName=t}remove(t,n){if(n===this.ownName){this.removePartyMappings(t);return}let a=this.characterNameToCharacterId.get(n);if(this.characterNameToCharacterId.delete(n),!a)return;this.characterIdToPartyId.delete(a);let o=this.#e.getEntityId(a);o&&this.entityIdToPartyId.delete(o)}isCharacterInParty(t){return this.characterIdToPartyId.has(t)}isEntityInParty(t){return this.entityIdToPartyId.has(t)}getPartyIdFromCharacterId(t){return this.characterIdToPartyId.get(t)}getPartyIdFromEntityId(t){return this.entityIdToPartyId.get(t)}removePartyMappings(t){let n=this.getRaidInstanceId(t),a=n?this.raidInstanceToPartyInstances.get(n)??new Set([t]):new Set([t]);for(let[o,i]of this.characterIdToPartyId)if(a.has(i)){this.characterIdToPartyId.delete(o);for(let[s,u]of this.characterNameToCharacterId)if(o===u){this.characterNameToCharacterId.delete(s);break}}for(let[o,i]of this.entityIdToPartyId)a.has(i)&&this.entityIdToPartyId.delete(o)}getRaidInstanceId(t){for(let[n,a]of this.raidInstanceToPartyInstances)if(a.has(t))return n}registerPartyId(t,n){let a=this.raidInstanceToPartyInstances.get(t);a||(a=new Set,this.raidInstanceToPartyInstances.set(t,a)),a.add(n)}partyInfo(t,n,a){let o=t.parsed;if(o){if(o.memberDatas.length===1&&o.memberDatas[0]?.name===a.name){this.remove(o.partyInstanceId,o.memberDatas[0].name);return}for(let i of o.memberDatas){i.characterId===a.characterId&&this.setOwnName(i.name);let s=this.#e.getEntityId(i.characterId);if(s){let u=n.get(s);if(u&&u.entityType===1&&u.name!==i.name){let m=u;m.gearLevel=i.gearLevel,m.name=i.name,m.class=i.classId}}this.add(o.raidInstanceId,o.partyInstanceId,i.characterId,s,i.name)}}}clear(t){this.#e.addMapping(t.characterId,t.entityId),this.completeEntry(t.characterId,t.entityId);let n,a;if(t.characterId){let o=this.getPartyIdFromCharacterId(t.characterId);o&&(a=this.getRaidInstanceId(o),n=a?this.raidInstanceToPartyInstances.get(a)??new Set([o]):new Set([o]))}this.characterIdToPartyId=new Map([...this.characterIdToPartyId].filter(([o,i])=>n?.has(i))),this.entityIdToPartyId=new Map([...this.entityIdToPartyId].filter(([o,i])=>n?.has(i))),this.raidInstanceToPartyInstances=new Map([...this.raidInstanceToPartyInstances].filter(([o,i])=>o==a)),this.ownName=t.name,this.characterNameToCharacterId=new Map([...this.characterNameToCharacterId].filter(([o,i])=>this.characterIdToPartyId?.has(i))),this.#e.clear(Array.from(this.characterIdToPartyId.keys()))}};var $e=class{entityToCharacterId;characterToEntityId;constructor(){this.entityToCharacterId=new Map,this.characterToEntityId=new Map}addMapping(t,n){this.entityToCharacterId.set(n,t),this.characterToEntityId.set(t,n)}getCharacterId(t){return this.entityToCharacterId.get(t)}getEntityId(t){return this.characterToEntityId.get(t)}clear(t){this.entityToCharacterId=new Map([...this.entityToCharacterId].filter(([n,a])=>t.includes(a))),this.characterToEntityId=new Map([...this.characterToEntityId].filter(([n,a])=>t.includes(n)))}};var qs=class extends Oo.TypedEmitter{#e;#o;#a;#i;#n;#t;#s;#r;#_;#u;#l;constructor(t,n,a,o){super(),this.#e=t,this.#o=n,this.#a=new $e,this.#i=new Ye(this.#a),this.#n=new pe(this.#i,this.#o,o.isLive??!0),this.#t=new Le(this.#a,this.#i,this.#n,this.#o),this.#r=new Ae(this.#t,a,Mo(this.#e,o.isLive)?this.#e:void 0),this.#s=new Be(this.#t,this.#n,this.#r,this.#o,o),this.#s.emit=this.emit.bind(this),this.#u=!1,this.#l=!1,this.#s.options.isLive&&(this.#_=setInterval(this.broadcastStateChange.bind(this),this.#s.options.broadcastInterval)),this.#e.on("syncDmg",i=>{this.#s.onSyncDmg(i)}).on("APP_StatApi",i=>{let s=i.parsed;s&&this.#r.updatePlayerStats(s.players)}).on("AbilityChangeNotify",i=>{}).on("ActiveAbilityNotify",i=>{}).on("AddonSkillFeatureChangeNotify",i=>{}).on("BlockSkillStateNotify",i=>{}).on("CounterAttackNotify",i=>{let s=i.parsed;if(!s)return;let u=this.#t.entities.get(s.sourceId);u&&this.#s.onCounterAttack(u,i.time)}).on("DeathNotify",i=>{let s=i.parsed;if(!s)return;let u=this.#t.entities.get(s.targetId);u&&this.#s.onDeath(u,i.time)}).on("EquipChangeNotify",i=>{let s=i.parsed;if(!s)return;let u=this.#t.entities.get(s.objectId);!u||u.entityType!==1||(u.itemSet=this.#t.getPlayerSetOptions(s.equipItemDataList),u.items.equipList.clear(),s.equipItemDataList.forEach(m=>{m.id!==void 0&&m.slot!==void 0&&u.items.equipList.set(m.slot,m.id)}))}).on("EquipLifeToolChangeNotify",i=>{let s=i.parsed;if(!s)return;let u=this.#t.entities.get(s.objectId);!u||u.entityType!==1||(u.items.lifeToolList.clear(),s.equipLifeToolDataList.forEach(m=>{m.id!==void 0&&m.slot!==void 0&&u.items.lifeToolList.set(m.slot,m.id)}))}).on("IdentityStanceChangeNotify",i=>{let s=i.parsed;if(!s)return;let u=this.#t.entities.get(s.objectId);u&&u.entityType===1&&(u.stance=s.stance)}).on("IdentityGaugeChangeNotify",i=>{}).on("InitAbility",i=>{}).on("InitEnv",i=>{this.#t.processInitEnv(i),this.#s.onInitEnv(i,i.time),this.#r.cache.clear()}).on("InitLocal",i=>{}).on("InitPC",i=>{let s=this.#t.processInitPC(i);if(s&&i.parsed){let u=this.#o.getStatPairMap(i.parsed.statPair);this.#s.updateOrCreateEntity(s,{id:s.entityId.toString(16),name:s.name,classId:s.class,isPlayer:!0,gearScore:s.gearLevel,currentHp:Number(u.get(1))||0,maxHp:Number(u.get(27))||0},i.time)}}).on("InitItem",i=>{let s=i.parsed;s&&([1,20].includes(s.storageType)?(1===s.storageType&&(this.#t.localPlayer.itemSet=this.#t.getPlayerSetOptions(s.itemDataList)),s.itemDataList.forEach(u=>{u.id!==void 0&&u.slot!==void 0&&this.#t.localPlayer.items.equipList.set(u.slot,u.id)})):s.storageType===21&&s.itemDataList.forEach(u=>{u.id!==void 0&&u.slot!==void 0&&this.#t.localPlayer.items.lifeToolList.set(u.slot,u.id)}))}).on("MigrationExecute",i=>{this.#r.zoneSyncStatus=0;let s=i.parsed;s&&(this.#t.localPlayer.characterId===0n&&(this.#t.localPlayer.characterId=s.account_CharacterId1<s.account_CharacterId2?s.account_CharacterId1:s.account_CharacterId2),this.#r.ip=i.parsed.serverAddr.split(":")[0])}).on("NewNpc",i=>{let s=this.#t.processNewNpc(i);if(s&&i.parsed){let u=this.#o.getStatPairMap(i.parsed.npcStruct.statPair);this.#s.updateOrCreateEntity(s,{id:s.entityId.toString(16),name:s.name,npcId:s.typeId,isPlayer:!1,isBoss:s.isBoss,currentHp:Number(u.get(1))||0,maxHp:Number(u.get(27))||0},i.time)}}).on("NewNpcSummon",i=>{let s=this.#t.processNewNpcSummon(i);if(s&&i.parsed){let u=this.#o.getStatPairMap(i.parsed.npcData.statPair);this.#s.updateOrCreateEntity(s,{id:s.entityId.toString(16),name:s.name,npcId:s.typeId,isPlayer:!1,isBoss:s.isBoss,currentHp:Number(u.get(1))||0,maxHp:Number(u.get(27))||0},i.time)}}).on("NewPC",i=>{let s=this.#t.processNewPC(i);if(s&&i.parsed){let u=this.#o.getStatPairMap(i.parsed.pcStruct.statPair);this.#s.updateOrCreateEntity(s,{id:s.entityId.toString(16),name:s.name,classId:s.class,isPlayer:!0,gearScore:s.gearLevel,currentHp:Number(u.get(1))||0,maxHp:Number(u.get(27))||0},i.time)}}).on("NewProjectile",i=>{let s=i.parsed;if(!s)return;let u={entityId:s.projectileInfo.projectileId,entityType:5,name:s.projectileInfo.projectileId.toString(16),ownerId:s.projectileInfo.ownerId,skillEffectId:s.projectileInfo.skillEffect,skillId:s.projectileInfo.skillId,stats:new Map};this.#t.entities.set(u.entityId,u)}).on("NewTrap",i=>{let s=i.parsed;if(!s)return;let u={entityId:s.trapData.objectId,entityType:5,name:s.trapData.objectId.toString(16),ownerId:s.trapData.ownerId,skillEffectId:s.trapData.skillEffect,skillId:s.trapData.skillId,stats:new Map};this.#t.entities.set(u.entityId,u)}).on("ParalyzationStateNotify",i=>{}).on("PartyInfo",i=>{this.#i.partyInfo(i,this.#t.entities,this.#t.localPlayer)}).on("PartyLeaveResult",i=>{let s=i.parsed;s&&this.#i.remove(s.partyInstanceId,s.name)}).on("PartyPassiveStatusEffectAddNotify",i=>{}).on("PartyPassiveStatusEffectRemoveNotify",i=>{}).on("PartyStatusEffectAddNotify",i=>{let s=i.parsed;if(s)for(let u of s.statusEffectDatas){let m=s.playerIdOnRefresh!==0n?s.playerIdOnRefresh:u.sourceId,d=this.#t.getSourceEntity(m);this.#n.RegisterStatusEffect(this.#n.buildStatusEffect(u,s.characterId,d.entityId,0,i.time))}}).on("PartyStatusEffectRemoveNotify",i=>{let s=i.parsed;if(s)for(let u of s.statusEffectIds){let m=this.#n.RemoveStatusEffect(s.characterId,u,0,s.reason,i.time)}}).on("PartyStatusEffectResultNotify",i=>{let s=i.parsed;s&&this.#i.add(s.raidInstanceId,s.partyInstanceId,s.characterId)}).on("PassiveStatusEffectAddNotify",i=>{}).on("PassiveStatusEffectRemoveNotify",i=>{}).on("RaidBegin",i=>{let s=i.parsed;s&&(this.#o.statQueryFilter.raid.has(s.raidId)?this.#r.zoneSyncStatus|=16:this.#r.zoneSyncStatus|=8)}).on("ZoneMemberLoadStatusNotify",i=>{let s=i.parsed;s&&(this.#s.setZoneLevel(s.zoneLevel),this.#o.statQueryFilter.zone.has(s.zoneId)&&[0,1,5].includes(s.zoneLevel)?this.#r.zoneSyncStatus|=4:this.#r.zoneSyncStatus|=2)}).on("RaidBossKillNotify",i=>{this.#s.setKillState(1),this.#s.onPhaseTransition(1,i.time)}).on("RaidResult",i=>{i.parsed?.raidResult===1&&this.#s.setKillState(1),this.#s.onPhaseTransition(0,i.time)}).on("RemoveObject",i=>{let s=i.parsed;if(s)for(let u of s.unpublishedObjects)this.#n.RemoveLocalObject(u.objectId,i.time)}).on("SkillCastNotify",i=>{let s=i.parsed;if(!s)return;let u=this.#t.getSourceEntity(s.caster);u=this.#t.guessIsPlayer(u,s.skillId),this.#s.onStartSkill(u,s.skillId,i.time)}).on("SkillDamageAbnormalMoveNotify",i=>{let s=i.parsed;if(!s)return;let u=this.#t.getSourceEntity(s.sourceId);s.skillDamageAbnormalMoveEvents.forEach(m=>{let d=this.#t.getOrCreateEntity(m.skillDamageEvent.targetId),f=this.#t.getOrCreateEntity(s.sourceId);d.stats.set(1,m.skillDamageEvent.curHp),d.stats.set(27,m.skillDamageEvent.maxHp),this.#s.onDamage(u,f,d,{skillId:s.skillId,skillEffectId:s.skillEffectId,damage:Number(m.skillDamageEvent.damage),modifier:m.skillDamageEvent.modifier,targetCurHp:Number(m.skillDamageEvent.curHp),targetMaxHp:Number(m.skillDamageEvent.maxHp),damageAttr:m.skillDamageEvent.damageAttr??0,damageType:m.skillDamageEvent.damageType},s.skillDamageAbnormalMoveEvents.length,i.time)})}).on("SkillDamageNotify",i=>{let s=i.parsed;if(!s)return;let u=this.#t.getSourceEntity(s.sourceId);s.skillDamageEvents.forEach(m=>{let d=this.#t.getOrCreateEntity(m.targetId),f=this.#t.getOrCreateEntity(s.sourceId);this.#s.onDamage(u,f,d,{skillId:s.skillId,skillEffectId:s.skillEffectId??0,damage:Number(m.damage),modifier:m.modifier,targetCurHp:Number(m.curHp),targetMaxHp:Number(m.maxHp),damageAttr:m.damageAttr??0,damageType:m.damageType},s.skillDamageEvents.length,i.time)})}).on("SkillStageNotify",i=>{}).on("SkillStartNotify",i=>{let s=i.parsed;if(!s)return;let u=this.#t.getSourceEntity(s.sourceId);if(u=this.#t.guessIsPlayer(u,s.skillId),u.entityType===1){let m=u,d=m.skills.get(s.skillId);if(d||(d={effects:new Set,tripods:new Map},m.skills.set(s.skillId,d)),d.level=s.skillLevel,s.skillOptionData.tripodIndex&&s.skillOptionData.tripodLevel){d.tripods||(d.tripods=new Map);for(let[f,p]of["first","second","third"].entries()){if(s.skillOptionData.tripodIndex[p]===0){for(let A=1;A<=3;A++)d.tripods.delete(3*f+A);continue}let E=3*f+s.skillOptionData.tripodIndex[p],H=s.skillOptionData.tripodLevel[p],w=d.tripods.get(E);if(w&&H===w.level)continue;for(let A=1;A<=3;A++)d.tripods.delete(3*f+A);let W=this.#o.skillFeature.get(s.skillId)?.get(E),ee=[];W&&W.entries.forEach(A=>{A.level!==0&&A.level!==H||ee.push(A)}),d.tripods.set(E,{level:s.skillOptionData.tripodLevel[p],options:ee.sort((A,ke)=>ke.level-A.level)})}}}this.#s.onStartSkill(u,s.skillId,i.time)}).on("StatusEffectAddNotify",i=>{let s=i.parsed;if(!s)return;let u=this.#t.getSourceEntity(s.statusEffectData.sourceId);this.#n.RegisterStatusEffect(this.#n.buildStatusEffect(s.statusEffectData,s.objectId,u.entityId,1,i.time))}).on("StatusEffectDurationNotify",i=>{let s=i.parsed;s&&this.#n.UpdateDuration(s.effectInstanceId,s.targetId,s.expirationTick,1)}).on("StatusEffectRemoveNotify",i=>{let s=i.parsed;if(s)for(let u of s.statusEffectIds){let m=this.#n.RemoveStatusEffect(s.objectId,u,1,s.reason,i.time)}}).on("StatusEffectSyncDataNotify",i=>{let s=i.parsed;s&&this.#n.SyncStatusEffect(s.effectInstanceId,s.characterId,s.objectId,s.value,this.#t.localPlayer.characterId)}).on("TriggerBossBattleStatus",i=>{this.#s.onPhaseTransition(2,i.time)}).on("TriggerFinishNotify",i=>{}).on("TriggerStartNotify",i=>{let s=i.parsed;if(s)switch(s.triggerSignalType){case 57:case 59:case 61:case 63:case 74:case 76:this.#s.setKillState(1);break;case 58:case 60:case 62:case 64:case 75:case 77:this.#s.setKillState(0);break;case 27:case 10:case 11:break}}).on("TroopMemberUpdateMinNotify",i=>{}).on("ZoneObjectUnpublishNotify",i=>{let s=i.parsed;s&&this.#n.RemoveLocalObject(s.objectId,i.time)}).on("ZoneStatusEffectAddNotify",i=>{}).on("TroopMemberUpdateMinNotify",i=>{let s=i.parsed;if(s&&s.statusEffectDatas.length>0)for(let u of s.statusEffectDatas){let m=this.#a.getEntityId(s.characterId),d=u.value?u.value.readUInt32LE():0,f=u.value?u.value.readUInt32LE(8):0,p=d<f?d:f;this.#n.SyncStatusEffect(u.effectInstanceId,s.characterId,m,p,this.#t.localPlayer.characterId)}}).on("ZoneStatusEffectRemoveNotify",i=>{}),this.#n.on("shieldApplied",i=>{let s=i.targetId;if(i.type===0&&(s=this.#a.getEntityId(i.targetId)??s),s===void 0)return;let u=this.#t.getSourceEntity(i.sourceId),m=this.#t.getOrCreateEntity(s);this.#s.onShieldApplied(m,u,i.statusEffectId,i.value)}).on("shieldChanged",(i,s,u)=>{let m=i.targetId;if(i.type===0&&(m=this.#a.getEntityId(i.targetId)??m),m===void 0)return;let d=this.#t.getSourceEntity(i.sourceId),f=this.#t.getOrCreateEntity(m);this.#s.onShieldUsed(f,d,i.statusEffectId,s-u)})}broadcastStateChange(){this.emit("state-change",this.#s.getBroadcast())}reset(){this.#s.resetState(+new Date)}cancelReset(){this.#s.cancelReset()}updateOptions(t){this.#_&&t.broadcastInterval&&t.broadcastInterval!==this.#s.options.broadcastInterval&&(clearInterval(this.#_),this.#_=setInterval(this.broadcastStateChange.bind(this),this.#s.options.broadcastInterval)),this.#s.updateOptions(t)}onConnect(t){this.#r.ip||(this.#r.ip=t.split(":")[0],Mo(this.#e,this.#s.options.isLive)&&this.#e.appendLog(new ce({account_CharacterId1:0n,serverAddr:t,account_CharacterId2:0n},11,Ee)))}get encounters(){return this.#s.splitEncounter(new Date),this.#s.encounters}};function Mo(e,t){return e instanceof Ke||e.appendLog&&t}0&&(module.exports={Parser});
